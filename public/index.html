<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TierAlba — Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Cormorant+Garamond:wght@500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #050505;
            --surface: #0a0a0b;
            --surface-2: #111113;
            --surface-3: #1a1b22;
            --border: rgba(255,255,255,0.04);
            --border-hover: rgba(255,255,255,0.09);
            --gold: #d4b978;
            --gold-light: #f0dfa8;
            --gold-dim: rgba(212,185,120,0.08);
            --gold-glow: rgba(212,185,120,0.04);
            --text: #f4f1ea;
            --text-2: #a09b91;
            --text-3: #5c5952;
            --green: #4ade80;
            --green-dim: rgba(74,222,128,0.08);
            --red: #f87171;
            --red-dim: rgba(248,113,113,0.08);
            --radius: 12px;
            --radius-lg: 16px;
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            position: relative;
            overflow-x: hidden;
        }

        html { overflow-x: hidden; }

        body::before {
            content: '';
            position: fixed;
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(212,185,120,0.04) 0%, transparent 70%);
            top: -100px; right: -100px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: ambientFloat 30s ease-in-out infinite;
        }

        @keyframes ambientFloat {
            0%,100% { transform: translate(0,0); }
            50% { transform: translate(-30px, 40px); }
        }

        body::after {
            content: '';
            position: fixed;
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(74,222,128,0.02) 0%, transparent 70%);
            bottom: -100px; left: -50px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: ambientFloat 25s ease-in-out infinite reverse;
        }

        /* Page load animation */
        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section.active .stat-card { animation: fadeSlideUp 0.4s ease forwards; }
        .section.active .stat-card:nth-child(1) { animation-delay: 0s; }
        .section.active .stat-card:nth-child(2) { animation-delay: 0.06s; }
        .section.active .stat-card:nth-child(3) { animation-delay: 0.12s; }
        .section.active .stat-card:nth-child(4) { animation-delay: 0.18s; }
        .section.active .stats-row-mini { animation: fadeSlideUp 0.4s ease 0.2s forwards; }
        .section.active .card { animation: fadeSlideUp 0.4s ease 0.25s forwards; }

        /* Better focus states */
        *:focus-visible { outline: 2px solid rgba(212,185,120,0.4); outline-offset: 2px; border-radius: 4px; }

        /* Selection color */
        ::selection { background: rgba(212,185,120,0.2); color: var(--text); }

        /* ── Sidebar ── */
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 260px;
            height: 100vh;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 1.75rem 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            backdrop-filter: blur(20px);
        }

        .sidebar::after {
            content: '';
            position: absolute;
            top: 0; right: -1px;
            width: 1px; height: 100%;
            background: linear-gradient(180deg, transparent 5%, rgba(212,185,120,0.15) 50%, transparent 95%);
            pointer-events: none;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 1.5rem 1.75rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 0.5rem;
            flex-shrink: 0;
        }

        .logo-mark {
            width: 40px; height: 40px;
            background: linear-gradient(145deg, var(--gold), #c5a855, var(--gold-light));
            border-radius: 11px;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Cormorant Garamond', serif;
            font-weight: 700; font-size: 20px; color: var(--bg);
            box-shadow: 0 4px 16px rgba(212,185,120,0.25), 0 0 0 1px rgba(212,185,120,0.1);
        }

        .logo-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 22px; font-weight: 700;
            letter-spacing: -0.3px;
            color: var(--text);
        }

        .nav-menu { list-style: none; padding: 0.5rem 0.75rem; flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; }

        /* Scrollbar */
        .nav-menu::-webkit-scrollbar { width: 3px; }
        .nav-menu::-webkit-scrollbar-track { background: transparent; }
        .nav-menu::-webkit-scrollbar-thumb { background: rgba(212,185,120,0.15); border-radius: 3px; }
        .nav-menu::-webkit-scrollbar-thumb:hover { background: rgba(212,185,120,0.3); }
        .nav-menu { scrollbar-width: thin; scrollbar-color: rgba(212,185,120,0.15) transparent; }

        .nav-section-label {
            font-size: 9px; font-weight: 700; color: var(--text-3);
            text-transform: uppercase; letter-spacing: 1.5px;
            padding: 16px 14px 6px;
        }

        .nav-item { margin-bottom: 1px; }

        .nav-link {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 14px;
            color: var(--text-2);
            text-decoration: none;
            font-size: 13.5px; font-weight: 500;
            border-radius: 10px;
            transition: all var(--transition);
            cursor: pointer;
            position: relative;
        }

        .nav-link:hover { color: var(--text); background: rgba(255,255,255,0.03); }

        .nav-link.active {
            color: var(--gold);
            background: linear-gradient(135deg, rgba(212,185,120,0.1), rgba(212,185,120,0.04));
            box-shadow: inset 0 0 0 1px rgba(212,185,120,0.08);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0; top: 50%; transform: translateY(-50%);
            width: 3px; height: 20px;
            background: var(--gold);
            border-radius: 0 3px 3px 0;
        }

        .nav-link.nav-locked { opacity: 0.4; }
        .nav-link.nav-locked:hover { opacity: 0.6; }
        .lock-icon { margin-left: auto; opacity: 0.5; display: flex; }

        .nav-icon {
            width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.7;
        }

        .nav-link.active .nav-icon { opacity: 1; }

        .nav-icon svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 1.8; }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .user-card {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--transition);
            border: 1px solid transparent;
        }

        .user-card:hover { background: rgba(255,255,255,0.03); border-color: var(--border); }

        .user-avatar {
            width: 36px; height: 36px;
            background: linear-gradient(145deg, var(--gold), #c5a855, var(--gold-light));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700; color: var(--bg);
            box-shadow: 0 2px 12px rgba(212,185,120,0.2);
        }

        .user-name { font-size: 13px; font-weight: 600; }
        .user-email { font-size: 11px; color: var(--text-3); }

        /* ── Main Layout ── */
        .main {
            margin-left: 260px;
            min-height: 100vh;
            padding: 2rem 2.5rem;
            transition: margin-left 0.3s;
            overflow-x: hidden;
            max-width: 100vw;
        }

        /* ── Topbar ── */
        .topbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem;
        }

        .topbar-left { display: flex; align-items: center; gap: 1rem; }

        .menu-toggle {
            display: none;
            width: 38px; height: 38px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            align-items: center; justify-content: center;
            cursor: pointer; color: var(--text); font-size: 18px;
        }

        .page-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px; font-weight: 600;
            letter-spacing: -0.5px;
            color: var(--text);
        }

        .topbar-right { display: flex; align-items: center; gap: 0.75rem; }

        .btn-icon {
            width: 38px; height: 38px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-2);
            transition: all var(--transition);
            position: relative;
        }

        .btn-icon:hover { border-color: var(--border-hover); color: var(--text); }
        .btn-icon svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 1.8; }

        .btn-logout {
            padding: 8px 16px;
            background: none;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-2);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn-logout:hover { border-color: var(--red); color: var(--red); }

        /* ── Cards ── */
        .card {
            background: linear-gradient(145deg, var(--surface), rgba(12,13,18,0.8));
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            transition: all var(--transition);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 20%; right: 20%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212,185,120,0.12), transparent);
        }

        .card:hover { border-color: rgba(255,255,255,0.06); }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.25rem;
        }

        .card-title {
            font-size: 13px; font-weight: 700;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        /* ── Stats Grid ── */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(145deg, var(--surface), var(--surface-2));
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.25rem 1.5rem;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%; right: -50%;
            width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(212,185,120,0.03) 0%, transparent 70%);
            pointer-events: none;
            transition: all 0.5s ease;
        }

        .stat-icon {
            width: 42px; height: 42px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 14px;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212,185,120,0.2), transparent);
            opacity: 0;
            transition: opacity var(--transition);
        }

        .stat-card:hover {
            border-color: rgba(212,185,120,0.15);
            box-shadow: 0 8px 32px rgba(212,185,120,0.06), 0 0 0 1px rgba(212,185,120,0.05);
            transform: translateY(-3px);
        }

        .stat-card:hover::before { opacity: 1; }
        .stat-card:hover::after { top: -30%; right: -30%; }

        .stat-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'DM Mono', monospace;
            font-size: 28px;
            font-weight: 500;
            letter-spacing: -0.5px;
            margin-bottom: 6px;
            color: var(--text);
            white-space: nowrap;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-3);
            min-height: 18px;
        }

        .stat-change.positive { color: var(--green); }
        .stat-change.negative { color: var(--red); }

        .stats-row-mini {
            display: flex; gap: 0; margin-bottom: 1rem;
            background: linear-gradient(145deg, var(--surface), var(--surface-2));
            border: 1px solid var(--border); border-radius: var(--radius-lg);
            overflow: hidden;
        }
        .stat-mini {
            flex: 1; padding: 14px 16px; display: flex; align-items: center; gap: 8px;
            border-right: 1px solid var(--border);
            transition: background 0.2s ease;
        }
        .stat-mini:hover { background: rgba(255,255,255,0.015); }
        .stat-mini:last-child { border-right: none; }
        .stat-mini-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .stat-mini-dot.green { background: var(--green); box-shadow: 0 0 8px rgba(74,222,128,0.3); }
        .stat-mini-dot.gold { background: var(--gold); box-shadow: 0 0 8px rgba(212,185,120,0.3); }
        .stat-mini-label { font-size: 11px; color: var(--text-3); white-space: nowrap; font-weight: 500; }
        .stat-mini-val { font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500; color: var(--text); margin-left: auto; }

        .chart-range-btns { display: flex; gap: 3px; background: var(--surface-2); border-radius: 8px; padding: 3px; }
        .chart-range-btn {
            padding: 5px 14px; font-size: 11px; font-weight: 700; font-family: 'DM Sans', sans-serif;
            background: transparent; border: none; border-radius: 6px;
            color: var(--text-3); cursor: pointer; transition: all 0.2s;
            letter-spacing: 0.3px;
        }
        .chart-range-btn:hover { color: var(--text); }
        .chart-range-btn.active { background: var(--surface-3); color: var(--gold); box-shadow: 0 1px 4px rgba(0,0,0,0.2); }

        /* ── Journal ── */
        .journal-tags-select { display: flex; flex-wrap: wrap; gap: 6px; }
        .journal-tag-option {
            display: flex; align-items: center; gap: 4px; padding: 5px 12px;
            background: var(--surface-2); border: 1px solid var(--border); border-radius: 8px;
            font-size: 11px; color: var(--text-2); cursor: pointer; transition: all 0.2s; font-weight: 500;
        }
        .journal-tag-option:has(input:checked) { background: var(--gold-dim); border-color: rgba(212,185,120,0.25); color: var(--gold); }
        .journal-tag-option input { display: none; }
        .journal-upload {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            padding: 1.5rem; border: 2px dashed var(--border); border-radius: var(--radius);
            cursor: pointer; transition: all 0.2s;
        }
        .journal-upload:hover { border-color: rgba(212,185,120,0.25); background: rgba(212,185,120,0.02); }
        .mood-btn {
            flex: 1; padding: 8px 6px; font-size: 11px; font-family: 'DM Sans', sans-serif;
            background: var(--surface-2); border: 1px solid var(--border); border-radius: 8px;
            color: var(--text-2); cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .mood-btn:hover { border-color: rgba(255,255,255,0.08); }
        .mood-btn.selected { background: var(--gold-dim); border-color: rgba(212,185,120,0.25); color: var(--gold); }
        .journal-card {
            background: linear-gradient(145deg, var(--surface), var(--surface-2));
            border: 1px solid var(--border); border-radius: var(--radius-lg);
            padding: 1.25rem; transition: all 0.25s ease;
        }
        .journal-card:hover { border-color: rgba(255,255,255,0.06); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .journal-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .journal-card-symbol { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .journal-card-meta { font-size: 11px; color: var(--text-3); font-weight: 500; }
        .journal-card-tags { display: flex; gap: 4px; margin-bottom: 10px; flex-wrap: wrap; }
        .journal-tag {
            padding: 3px 10px; font-size: 10px; font-weight: 700; border-radius: 6px;
            background: var(--surface-3); color: var(--text-2); text-transform: uppercase; letter-spacing: 0.5px;
        }
        .journal-card-notes { font-size: 13px; color: var(--text-2); line-height: 1.7; margin-bottom: 8px; padding: 10px 14px; background: rgba(255,255,255,0.015); border-radius: 10px; }
        .journal-card-img { width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid var(--border); cursor: pointer; transition: opacity 0.2s; }
        .journal-card-img:hover { opacity: 0.85; }
        .journal-card-actions { display: flex; gap: 8px; margin-top: 12px; }
        .journal-card-actions button {
            padding: 6px 14px; font-size: 11px; font-family: 'DM Sans', sans-serif;
            background: var(--surface-3); border: 1px solid var(--border); border-radius: 8px;
            color: var(--text-3); cursor: pointer; transition: all 0.2s; font-weight: 600;
        }
        .journal-card-actions button:hover { color: var(--text); border-color: rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); }

        /* ── Trade List ── */
        .trade-tabs { display: flex; gap: 4px; background: var(--surface-2); border-radius: 8px; padding: 3px; }
        .trade-tab {
            padding: 6px 16px; font-size: 11px; font-weight: 600; font-family: 'DM Sans', sans-serif;
            background: transparent; border: none; border-radius: 6px;
            color: var(--text-3); cursor: pointer; transition: all 0.2s;
        }
        .trade-tab:hover { color: var(--text); }
        .trade-tab.active { background: var(--surface-3); color: var(--gold); box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
        .trade-tab-content { display: none; }
        .trade-tab-content.active { display: block; }
        .trade-list { max-height: 420px; overflow-y: auto; }
        .trade-list::-webkit-scrollbar { width: 4px; }
        .trade-list::-webkit-scrollbar-track { background: transparent; }
        .trade-list::-webkit-scrollbar-thumb { background: var(--surface-3); border-radius: 4px; }
        .trade-row {
            display: grid; grid-template-columns: 1fr auto auto auto auto;
            align-items: center; gap: 12px; padding: 12px 4px;
            border-bottom: 1px solid var(--border); font-size: 13px;
            transition: background 0.15s ease;
        }
        .trade-row:hover { background: rgba(255,255,255,0.015); border-radius: 8px; }
        .trade-row:last-child { border-bottom: none; }
        .trade-row-symbol { font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 8px; }
        .trade-row-dir {
            font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .trade-row-dir.buy { background: var(--green-dim); color: var(--green); }
        .trade-row-dir.sell { background: var(--red-dim); color: var(--red); }
        .trade-row-lots { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-2); }
        .trade-row-price { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-2); text-align: right; }
        .trade-row-pnl { font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 600; text-align: right; min-width: 70px; }
        .trade-row-pnl.positive { color: var(--green); }
        .trade-row-pnl.negative { color: var(--red); }
        .trade-row-time { font-size: 11px; color: var(--text-3); text-align: right; min-width: 65px; }
        .trade-list-header {
            display: grid; grid-template-columns: 1fr auto auto auto auto;
            gap: 12px; padding: 10px 4px; border-bottom: 1px solid var(--border);
            font-size: 10px; font-weight: 700; color: var(--text-3);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .trade-empty {
            text-align: center; padding: 3rem 1rem; color: var(--text-3); font-size: 13px;
        }
        .trade-empty svg { margin-bottom: 8px; opacity: 0.3; }

        @media (max-width: 640px) {
            .trade-row { grid-template-columns: 1fr auto auto; gap: 8px; padding: 10px 0; }
            .trade-row-lots, .trade-list-header span:nth-child(3) { display: none; }
            .trade-row-price, .trade-list-header span:nth-child(4) { display: none; }
            .trade-list-header { grid-template-columns: 1fr auto auto; }
        }

        /* ── Chart Container ── */
        .chart-wrap {
            height: 300px;
            position: relative;
        }

        /* ── Grids ── */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        /* ── Content Sections ── */
        .section { display: none; }
        .section.active {
            display: block;
            animation: fadeIn 0.35s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ── Performance Items ── */
        .perf-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .perf-item {
            background: linear-gradient(145deg, var(--surface-2), var(--surface));
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        .perf-item:hover { border-color: rgba(255,255,255,0.06); transform: translateY(-1px); }

        .perf-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 6px;
        }

        .perf-value {
            font-family: 'DM Mono', monospace;
            font-size: 18px;
            font-weight: 500;
        }

        .perf-value.green { color: var(--green); }
        .perf-value.red { color: var(--red); }
        .perf-value.gold { color: var(--gold); }

        /* ── Broker Cards ── */
        .broker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
        }

        .broker-card {
            background: linear-gradient(145deg, var(--surface-2), var(--surface));
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .broker-card:hover {
            border-color: rgba(212,185,120,0.2);
            transform: translateY(-3px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .broker-card.connected { border-color: rgba(74,222,128,0.2); }

        .broker-icon {
            width: 44px; height: 44px;
            background: var(--surface-3);
            border-radius: 12px;
            display: inline-flex; align-items: center; justify-content: center;
            margin-bottom: 12px;
            color: var(--gold);
        }

        .broker-icon svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 1.8; }

        .broker-name {
            font-size: 14px; font-weight: 600;
            margin-bottom: 4px;
        }

        .broker-status {
            font-size: 11px; font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-3);
        }

        .broker-card.connected .broker-status { color: var(--green); }

        /* ── Calculator ── */
        .calc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group { margin-bottom: 1rem; }

        .form-label {
            display: block;
            font-size: 10px; font-weight: 700;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 11px 14px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: rgba(212,185,120,0.4);
            box-shadow: 0 0 0 3px rgba(212,185,120,0.06);
            background: var(--surface-3);
        }

        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--gold) 0%, #c5a855 50%, var(--gold-light) 100%);
            background-size: 200% 200%;
            border: none;
            border-radius: var(--radius);
            color: var(--bg);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .btn-primary:hover::before { transform: translateX(100%); }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(212,185,120,0.25);
            background-position: 100% 0;
        }

        .calc-result {
            background: var(--gold-dim);
            border: 1px solid rgba(200,170,110,0.2);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            margin-top: 1.25rem;
            display: none;
        }

        .calc-result.show { display: block; animation: fadeIn 0.3s ease; }

        .calc-result-label {
            font-size: 11px; font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .calc-result-value {
            font-family: 'DM Mono', monospace;
            font-size: 32px; font-weight: 500;
            color: var(--gold-light);
        }

        /* ── Referral ── */
        .referral-hero {
            background: var(--gold-dim);
            border: 1px solid rgba(200,170,110,0.15);
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            text-align: center;
        }

        .referral-hero h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px; margin-bottom: 0.75rem;
        }

        .referral-code {
            display: inline-block;
            padding: 12px 28px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: 'DM Mono', monospace;
            font-size: 20px; font-weight: 500;
            color: var(--gold);
            margin: 1.25rem 0;
            letter-spacing: 2px;
        }

        /* ── Modal ── */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center; justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 420px;
            max-width: 90vw;
        }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
        }

        .modal-close {
            width: 32px; height: 32px;
            background: var(--surface-2);
            border: none; border-radius: 6px;
            color: var(--text-2); font-size: 18px;
            cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            transition: all var(--transition);
        }

        .modal-close:hover { background: var(--surface-3); color: var(--text); }

        /* ── Toast ── */
        .toast-container {
            position: fixed; top: 1.5rem; right: 1.5rem;
            z-index: 300; display: flex;
            flex-direction: column; gap: 0.5rem;
        }

        .toast {
            background: rgba(14,15,20,0.95);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 18px;
            display: flex; gap: 10px;
            align-items: flex-start;
            min-width: 300px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.03);
            backdrop-filter: blur(12px);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.success { border-left: 3px solid var(--green); }
        .toast.error { border-left: 3px solid var(--red); }
        .toast.info { border-left: 3px solid var(--gold); }

        .toast-title { font-size: 13px; font-weight: 600; }
        .toast-msg { font-size: 12px; color: var(--text-2); }
        .toast-close {
            margin-left: auto; cursor: pointer;
            color: var(--text-3); font-size: 16px;
            line-height: 1;
        }
        .toast-close:hover { color: var(--text); }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ── Loading State ── */
        .skeleton {
            background: linear-gradient(90deg, var(--surface-2) 25%, rgba(212,185,120,0.04) 50%, var(--surface-2) 75%);
            background-size: 300% 100%;
            animation: shimmer 2s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 300% 0; }
            100% { background-position: -300% 0; }
        }

        /* ── Progress Bar (Challenge) ── */
        .progress-bar-bg {
            width: 100%;
            height: 10px;
            background: var(--surface-2);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        /* ── Drawdown Bars ── */
        .dd-bar-bg {
            width: 100%;
            height: 12px;
            background: var(--surface-2);
            border-radius: 12px;
            overflow: hidden;
        }

        .dd-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.6s ease, background 0.3s;
        }

        .dd-bar-fill.dd-safe { background: linear-gradient(90deg, #3a8a5c, var(--green)); }
        .dd-bar-fill.dd-warning { background: linear-gradient(90deg, #c89a2e, #e8b830); }
        .dd-bar-fill.dd-danger { background: linear-gradient(90deg, #c84040, var(--red)); }

        .dd-status-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--green-dim);
            color: var(--green);
        }

        .dd-status-badge.warning { background: rgba(232,184,48,0.12); color: #e8b830; }
        .dd-status-badge.danger { background: var(--red-dim); color: var(--red); }

        /* ── Equity Protector ── */
        .equity-protector {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
        }

        /* ── Toggle Switch ── */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input { opacity: 0; width: 0; height: 0; }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--surface-3);
            border-radius: 26px;
            transition: background 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px; height: 20px;
            left: 3px; bottom: 3px;
            background: var(--text-2);
            border-radius: 50%;
            transition: transform 0.3s, background 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider { background: var(--gold-dim); }
        .toggle-switch input:checked + .toggle-slider::before { transform: translateX(22px); background: var(--gold); }

        /* ── Bot Status ── */
        .bot-status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            padding: 5px 14px;
            border-radius: 20px;
            background: var(--surface-2);
            color: var(--text-2);
        }

        .bot-pulse {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--text-3);
        }

        .bot-pulse.online {
            background: var(--green);
            box-shadow: 0 0 0 3px rgba(92,184,122,0.2);
            animation: pulse 2s infinite;
        }

        .bot-pulse.offline {
            background: var(--red);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 3px rgba(92,184,122,0.2); }
            50% { box-shadow: 0 0 0 6px rgba(92,184,122,0.1); }
        }

        /* ── Panic Button ── */
        .panic-btn {
            padding: 16px 40px;
            background: linear-gradient(135deg, #c83030, #e05252);
            border: 2px solid rgba(224,82,82,0.3);
            border-radius: var(--radius);
            color: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .panic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(224,82,82,0.35);
        }

        .panic-btn:active { transform: translateY(0); }

        /* ── EA Download Cards ── */
        .ea-grid { display: flex; flex-direction: column; gap: 0.75rem; }
        .ea-card {
            display: flex; align-items: center; gap: 1rem;
            background: var(--surface-2); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem 1.25rem;
            transition: border-color var(--transition);
        }
        .ea-card:hover { border-color: var(--gold); }
        .ea-icon { color: var(--gold); flex-shrink: 0; }
        .ea-name { font-size: 14px; font-weight: 600; }
        .ea-meta { font-size: 12px; color: var(--text-3); margin-top: 2px; }
        .btn-small {
            padding: 7px 16px;
            background: var(--surface-3); border: 1px solid var(--border);
            border-radius: var(--radius); color: var(--text);
            font-family: 'DM Sans', sans-serif; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.8px; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-small:hover { background: var(--surface-2); border-color: rgba(212,185,120,0.3); color: var(--gold); }
        .btn-small.gold {
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: var(--bg); border: none; font-weight: 700; letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(212,185,120,0.25);
        }
        .btn-small.gold:hover { box-shadow: 0 6px 20px rgba(212,185,120,0.4); transform: translateY(-1px); }

        .btn-download {
            margin-left: auto;
            padding: 8px 18px;
            background: var(--gold-dim); border: 1px solid rgba(200,170,110,0.2);
            border-radius: var(--radius); color: var(--gold);
            font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-download:hover { background: var(--gold); color: var(--bg); }

        /* ── Setup Steps ── */
        .setup-steps { display: flex; flex-direction: column; gap: 0; }
        .setup-step {
            display: flex; align-items: flex-start; gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }
        .setup-step:last-child { border-bottom: none; }
        .step-num {
            width: 30px; height: 30px; flex-shrink: 0;
            background: var(--gold-dim); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700; color: var(--gold);
        }
        .step-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .step-desc { font-size: 13px; color: var(--text-2); line-height: 1.5; }

        /* ── Theme Toggle ── */
        .theme-toggle-btn {
            width: 38px; height: 38px;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-2); transition: all var(--transition);
        }
        .theme-toggle-btn:hover { border-color: var(--border-hover); color: var(--text); }
        .theme-toggle-btn svg { width: 18px; height: 18px; }

        /* ── Signal Cards ── */
        .signal-card {
            background: linear-gradient(145deg, var(--surface-2), var(--surface));
            border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 0.75rem;
            transition: all 0.25s ease; overflow: hidden; position: relative;
        }
        .signal-card:hover { border-color: rgba(255,255,255,0.06); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
        .signal-card.buy { border-left: 3px solid var(--green); }
        .signal-card.sell { border-left: 3px solid var(--red); }
        .signal-card.closed { opacity: 0.5; }
        .signal-card.closed:hover { opacity: 0.7; }
        .signal-header {
            display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;
        }
        .signal-dir {
            padding: 4px 12px; border-radius: 6px; font-size: 11px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        }
        .signal-dir.buy { background: var(--green-dim); color: var(--green); }
        .signal-dir.sell { background: var(--red-dim); color: var(--red); }
        .signal-symbol { font-size: 16px; font-weight: 700; }
        .signal-source {
            font-size: 10px; padding: 3px 10px; border-radius: 6px;
            background: var(--gold-dim); color: var(--gold); font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.8px;
        }
        .signal-source.ea { background: rgba(74,222,128,0.08); color: var(--green); }
        .signal-time { font-size: 11px; color: var(--text-3); margin-left: auto; font-weight: 500; }
        .signal-prices {
            display: flex; gap: 1px; margin-bottom: 8px;
            overflow: hidden; border-radius: 8px;
        }
        .signal-price {
            flex: 1; text-align: center; padding: 10px 4px;
            background: var(--surface-3);
            min-width: 0; position: relative; cursor: pointer;
            transition: background var(--transition);
        }
        .signal-price:hover { background: rgba(255,255,255,0.04); }
        .signal-price .copy-hint {
            display: none; position: absolute; top: 2px; right: 4px;
            font-size: 9px; color: var(--gold); font-weight: 700;
        }
        .signal-price:hover .copy-hint { display: block; }
        .signal-price.copied { background: rgba(212,185,120,0.12); }
        .signal-price:first-child { border-radius: 8px 0 0 8px; }
        .signal-price:last-child { border-radius: 0 8px 8px 0; }
        .signal-price-label {
            font-size: 9px; color: var(--text-3); text-transform: uppercase;
            letter-spacing: 0.8px; margin-bottom: 3px; font-weight: 600;
        }
        .signal-price-val {
            font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .signal-price-val.entry { color: var(--gold); }
        .signal-price-val.sl { color: var(--red); }
        .signal-price-val.tp { color: var(--green); }
        .signal-notes { font-size: 12px; color: var(--text-2); margin-top: 10px; font-style: italic; padding: 8px 12px; background: rgba(255,255,255,0.015); border-radius: 8px; }
        .signal-result {
            display: inline-block; padding: 3px 12px; border-radius: 6px;
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .signal-result.win { background: var(--green-dim); color: var(--green); }
        .signal-result.loss { background: var(--red-dim); color: var(--red); }
        .signal-result.be { background: var(--gold-dim); color: var(--gold); }

        @media (max-width: 640px) {
            .signal-time { margin-left: 0; width: 100%; margin-top: 4px; }
        }

        /* ── Calendar ── */
        .cal-filter {
            padding: 6px 14px; font-size: 11px; font-weight: 700;
            border: 1px solid var(--border); border-radius: 8px;
            background: none; color: var(--text-3); cursor: pointer;
            transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.8px;
            font-family: 'DM Sans', sans-serif;
        }
        .cal-filter:hover { border-color: rgba(212,185,120,0.2); color: var(--gold); }
        .cal-filter.active { background: var(--gold-dim); border-color: rgba(212,185,120,0.2); color: var(--gold); }

        .cal-day-tab {
            padding: 7px 14px; font-size: 12px; font-weight: 600;
            border: 1px solid var(--border); border-radius: 10px;
            background: none; color: var(--text-2); cursor: pointer;
            transition: all 0.2s; font-family: 'DM Sans', sans-serif;
        }
        .cal-day-tab:hover { border-color: rgba(212,185,120,0.2); color: var(--gold); }
        .cal-day-tab.active { background: var(--gold-dim); border-color: rgba(212,185,120,0.2); color: var(--gold); }

        .cal-event {
            padding: 14px 0; border-bottom: 1px solid var(--border);
        }
        .cal-event:last-child { border-bottom: none; }
        .cal-event-top {
            display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
        }
        .cal-time {
            font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-3);
            min-width: 44px;
        }
        .cal-flag { font-size: 16px; }
        .cal-impact {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
        }
        .cal-impact.high { background: #e05252; box-shadow: 0 0 6px rgba(224,82,82,0.4); }
        .cal-impact.medium { background: #e8a830; box-shadow: 0 0 6px rgba(232,168,48,0.3); }
        .cal-impact.low { background: #c8aa6e; }
        .cal-title { font-size: 13px; font-weight: 600; flex: 1; }
        .cal-currency {
            font-size: 10px; color: var(--text-3); font-weight: 700;
            background: var(--surface-2); padding: 2px 8px; border-radius: 4px;
            letter-spacing: 0.5px;
        }
        .cal-values-row {
            display: flex; gap: 0; margin-left: 62px;
        }
        .cal-val {
            flex: 1; text-align: center;
            padding: 6px 4px;
            background: var(--surface-2); 
        }
        .cal-val:first-child { border-radius: 6px 0 0 6px; }
        .cal-val:last-child { border-radius: 0 6px 6px 0; }
        .cal-val-label { font-size: 9px; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .cal-val-num { font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500; }

        @media (max-width: 640px) {
            .cal-values-row { margin-left: 0; }
        }

        /* ── LIGHT MODE ── */
        body.light {
            --bg: #f7f5f0;
            --surface: #ffffff;
            --surface-2: #f0ede6;
            --surface-3: #e8e4dc;
            --border: rgba(0,0,0,0.06);
            --border-hover: rgba(0,0,0,0.12);
            --gold: #b89a50;
            --gold-light: #c8aa6e;
            --gold-dim: rgba(184,154,80,0.08);
            --gold-glow: rgba(184,154,80,0.04);
            --text: #1a1815;
            --text-2: #5c5952;
            --text-3: #9b978f;
            --green: #3a8a5c;
            --green-dim: rgba(58,138,92,0.08);
            --red: #c83030;
            --red-dim: rgba(200,48,48,0.08);
        }

        body.light .sidebar { background: #ffffff; border-right-color: rgba(0,0,0,0.08); }
        body.light .card { background: #ffffff; }
        body.light .stat-card { background: #ffffff; }
        body.light .nav-link.active { background: rgba(184,154,80,0.1); }
        body.light .perf-item { background: #f0ede6; }
        body.light .equity-protector { background: #f0ede6; }
        body.light .broker-card { background: #f0ede6; }
        body.light .form-input { background: #f0ede6; color: #1a1815; }
        body.light .modal { background: #ffffff; }
        body.light .toast { background: #ffffff; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        body.light .btn-primary { color: #ffffff; }
        body.light .panic-btn { box-shadow: 0 4px 16px rgba(200,48,48,0.2); }
        body.light .dd-status-badge { background: rgba(58,138,92,0.1); color: #3a8a5c; }
        body.light .bot-status-badge { background: #f0ede6; }
        body.light .ea-card { background: #f0ede6; }
        body.light .btn-download { background: rgba(184,154,80,0.1); }
        body.light .btn-download:hover { background: #b89a50; color: #ffffff; }
        body.light .theme-toggle-btn { background: #ffffff; }
        body.light .btn-logout { border-color: rgba(0,0,0,0.1); }
        body.light .user-card:hover { background: #f0ede6; }
        body.light .progress-bar-bg { background: #e8e4dc; }
        body.light .dd-bar-bg { background: #e8e4dc; }

        body.light .dark-only { display: none !important; }
        body.light .light-only { display: inline-block !important; }
        body:not(.light) .light-only { display: none !important; }

        /* ── Responsive ── */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main { margin-left: 0; }
            .menu-toggle { display: flex; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .perf-grid { grid-template-columns: repeat(2, 1fr); }
            .broker-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 640px) {
            .main { padding: 1rem; }
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 0.75rem; }
            .grid-2 { grid-template-columns: 1fr; }
            .grid-3 { grid-template-columns: 1fr; }
            .calc-grid { grid-template-columns: 1fr; }
            .perf-grid { grid-template-columns: 1fr 1fr; gap: 0.75rem; }
            .page-title { font-size: 20px; }
            .broker-grid { grid-template-columns: 1fr 1fr; }

            /* Fix card overflow */
            .card { padding: 1rem; overflow: hidden; }
            .stat-card { padding: 1rem 1.15rem; display: flex; flex-direction: column; }
            .stat-value { font-size: 22px; white-space: nowrap; }
            .stat-label { font-size: 11px; letter-spacing: 0.5px; }
            .stat-icon { width: 32px; height: 32px; margin-bottom: 8px; }
            .stat-icon svg { width: 16px; height: 16px; }
            .stat-change { font-size: 11px; min-height: 16px; }
            .stats-row-mini { flex-wrap: wrap; }
            .stat-mini { flex: 1 1 45%; border-bottom: 1px solid var(--border); padding: 10px 12px; }
            .stat-mini:nth-child(odd) { border-right: 1px solid var(--border); }
            .stat-mini:nth-last-child(-n+2) { border-bottom: none; }
            .chart-range-btns { gap: 2px; }
            .chart-range-btn { padding: 3px 8px; font-size: 10px; }

            /* Fix signal prices overflow */
            .signal-prices { 
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 0;
            }
            .signal-price { padding: 6px 2px; }
            .signal-price-val { font-size: 11px; word-break: break-all; }
            .signal-price-label { font-size: 8px; }
            .signal-symbol { font-size: 14px; }
            .signal-card { padding: 0.75rem; }
            .signal-header { gap: 6px; }
            .signal-time { margin-left: 0; width: 100%; margin-top: 4px; }

            /* Fix Expert Advisor perf grid (4 cols → 2 cols) */
            .perf-item { padding: 0.75rem; }
            .perf-value { font-size: 15px; }
            .perf-label { font-size: 10px; letter-spacing: 0.5px; }

            /* Fix calendar values overflow */
            .cal-values-row { margin-left: 0; }
            .cal-val-num { font-size: 11px; }
            .cal-event-top { flex-wrap: wrap; gap: 6px; }
            .cal-title { font-size: 12px; min-width: 0; }
            .cal-time { min-width: 38px; font-size: 11px; }

            /* Fix referral hero */
            .referral-hero { padding: 1.5rem 1rem; }
            .referral-hero h2 { font-size: 20px; }
            .referral-code { font-size: 16px; padding: 10px 20px; letter-spacing: 1px; }

            /* Fix modal overflow */
            .modal { padding: 1.25rem; width: 95vw; max-height: 80vh; overflow-y: auto; }
            .modal-title { font-size: 18px; }

            /* Fix EA cards */
            .ea-card { flex-wrap: wrap; gap: 0.75rem; }
            .ea-card .btn-download { margin-left: 0; width: 100%; text-align: center; }

            /* Fix topbar */
            .topbar { flex-wrap: wrap; gap: 0.75rem; }
            .topbar-right { gap: 0.5rem; }

            /* Fix toast */
            .toast-container { left: 0.75rem; right: 0.75rem; top: 0.75rem; }
            .toast { min-width: auto; }

            /* Fix drawdown bars */
            .dd-bar-bg { height: 10px; }

            /* Fix setup steps */
            .setup-step { gap: 0.75rem; }
            .step-num { width: 26px; height: 26px; font-size: 12px; }

            /* Fix upgrade modal buttons */
            .btn-primary { padding: 11px 18px; font-size: 12px; letter-spacing: 1px; }

            /* Fix equity protector */
            .equity-protector { padding: 0.75rem 1rem; }

            /* Fix filter buttons wrapping */
            .cal-filter { padding: 5px 10px; font-size: 10px; }
            .cal-day-tab { padding: 6px 10px; font-size: 11px; }

            /* Panic button mobile */
            .panic-btn { padding: 14px 28px; font-size: 13px; letter-spacing: 1.5px; }

            /* Progress bar label */
            .progress-bar-bg { height: 8px; }
        }

        @media (max-width: 380px) {
            .main { padding: 0.75rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .perf-grid { grid-template-columns: 1fr 1fr; }
            .stat-value { font-size: 20px; }
            .signal-prices { 
                grid-template-columns: repeat(3, 1fr);
            }
            .signal-price-val { font-size: 10px; }
            .page-title { font-size: 18px; }
            .card-title { font-size: 13px; }
        }
    </style>
</head>
<body>

    <div class="toast-container" id="toastContainer"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <img src="/logo.png" alt="TierAlba" style="width:36px;height:36px;border-radius:8px;object-fit:contain;">
            <div class="logo-text">TierAlba</div>
        </div>
        <nav style="flex:1;min-height:0;overflow:hidden;display:flex;flex-direction:column;">
            <ul class="nav-menu">
                <li class="nav-section-label">Main</li>
                <li class="nav-item">
                    <a class="nav-link active" data-section="overview">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="brokers">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></div>
                        <span>Broker</span>
                    </a>
                </li>
                <li class="nav-section-label">Trading</li>
                <li class="nav-item">
                    <a class="nav-link" data-section="signals">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
                        <span>Signals</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="experts">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="12" x2="6" y2="12"/><line x1="12" y1="12" x2="12" y2="12"/><line x1="18" y1="12" x2="18" y2="12"/><line x1="12" y1="2" x2="12" y2="6"/></svg></div>
                        <span>Experts</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="indicators">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg></div>
                        <span>Indicators</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="journal">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></div>
                        <span>Journal</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="riskguard">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
                        <span>Risk Guardian</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="performance">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
                        <span>Performance</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="analytics">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="calculator">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="10" y2="14"/><line x1="14" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></svg></div>
                        <span>Calculator</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="calendar">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
                        <span>Calendar</span>
                    </a>
                </li>
                <li class="nav-section-label">Account</li>
                <li class="nav-item">
                    <a class="nav-link" data-section="referral">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
                        <span>Referral</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="refund">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></div>
                        <span>Refund</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="support">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
                        <span>Support</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="settings">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
                        <span>Settings</span>
                    </a>
                </li>
                <li class="nav-section-label" id="adminNavLabel" style="display:none;">Admin</li>
                <li class="nav-item" id="adminNavItem" style="display:none;">
                    <a class="nav-link" data-section="admin">
                        <div class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
                        <span>Admin Panel</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <div class="user-card" id="userCard">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div class="user-name" id="userName">User</div>
                    <div class="user-email" id="userEmail"></div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="main" id="mainContent">
        <div class="topbar">
            <div class="topbar-left">
                <div class="menu-toggle" id="menuToggle">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                </div>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="topbar-right">
                <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme">
                    <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
                <button class="btn-logout" onclick="logout()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 4px;"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Logout
                </button>
            </div>
        </div>

        <!-- ═══════ OVERVIEW ═══════ -->
        <div id="overview" class="section active">
            <!-- Hero Stats -->
            <div class="stats-grid">
                <div class="stat-card stat-hero" style="background:linear-gradient(145deg, rgba(212,185,120,0.06), var(--surface)); border-color:rgba(212,185,120,0.1);">
                    <div class="stat-icon" style="background:rgba(212,185,120,0.12);color:var(--gold);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div class="stat-label">Total Equity</div>
                    <div class="stat-value" id="statEquity">—</div>
                    <div class="stat-change" id="statEquityChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:var(--green-dim);color:var(--green);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                    </div>
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value" id="statWinRate">—</div>
                    <div class="stat-change" id="statWinRateChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:rgba(129,140,248,0.08);color:#818cf8;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                    </div>
                    <div class="stat-label">Profit Factor</div>
                    <div class="stat-value" id="statPF">—</div>
                    <div class="stat-change" id="statPFChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:var(--green-dim);color:var(--green);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                    </div>
                    <div class="stat-label">Total Profit</div>
                    <div class="stat-value" id="statProfit">—</div>
                    <div class="stat-change" id="statProfitChange">Loading...</div>
                </div>
            </div>

            <!-- Secondary Stats Row -->
            <div class="stats-row-mini">
                <div class="stat-mini">
                    <span class="stat-mini-dot green"></span>
                    <span class="stat-mini-label">Today's P/L</span>
                    <span class="stat-mini-val" id="statTodayPL">€0</span>
                </div>
                <div class="stat-mini">
                    <span class="stat-mini-dot gold"></span>
                    <span class="stat-mini-label">Open Trades</span>
                    <span class="stat-mini-val" id="statOpenTrades">0</span>
                </div>
                <div class="stat-mini">
                    <span class="stat-mini-dot" style="background:var(--text-3);"></span>
                    <span class="stat-mini-label">Total Trades</span>
                    <span class="stat-mini-val" id="statTotalTrades">0</span>
                </div>
                <div class="stat-mini">
                    <span class="stat-mini-dot green"></span>
                    <span class="stat-mini-label">Best Trade</span>
                    <span class="stat-mini-val" id="statBestTrade">—</span>
                </div>
            </div>

            <!-- Equity Curve (Full Width) -->
            <div class="card" style="margin-bottom:1rem;overflow:hidden;">
                <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:8px;height:8px;border-radius:50%;background:var(--gold);box-shadow:0 0 10px rgba(212,185,120,0.4);"></div>
                        <span class="card-title">Equity Curve</span>
                    </div>
                    <div class="chart-range-btns">
                        <button class="chart-range-btn active" onclick="changeEquityRange(7, this)">7D</button>
                        <button class="chart-range-btn" onclick="changeEquityRange(30, this)">30D</button>
                        <button class="chart-range-btn" onclick="changeEquityRange(90, this)">90D</button>
                        <button class="chart-range-btn" onclick="changeEquityRange(365, this)">1Y</button>
                    </div>
                </div>
                <div class="chart-wrap" style="height:360px;"><canvas id="equityChart"></canvas></div>
            </div>

            <!-- Daily P/L (Full Width) -->
            <div class="card" style="margin-bottom:1rem;overflow:hidden;">
                <div class="card-header">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 10px rgba(74,222,128,0.4);"></div>
                        <span class="card-title">Daily P/L</span>
                    </div>
                </div>
                <div class="chart-wrap" style="height:220px;"><canvas id="dailyPLChart"></canvas></div>
            </div>

            <!-- Monthly + W/L Row -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="width:8px;height:8px;border-radius:50%;background:var(--gold);box-shadow:0 0 10px rgba(212,185,120,0.3);"></div>
                            <span class="card-title">Monthly Performance</span>
                        </div>
                    </div>
                    <div class="chart-wrap"><canvas id="monthlyChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="width:8px;height:8px;border-radius:50%;background:#818cf8;box-shadow:0 0 10px rgba(129,140,248,0.4);"></div>
                            <span class="card-title">Win / Loss</span>
                        </div>
                    </div>
                    <div style="display:flex;flex-direction:column;justify-content:center;height:280px;padding:0 1rem;">
                        <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;">
                            <div style="flex:1;text-align:center;padding:16px;background:rgba(74,222,128,0.04);border:1px solid rgba(74,222,128,0.08);border-radius:12px;">
                                <div style="font-size:10px;color:var(--green);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;font-weight:700;">Wins</div>
                                <div style="font-family:'DM Mono',monospace;font-size:32px;font-weight:500;color:var(--green);" id="overviewWins">0</div>
                            </div>
                            <div style="width:1px;height:40px;background:var(--border);"></div>
                            <div style="flex:1;text-align:center;padding:16px;background:rgba(248,113,113,0.04);border:1px solid rgba(248,113,113,0.08);border-radius:12px;">
                                <div style="font-size:10px;color:var(--red);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;font-weight:700;">Losses</div>
                                <div style="font-family:'DM Mono',monospace;font-size:32px;font-weight:500;color:var(--red);" id="overviewLosses">0</div>
                            </div>
                        </div>
                        <div style="height:10px;background:var(--surface-3);border-radius:5px;overflow:hidden;margin-bottom:12px;position:relative;">
                            <div id="overviewWLBar" style="height:100%;background:linear-gradient(90deg, var(--green), #22c55e);border-radius:5px;transition:width 0.6s ease;width:50%;box-shadow:0 0 12px rgba(74,222,128,0.2);"></div>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="font-size:12px;color:var(--green);font-weight:600;" id="overviewWRPct">0%</span>
                            <span style="font-size:12px;color:var(--red);font-weight:600;" id="overviewLRPct">0%</span>
                        </div>
                        <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
                            <div style="display:flex;justify-content:space-between;margin-bottom:10px;align-items:center;">
                                <span style="font-size:12px;color:var(--text-3);font-weight:500;">Avg Win</span>
                                <span style="font-size:13px;color:var(--green);font-family:'DM Mono',monospace;font-weight:500;" id="overviewAvgWin">—</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <span style="font-size:12px;color:var(--text-3);font-weight:500;">Avg Loss</span>
                                <span style="font-size:13px;color:var(--red);font-family:'DM Mono',monospace;font-weight:500;" id="overviewAvgLoss">—</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade List -->
            <div class="card">
                <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:8px;height:8px;border-radius:50%;background:var(--gold);box-shadow:0 0 10px rgba(212,185,120,0.3);"></div>
                        <span class="card-title">Trades</span>
                    </div>
                    <div class="trade-tabs">
                        <button class="trade-tab active" onclick="switchTradeTab('open', this)">Open</button>
                        <button class="trade-tab" onclick="switchTradeTab('history', this)">History</button>
                    </div>
                </div>

                <!-- Open Trades -->
                <div id="tradeTabOpen" class="trade-tab-content active">
                    <div id="openTradesList" class="trade-list">
                        <div style="text-align:center;padding:2rem;color:var(--text-3);font-size:13px;">Loading...</div>
                    </div>
                </div>

                <!-- History -->
                <div id="tradeTabHistory" class="trade-tab-content">
                    <div id="historyTradesList" class="trade-list">
                        <div style="text-align:center;padding:2rem;color:var(--text-3);font-size:13px;">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════ SIGNALS ═══════ -->
        <div id="signals" class="section">
            <!-- Signal Stats -->
            <div class="perf-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:1.25rem;">
                <div class="perf-item">
                    <div class="perf-label">Total Signals</div>
                    <div class="perf-value gold" id="sigStatTotal">0</div>
                </div>
                <div class="perf-item">
                    <div class="perf-label">Active</div>
                    <div class="perf-value" id="sigStatActive">0</div>
                </div>
                <div class="perf-item">
                    <div class="perf-label">Win Rate</div>
                    <div class="perf-value green" id="sigStatWR">0%</div>
                </div>
                <div class="perf-item">
                    <div class="perf-label">Record</div>
                    <div class="perf-value" id="sigStatRecord" style="font-size:14px;">0W — 0L</div>
                </div>
            </div>

            <!-- Signal List -->
            <div class="card">
                <div class="card-header" style="flex-wrap:wrap;gap:8px;">
                    <span class="card-title">Live Signals</span>
                    <div style="display:flex;gap:6px;">
                        <button class="cal-filter active" data-sigfilter="all" onclick="filterSignals('all')">All</button>
                        <button class="cal-filter" data-sigfilter="active" onclick="filterSignals('active')">Active</button>
                        <button class="cal-filter" data-sigfilter="closed" onclick="filterSignals('closed')">Closed</button>
                    </div>
                </div>
                <div id="signalsList" style="min-height:200px;">
                    <div style="text-align:center;padding:2rem;color:var(--text-3);">Loading signals...</div>
                </div>
            </div>
        </div>

        <!-- ═══════ RISK GUARDIAN ═══════ -->
        <div id="riskguard" class="section">
            <!-- Account Overview -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">Account Overview</span>
                    <span class="dd-status-badge" id="rgAccountBadge">NO ACCOUNT</span>
                </div>
                <div id="rgNoAccount" style="text-align:center;padding:2rem 0;color:var(--text-3);">
                    <p style="margin-bottom:1rem;">Connect a broker account to use Risk Guardian</p>
                    <button class="btn-primary" onclick="document.querySelector('[data-section=brokers]').click()">Connect Broker</button>
                </div>
                <div id="rgAccountInfo" style="display:none;">
                    <div class="perf-grid" style="grid-template-columns:repeat(4,1fr);">
                        <div class="perf-item">
                            <div class="perf-label">Balance</div>
                            <div class="perf-value gold" id="rgBalance">—</div>
                        </div>
                        <div class="perf-item">
                            <div class="perf-label">Equity</div>
                            <div class="perf-value" id="rgEquity">—</div>
                        </div>
                        <div class="perf-item">
                            <div class="perf-label">Today P&L</div>
                            <div class="perf-value" id="rgTodayPL">—</div>
                        </div>
                        <div class="perf-item">
                            <div class="perf-label">Open Trades</div>
                            <div class="perf-value" id="rgOpenTrades">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drawdown Monitor -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">Drawdown Monitor</span>
                    <span class="dd-status-badge" id="ddStatusBadge">SAFE</span>
                </div>
                <!-- Daily Drawdown -->
                <div style="margin-bottom:1.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-size:13px;font-weight:600;color:var(--text-2);">Daily Loss</span>
                        <span style="font-size:13px;font-weight:600;" id="ddDailyValue">0% / 5%</span>
                    </div>
                    <div class="dd-bar-bg">
                        <div class="dd-bar-fill dd-safe" id="ddDailyBar" style="width:0%"></div>
                    </div>
                </div>
                <!-- Max Drawdown -->
                <div style="margin-bottom:1.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-size:13px;font-weight:600;color:var(--text-2);">Max Total Drawdown</span>
                        <span style="font-size:13px;font-weight:600;" id="ddMaxValue">0% / 10%</span>
                    </div>
                    <div class="dd-bar-bg">
                        <div class="dd-bar-fill dd-safe" id="ddMaxBar" style="width:0%"></div>
                    </div>
                </div>
                <!-- Equity Protector -->
                <div class="equity-protector">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-size:14px;font-weight:600;">Equity Protector</div>
                            <div style="font-size:12px;color:var(--text-3);">Alert when you approach the daily drawdown limit</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="equityProtectorToggle" onchange="toggleEquityProtector()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="epSettings" style="display:none;margin-top:1rem;">
                        <div style="display:flex;gap:1rem;align-items:end;">
                            <div style="flex:1;">
                                <label class="form-label">Alert at daily loss (%)</label>
                                <input type="number" class="form-input" id="epLimit" value="4" step="0.5" min="1" max="10">
                            </div>
                            <button class="btn-primary" onclick="saveEquityProtector()">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Challenge Progress (optional) -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">Challenge Tracker</span>
                    <span style="font-size:12px;color:var(--gold);font-weight:600;" id="challengePhase">PHASE 1</span>
                </div>
                <div style="margin-bottom:1.25rem;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span style="font-size:13px;color:var(--text-2);">Profit Target</span>
                        <span style="font-size:13px;font-weight:600;" id="challengeTarget">$0 / $0</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="challengeProgress" style="width:0%"></div>
                    </div>
                    <div style="text-align:right;margin-top:4px;font-size:12px;color:var(--text-3);" id="challengePercent">0% completed</div>
                </div>
                <div class="perf-grid" style="grid-template-columns:repeat(3,1fr);">
                    <div class="perf-item">
                        <div class="perf-label">Total Profit</div>
                        <div class="perf-value green" id="challengeProfit">$0</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Win Rate</div>
                        <div class="perf-value gold" id="challengeWR">0%</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Status</div>
                        <div class="perf-value green" id="challengeStatus">—</div>
                    </div>
                </div>
            </div>

            <!-- Risk Settings -->
            <div class="card">
                <div class="card-header"><span class="card-title">Risk Settings</span></div>
                <p style="color:var(--text-2);font-size:13px;margin-bottom:1rem;">Set your risk limits. These are used to calculate drawdown bars and alerts.</p>
                <div class="calc-grid">
                    <div class="form-group">
                        <label class="form-label">Starting Capital ($)</label>
                        <input type="number" class="form-input" id="riskCapital" value="100000" step="1000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Profit Target (%)</label>
                        <input type="number" class="form-input" id="riskTarget" value="10" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Daily Drawdown (%)</label>
                        <input type="number" class="form-input" id="riskDailyDD" value="5" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Total Drawdown (%)</label>
                        <input type="number" class="form-input" id="riskMaxDD" value="10" step="0.5">
                    </div>
                </div>
                <div style="text-align:center;margin-top:0.5rem;">
                    <button class="btn-primary" onclick="saveRiskSettings()">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- ═══════ EXPERTS ═══════ -->
        <div id="experts" class="section">
            <!-- Bot Status -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">Expert Advisor Status</span>
                    <span class="bot-status-badge" id="botBadge">
                        <span class="bot-pulse" id="botPulse"></span>
                        <span id="botStatusText">Checking...</span>
                    </span>
                </div>
                <div class="perf-grid" style="grid-template-columns:repeat(4,1fr);">
                    <div class="perf-item">
                        <div class="perf-label">EA Status</div>
                        <div class="perf-value" id="botEAStatus" style="font-size:15px;">—</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Connection</div>
                        <div class="perf-value" id="botConnection" style="font-size:15px;">—</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Open Trades</div>
                        <div class="perf-value" id="botOpenTrades" style="font-size:15px;">0</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Last Heartbeat</div>
                        <div class="perf-value" id="botLastBeat" style="font-size:15px;">—</div>
                    </div>
                </div>
            </div>

            <!-- License Keys -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">Your License Keys</span>
                    <button class="btn-small gold" onclick="generateLicenseKeys()" id="btnGenLicense">Generate Keys</button>
                </div>
                <p style="color:var(--text-2);margin-bottom:1rem;font-size:14px;">Your unique license keys for EA activation. Copy and paste into the EA settings on MetaTrader 5.</p>
                <div id="licenseKeysContainer">
                    <div style="text-align:center;padding:2rem 0;color:var(--text-3);">Loading licenses...</div>
                </div>
            </div>

            <!-- EA Downloads -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Download Expert Advisors</span></div>
                <p style="color:var(--text-2);margin-bottom:1.5rem;font-size:14px;">Download and install our proprietary EAs on your MetaTrader 5 platform.</p>
                <div class="ea-grid">
                    <div class="ea-card">
                        <div class="ea-icon" style="color:var(--gold);"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 18 15 15"/></svg></div>
                        <div>
                            <div class="ea-name">Tier Algo Gold</div>
                            <div class="ea-meta">MetaTrader 5 · .ex5 · XAUUSD</div>
                        </div>
                        <button class="btn-download" onclick="downloadEA('Tier_Algo_Gold.ex5')">Download</button>
                    </div>
                    <div class="ea-card">
                        <div class="ea-icon" style="color:var(--gold);"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 18 15 15"/></svg></div>
                        <div>
                            <div class="ea-name">Tier Algo US100</div>
                            <div class="ea-meta">MetaTrader 5 · .ex5 · NAS100</div>
                        </div>
                        <button class="btn-download" onclick="downloadEA('Tier_Algo_us100.ex5')">Download</button>
                    </div>
                </div>
            </div>

            <!-- Setup Guide -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Setup Guide</span></div>
                <div class="setup-steps">
                    <div class="setup-step">
                        <div class="step-num">1</div>
                        <div>
                            <div class="step-title">Generate your License Keys</div>
                            <div class="step-desc">Click "Generate Keys" above. You'll get a unique key for each EA.</div>
                        </div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">2</div>
                        <div>
                            <div class="step-title">Download the EA files</div>
                            <div class="step-desc">Download Tier Algo Gold (.ex5) and/or Tier Algo US100 (.ex5) above.</div>
                        </div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">3</div>
                        <div>
                            <div class="step-title">Copy EA to MetaTrader</div>
                            <div class="step-desc">In MT5: File → Open Data Folder → MQL5 → Experts → paste the .ex5 file.</div>
                        </div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">4</div>
                        <div>
                            <div class="step-title">Allow Web Requests</div>
                            <div class="step-desc">In MT5: Tools → Options → Expert Advisors → Check "Allow WebRequest" and add your server URL.</div>
                        </div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">5</div>
                        <div>
                            <div class="step-title">Attach & Enter License Key</div>
                            <div class="step-desc">Drag the EA onto a chart. In the Inputs tab, paste your License Key. Enable AutoTrading. ✅</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panic Button -->
        </div>

        <!-- ═══════ PERFORMANCE ═══════ -->
        <div id="performance" class="section">
            <div class="card" style="margin-bottom:1rem;">
                <div class="card-header"><span class="card-title">Trade Statistics</span></div>
                <div class="perf-grid" id="perfGrid">
                    <div class="perf-item"><div class="perf-label">Total Trades</div><div class="perf-value" id="perfTotal">—</div></div>
                    <div class="perf-item"><div class="perf-label">Winners</div><div class="perf-value green" id="perfWins">—</div></div>
                    <div class="perf-item"><div class="perf-label">Losers</div><div class="perf-value red" id="perfLosses">—</div></div>
                    <div class="perf-item"><div class="perf-label">Win Rate</div><div class="perf-value gold" id="perfWR">—</div></div>
                    <div class="perf-item"><div class="perf-label">Profit Factor</div><div class="perf-value gold" id="perfPF">—</div></div>
                    <div class="perf-item"><div class="perf-label">Avg Win</div><div class="perf-value green" id="perfAvgWin">—</div></div>
                    <div class="perf-item"><div class="perf-label">Avg Loss</div><div class="perf-value red" id="perfAvgLoss">—</div></div>
                    <div class="perf-item"><div class="perf-label">Expectancy</div><div class="perf-value gold" id="perfExpect">—</div></div>
                    <div class="perf-item"><div class="perf-label">Best Trade</div><div class="perf-value green" id="perfBest">—</div></div>
                    <div class="perf-item"><div class="perf-label">Worst Trade</div><div class="perf-value red" id="perfWorst">—</div></div>
                    <div class="perf-item"><div class="perf-label">Avg Trade</div><div class="perf-value" id="perfAvg">—</div></div>
                    <div class="perf-item"><div class="perf-label">Max Drawdown</div><div class="perf-value red" id="perfMaxDD">—</div></div>
                </div>
            </div>
            <div class="grid-2" style="margin-bottom:1rem;">
                <div class="card">
                    <div class="card-header"><span class="card-title">Cumulative P/L</span></div>
                    <div class="chart-wrap"><canvas id="cumulativePLChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Drawdown</span></div>
                    <div class="chart-wrap"><canvas id="drawdownChart"></canvas></div>
                </div>
            </div>
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><span class="card-title">Win/Loss Streaks</span></div>
                    <div class="chart-wrap" style="height:200px;"><canvas id="streakChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Monthly Returns</span></div>
                    <div class="chart-wrap" style="height:200px;"><canvas id="monthlyRetChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ═══════ ANALYTICS ═══════ -->
        <div id="analytics" class="section">
            <div class="grid-2" style="margin-bottom:1rem;">
                <div class="card">
                    <div class="card-header"><span class="card-title">Win / Loss Distribution</span></div>
                    <div style="display:flex;align-items:center;justify-content:center;height:250px;">
                        <canvas id="distributionChart" style="max-width:220px;max-height:220px;"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">P/L by Day of Week</span></div>
                    <div class="chart-wrap"><canvas id="dayOfWeekChart"></canvas></div>
                </div>
            </div>
            <div class="grid-2" style="margin-bottom:1rem;">
                <div class="card">
                    <div class="card-header"><span class="card-title">Hourly Activity</span></div>
                    <div class="chart-wrap"><canvas id="hourlyChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">P/L by Symbol</span></div>
                    <div class="chart-wrap"><canvas id="symbolPLChart"></canvas></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">Trade Size vs Profit</span></div>
                <div class="chart-wrap" style="height:250px;"><canvas id="lotsPLChart"></canvas></div>
            </div>
        </div>

        <!-- ═══════ BROKERS ═══════ -->
        <div id="brokers" class="section">
            <div class="card" style="margin-bottom:1.5rem;" id="connectedBrokerCard" style="display:none;">
                <div class="card-header">
                    <span class="card-title">Connected Account</span>
                    <span class="dd-status-badge" id="brokerConnBadge">Not Connected</span>
                </div>
                <div id="connectedBrokerInfo" style="display:none;">
                    <div class="perf-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:1rem;">
                        <div class="perf-item"><div class="perf-label">Account</div><div class="perf-value" id="connAccNum" style="font-size:15px;">—</div></div>
                        <div class="perf-item"><div class="perf-label">Platform</div><div class="perf-value gold" id="connPlatform" style="font-size:15px;">—</div></div>
                        <div class="perf-item"><div class="perf-label">Broker</div><div class="perf-value" id="connBroker" style="font-size:15px;">—</div></div>
                    </div>
                    <div style="text-align:center;">
                        <button class="btn-primary" onclick="syncBrokerData()" style="margin-right:8px;">Sync Now</button>
                        <button class="btn-logout" onclick="resetBrokerData()" style="margin-right:8px;background:rgba(200,169,78,0.1);color:var(--gold);border-color:rgba(200,169,78,0.15);">Reset Data</button>
                        <button class="btn-logout" onclick="disconnectBroker()">Disconnect</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">Connect Trading Account</span></div>
                <p style="color:var(--text-2);margin-bottom:1.5rem;font-size:14px;">Connect your MT4/MT5 account using your investor password. Read-only — we never place trades.</p>
                <div class="broker-grid">
                    <div class="broker-card" data-platform="mt4" onclick="openBrokerModal('MetaTrader 4','mt4')">
                        <div class="broker-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg></div>
                        <div class="broker-name">MetaTrader 4</div>
                        <div class="broker-status">Connect</div>
                    </div>
                    <div class="broker-card" data-platform="mt5" onclick="openBrokerModal('MetaTrader 5','mt5')">
                        <div class="broker-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg></div>
                        <div class="broker-name">MetaTrader 5</div>
                        <div class="broker-status">Connect</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════ CALCULATOR ═══════ -->
        <div id="calculator" class="section">
            <div class="card">
                <div class="card-header"><span class="card-title">Position Size Calculator</span></div>
                <div class="calc-grid">
                    <div class="form-group">
                        <label class="form-label">Account Size (€)</label>
                        <input type="number" class="form-input" id="calcAccount" value="10000" step="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Risk per Trade (%)</label>
                        <input type="number" class="form-input" id="calcRisk" value="1" step="0.1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Entry Price</label>
                        <input type="number" class="form-input" id="calcEntry" value="1.0850" step="0.0001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stop Loss</label>
                        <input type="number" class="form-input" id="calcSL" value="1.0800" step="0.0001">
                    </div>
                </div>
                <div style="text-align:center;margin-top:0.5rem;">
                    <button class="btn-primary" onclick="calculatePosition()">Calculate Position Size</button>
                </div>
                <div class="calc-result" id="calcResult">
                    <div class="calc-result-label">Optimal Position Size</div>
                    <div class="calc-result-value" id="calcLots">0.00 Lots</div>
                    <div style="margin-top:1rem;">
                        <div class="perf-grid" style="grid-template-columns:repeat(3,1fr);">
                            <div class="perf-item"><div class="perf-label">Risk</div><div class="perf-value gold" id="calcRiskAmt">€0</div></div>
                            <div class="perf-item"><div class="perf-label">Pips</div><div class="perf-value" id="calcPips">0</div></div>
                            <div class="perf-item"><div class="perf-label">R:R 1:2</div><div class="perf-value green" id="calcProfit">€0</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════ INDICATORS ═══════ -->
        <div id="indicators" class="section">
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">TradingView Indicators</span>
                    <span class="dd-status-badge" id="indicatorPlanBadge">FREE</span>
                </div>
                <p style="color:var(--text-2);margin-bottom:1.5rem;font-size:14px;">Access our proprietary TradingView indicators. Standard gets 1 indicator, Pro gets all 3.</p>
                
                <div class="ea-grid" id="indicatorsList">
                    <!-- Indicator 1 - Standard + Pro -->
                    <div class="ea-card indicator-card" data-plan="standard" id="indicator1">
                        <div class="ea-icon"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
                        <div style="flex:1;">
                            <div class="ea-name">TierAlba Trend Pro</div>
                            <div class="ea-meta">Multi-timeframe trend detection · All pairs</div>
                            <div class="indicator-invite" style="margin-top:8px;display:none;" id="invite1">
                                <div class="form-label" style="margin-bottom:4px;">Your TradingView Username</div>
                                <div style="display:flex;gap:8px;">
                                    <input type="text" class="form-input" id="tvUser1" placeholder="e.g. trader123" style="flex:1;padding:8px 12px;font-size:13px;">
                                    <button class="btn-download" onclick="requestIndicatorAccess(1)">Request Access</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn-download" onclick="toggleInvite(1)" id="inviteBtn1">Get Access</button>
                    </div>

                    <!-- Indicator 2 - Pro only -->
                    <div class="ea-card indicator-card" data-plan="pro" id="indicator2">
                        <div class="ea-icon"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                        <div style="flex:1;">
                            <div class="ea-name">TierAlba Scalper AI</div>
                            <div class="ea-meta">AI-powered scalping signals · M5-M15 timeframes</div>
                            <div class="indicator-invite" style="margin-top:8px;display:none;" id="invite2">
                                <div class="form-label" style="margin-bottom:4px;">Your TradingView Username</div>
                                <div style="display:flex;gap:8px;">
                                    <input type="text" class="form-input" id="tvUser2" placeholder="e.g. trader123" style="flex:1;padding:8px 12px;font-size:13px;">
                                    <button class="btn-download" onclick="requestIndicatorAccess(2)">Request Access</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn-download" onclick="toggleInvite(2)" id="inviteBtn2">Get Access</button>
                    </div>

                    <!-- Indicator 3 - Pro only -->
                    <div class="ea-card indicator-card" data-plan="pro" id="indicator3">
                        <div class="ea-icon"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg></div>
                        <div style="flex:1;">
                            <div class="ea-name">TierAlba Smart Grid</div>
                            <div class="ea-meta">Support & resistance grid · Auto S/R levels</div>
                            <div class="indicator-invite" style="margin-top:8px;display:none;" id="invite3">
                                <div class="form-label" style="margin-bottom:4px;">Your TradingView Username</div>
                                <div style="display:flex;gap:8px;">
                                    <input type="text" class="form-input" id="tvUser3" placeholder="e.g. trader123" style="flex:1;padding:8px 12px;font-size:13px;">
                                    <button class="btn-download" onclick="requestIndicatorAccess(3)">Request Access</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn-download" onclick="toggleInvite(3)" id="inviteBtn3">Get Access</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">How It Works</span></div>
                <div class="setup-steps">
                    <div class="setup-step">
                        <div class="step-num">1</div>
                        <div><div class="step-title">Click "Get Access"</div><div class="step-desc">Enter your TradingView username for the indicator you want.</div></div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">2</div>
                        <div><div class="step-title">We Invite You</div><div class="step-desc">Our team will add your username to the indicator's access list within 24 hours.</div></div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">3</div>
                        <div><div class="step-title">Start Using</div><div class="step-desc">Open TradingView, go to Indicators → Invite-Only, and you'll find your indicators there.</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════ ECONOMIC CALENDAR ═══════ -->
        <div id="calendar" class="section">
            <div class="card">
                <div class="card-header" style="flex-wrap:wrap;gap:8px;">
                    <span class="card-title">Economic Calendar</span>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        <button class="cal-filter active" data-impact="all" onclick="filterCalendar('all')">All</button>
                        <button class="cal-filter" data-impact="high" onclick="filterCalendar('high')">High</button>
                        <button class="cal-filter" data-impact="medium" onclick="filterCalendar('medium')">Med</button>
                        <button class="cal-filter" data-impact="low" onclick="filterCalendar('low')">Low</button>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:1.25rem;">
                    <button class="cal-day-tab active" onclick="loadCalendarDay(0)">Today</button>
                    <button class="cal-day-tab" onclick="loadCalendarDay(1)">Tomorrow</button>
                    <button class="cal-day-tab" onclick="loadCalendarDay(2)" id="calDay2">—</button>
                    <button class="cal-day-tab" onclick="loadCalendarDay(3)" id="calDay3">—</button>
                    <button class="cal-day-tab" onclick="loadCalendarDay(4)" id="calDay4">—</button>
                </div>
                <div id="calendarContent" style="min-height:200px;">
                    <div style="text-align:center;padding:2rem;color:var(--text-3);">Loading...</div>
                </div>
            </div>
        </div>

        <!-- ═══════ JOURNAL ═══════ -->
        <div id="journal" class="section">
            <!-- Journal Stats -->
            <div class="stats-grid" style="margin-bottom:1rem;">
                <div class="stat-card">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value" id="jStatWR">—</div>
                    <div class="stat-change" id="jStatWRSub">0 trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Profit Factor</div>
                    <div class="stat-value" id="jStatPF">—</div>
                    <div class="stat-change" id="jStatPFSub">—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg RR</div>
                    <div class="stat-value" id="jStatRR">—</div>
                    <div class="stat-change" id="jStatRRSub">—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Discipline</div>
                    <div class="stat-value" id="jStatDisc">—</div>
                    <div class="stat-change" id="jStatDiscSub">—</div>
                </div>
            </div>

            <!-- Filters + New -->
            <div class="card" style="margin-bottom:1rem;">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <select class="form-input" id="jFilterPair" onchange="renderJournal()" style="width:auto;min-width:100px;font-size:12px;padding:6px 10px;cursor:pointer;">
                        <option value="">All Pairs</option>
                    </select>
                    <select class="form-input" id="jFilterSetup" onchange="renderJournal()" style="width:auto;min-width:100px;font-size:12px;padding:6px 10px;cursor:pointer;">
                        <option value="">All Setups</option>
                    </select>
                    <input type="date" class="form-input" id="jFilterFrom" onchange="renderJournal()" style="width:auto;font-size:12px;padding:6px 10px;">
                    <input type="date" class="form-input" id="jFilterTo" onchange="renderJournal()" style="width:auto;font-size:12px;padding:6px 10px;">
                    <div style="margin-left:auto;">
                        <button class="btn-primary" onclick="openJournalModal()" style="padding:8px 20px;font-size:12px;">+ New Entry</button>
                    </div>
                </div>
            </div>

            <!-- Journal Performance Charts -->
            <div class="grid-2" style="margin-bottom:1rem;">
                <div class="card">
                    <div class="card-header"><span class="card-title">P/L by Pair</span></div>
                    <div class="chart-wrap" style="height:220px;"><canvas id="jChartPair"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">P/L by Setup</span></div>
                    <div class="chart-wrap" style="height:220px;"><canvas id="jChartSetup"></canvas></div>
                </div>
            </div>
            <div class="grid-2" style="margin-bottom:1rem;">
                <div class="card">
                    <div class="card-header"><span class="card-title">Performance by Hour</span></div>
                    <div class="chart-wrap" style="height:200px;"><canvas id="jChartHour"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Win / Loss Distribution</span></div>
                    <div style="display:flex;align-items:center;justify-content:center;height:200px;">
                        <canvas id="jChartWL" style="max-width:180px;max-height:180px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Journal Entries -->
            <div id="journalEntries" style="display:flex;flex-direction:column;gap:10px;">
                <div class="trade-empty">Loading journal...</div>
            </div>
        </div>

        <!-- Journal Modal -->
        <div class="modal-overlay" id="journalModal">
            <div class="modal" style="max-width:500px;max-height:85vh;overflow-y:auto;padding:1.5rem;">
                <div class="modal-header" style="margin-bottom:1rem;">
                    <div class="modal-title" id="journalModalTitle">New Trade Entry</div>
                    <button class="modal-close" onclick="closeJournalModal()">&times;</button>
                </div>

                <!-- Auto-import -->
                <div class="form-group">
                    <label class="form-label">Import from Broker</label>
                    <select class="form-input" id="journalTradeId" style="cursor:pointer;font-size:12px;" onchange="autoFillFromTrade()">
                        <option value="">Manual entry</option>
                    </select>
                </div>

                <!-- Trade Data -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div class="form-group"><label class="form-label">Pair *</label>
                        <input type="text" class="form-input" id="jPair" placeholder="XAUUSD" style="font-size:12px;"></div>
                    <div class="form-group"><label class="form-label">Direction *</label>
                        <select class="form-input" id="jDir" style="font-size:12px;cursor:pointer;"><option value="">—</option><option value="BUY">BUY</option><option value="SELL">SELL</option></select></div>
                    <div class="form-group"><label class="form-label">Lot Size</label>
                        <input type="number" class="form-input" id="jLots" step="0.01" placeholder="0.10" style="font-size:12px;"></div>
                    <div class="form-group"><label class="form-label">Risk %</label>
                        <input type="number" class="form-input" id="jRisk" step="0.1" placeholder="1.0" style="font-size:12px;"></div>
                    <div class="form-group"><label class="form-label">Entry Price</label>
                        <input type="number" class="form-input" id="jEntry" step="0.00001" placeholder="0.00000" style="font-size:12px;"></div>
                    <div class="form-group"><label class="form-label">Stop Loss</label>
                        <input type="number" class="form-input" id="jSL" step="0.00001" placeholder="0.00000" style="font-size:12px;"></div>
                    <div class="form-group"><label class="form-label">Take Profit</label>
                        <input type="number" class="form-input" id="jTP" step="0.00001" placeholder="0.00000" style="font-size:12px;"></div>
                    <div class="form-group"><label class="form-label">P/L (€)</label>
                        <input type="number" class="form-input" id="jPnL" step="0.01" placeholder="0.00" style="font-size:12px;"></div>
                    <div class="form-group"><label class="form-label">RR Planned</label>
                        <input type="number" class="form-input" id="jRRPlan" step="0.1" placeholder="2.0" style="font-size:12px;"></div>
                    <div class="form-group"><label class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-input" id="jDateTime" style="font-size:12px;"></div>
                </div>

                <!-- Qualitative -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px;">
                    <div class="form-group"><label class="form-label">Setup</label>
                        <select class="form-input" id="jSetup" style="font-size:12px;cursor:pointer;">
                            <option value="">—</option><option>ICT</option><option>OB</option><option>FVG</option><option>BOS/CHoCH</option><option>Supply/Demand</option><option>Liquidity Grab</option><option>Trendline</option><option>Breakout</option><option>Reversal</option><option>News</option><option>Scalp</option><option>Swing</option><option>Other</option>
                        </select></div>
                    <div class="form-group"><label class="form-label">Timeframe</label>
                        <select class="form-input" id="jTF" style="font-size:12px;cursor:pointer;">
                            <option value="">—</option><option>M1</option><option>M5</option><option>M15</option><option>M30</option><option>H1</option><option>H4</option><option>D1</option><option>W1</option>
                        </select></div>
                </div>

                <div class="form-group" style="margin-top:4px;">
                    <label class="form-label">Emotion</label>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        <button type="button" class="mood-btn" data-mood="confident" onclick="selectMood(this)">😎 Confident</button>
                        <button type="button" class="mood-btn" data-mood="calm" onclick="selectMood(this)">😌 Calm</button>
                        <button type="button" class="mood-btn" data-mood="neutral" onclick="selectMood(this)">😐 Neutral</button>
                        <button type="button" class="mood-btn" data-mood="anxious" onclick="selectMood(this)">😰 Anxious</button>
                        <button type="button" class="mood-btn" data-mood="fomo" onclick="selectMood(this)">🤑 FOMO</button>
                        <button type="button" class="mood-btn" data-mood="revenge" onclick="selectMood(this)">😤 Revenge</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Followed Rules?</label>
                    <div style="display:flex;gap:8px;">
                        <button type="button" class="mood-btn" id="jRulesYes" onclick="selectRules(true)" style="flex:1;">✅ Yes</button>
                        <button type="button" class="mood-btn" id="jRulesNo" onclick="selectRules(false)" style="flex:1;">❌ No</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Screenshot</label>
                    <div class="journal-upload" id="journalUploadArea" onclick="document.getElementById('journalFileInput').click()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.4;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                        <span style="font-size:11px;color:var(--text-3);">Upload chart screenshot (max 2MB)</span>
                    </div>
                    <input type="file" id="journalFileInput" accept="image/*" style="display:none;" onchange="handleJournalImage(this)">
                    <div id="journalImagePreview" style="display:none;margin-top:6px;position:relative;">
                        <img id="journalPreviewImg" style="width:100%;border-radius:8px;border:1px solid var(--border);">
                        <button onclick="removeJournalImage()" style="position:absolute;top:4px;right:4px;width:22px;height:22px;border-radius:50%;background:rgba(0,0,0,0.7);color:#fff;border:none;cursor:pointer;font-size:12px;">×</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="jNotes" rows="3" placeholder="Thesis, observations, lessons learned..." style="resize:vertical;min-height:60px;font-size:12px;"></textarea>
                </div>

                <input type="hidden" id="journalEditId" value="">
                <button class="btn-primary" onclick="saveJournalEntry()" id="journalSaveBtn" style="width:100%;">Save Entry</button>
            </div>
        </div>

        <!-- ═══════ REFERRAL ═══════ -->
        <div id="referral" class="section">
            <!-- Stats -->
            <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:1.5rem;">
                <div class="stat-card">
                    <div class="stat-label">Available Balance</div>
                    <div class="stat-value" style="color:var(--green);" id="refBalance">€0.00</div>
                    <div class="stat-change" id="refBalanceNote">Min. €50 for payout</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Earned</div>
                    <div class="stat-value" style="color:var(--gold);" id="refTotalEarned">€0.00</div>
                    <div class="stat-change positive">Lifetime earnings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Referrals</div>
                    <div class="stat-value" id="refTotalReferrals">0</div>
                    <div class="stat-change">People you invited</div>
                </div>
            </div>

            <!-- Referral Link -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Your Referral Link</span></div>
                <p style="color:var(--text-2);font-size:13px;margin-bottom:1rem;">Share your link and earn <strong style="color:var(--gold);">15% commission</strong> on every purchase made by people you refer.</p>
                <div style="display:flex;gap:8px;margin-bottom:1rem;">
                    <input type="text" class="form-input" id="refLinkInput" readonly style="font-size:13px;flex:1;">
                    <button class="btn-primary" onclick="copyRefLink()" style="white-space:nowrap;">Copy Link</button>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <span style="font-size:12px;color:var(--text-3);">Your code:</span>
                    <span class="referral-code" id="refCodeDisplay" style="padding:8px 20px;font-size:16px;margin:0;">—</span>
                    <button class="btn-download" onclick="copyRefCode()">Copy Code</button>
                </div>
            </div>

            <!-- How it works -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">How It Works</span></div>
                <div class="setup-steps">
                    <div class="setup-step">
                        <div class="step-num">1</div>
                        <div><div class="step-title">Share Your Link</div><div class="step-desc">Send your referral link or code to friends, on social media, or in trading communities.</div></div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">2</div>
                        <div><div class="step-title">They Sign Up & Subscribe</div><div class="step-desc">When someone registers using your link and purchases any plan, you earn a commission.</div></div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">3</div>
                        <div><div class="step-title">Get Paid in USDT</div><div class="step-desc">Request a payout when your balance reaches €50. We send USDT to your wallet within 48 hours.</div></div>
                    </div>
                </div>
            </div>

            <!-- Wallet & Payout -->
            <div class="grid-2" style="margin-bottom:1.5rem;">
                <div class="card">
                    <div class="card-header"><span class="card-title">USDT Wallet</span></div>
                    <div class="form-group" style="margin-bottom:0.75rem;">
                        <label class="form-label">Your USDT Wallet Address (TRC20)</label>
                        <input type="text" class="form-input" id="refWallet" placeholder="e.g. TXyz...abc">
                    </div>
                    <button class="btn-primary" onclick="saveRefWallet()" style="width:100%;">Save Wallet</button>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Request Payout</span></div>
                    <div style="text-align:center;padding:0.5rem 0;">
                        <p style="font-size:13px;color:var(--text-2);margin-bottom:1rem;">Available: <strong style="color:var(--green);" id="refPayoutBalance">€0.00</strong></p>
                        <button class="btn-primary" onclick="requestRefPayout()" id="refPayoutBtn" style="width:100%;">Request Payout</button>
                        <p style="font-size:11px;color:var(--text-3);margin-top:8px;">Minimum €50 · Paid in USDT (TRC20) · 48h processing</p>
                    </div>
                </div>
            </div>

            <!-- Commission History -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Commission History</span></div>
                <div id="refCommissions" style="min-height:60px;">
                    <p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">Loading...</p>
                </div>
            </div>

            <!-- Payout History -->
            <div class="card">
                <div class="card-header"><span class="card-title">Payout History</span></div>
                <div id="refPayouts" style="min-height:60px;">
                    <p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- ═══════ REFUND ═══════ -->
        <div id="refund" class="section">
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Request a Refund</span></div>
                <p style="color:var(--text-2);margin-bottom:1.5rem;font-size:14px;">Submit a refund request within 7 days of your purchase. Our team will review it within 48 hours.</p>
                
                <div id="refundForm">
                    <div class="form-group">
                        <label class="form-label">Reason for Refund</label>
                        <select class="form-input" id="refundReason" style="font-family:'DM Sans',sans-serif;">
                            <option value="">Select a reason...</option>
                            <option value="not_as_expected">Product not as expected</option>
                            <option value="technical_issues">Technical issues</option>
                            <option value="no_longer_needed">No longer needed</option>
                            <option value="duplicate_charge">Duplicate charge</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Additional Details (optional)</label>
                        <textarea class="form-input" id="refundDetails" rows="4" placeholder="Please describe your issue..." style="font-family:'DM Sans',sans-serif;resize:vertical;"></textarea>
                    </div>
                    <button class="btn-primary" onclick="submitRefund()" id="refundBtn">Submit Refund Request</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">Your Refund History</span></div>
                <div id="refundHistory" style="min-height:60px;">
                    <p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- ═══════ SETTINGS ═══════ -->
        <div id="settings" class="section">
            <!-- Profile -->
            <div class="card">
                <div class="card-header"><span class="card-title">Profile</span></div>
                <div class="perf-grid" style="margin-bottom:1.25rem;">
                    <div class="perf-item"><div class="perf-label">Plan</div><div class="perf-value gold" id="settingsPlan">Free</div></div>
                    <div class="perf-item"><div class="perf-label">Email</div><div class="perf-value" id="settingsEmail" style="font-size:14px;">—</div></div>
                    <div class="perf-item"><div class="perf-label">Member since</div><div class="perf-value" id="settingsDate" style="font-size:14px;">—</div></div>
                    <div class="perf-item"><div class="perf-label">Status</div><div class="perf-value green">Active</div></div>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <div class="form-group" style="flex:1;min-width:200px;">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-input" id="settingsName" placeholder="Your name">
                    </div>
                    <div class="form-group" style="flex:1;min-width:200px;">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="settingsEmailInput" disabled style="opacity:0.5;cursor:not-allowed;">
                    </div>
                </div>
                <button class="btn-primary" onclick="updateProfile()" style="margin-top:0.5rem;">Save Profile</button>
            </div>

            <!-- Security -->
            <div class="card">
                <div class="card-header"><span class="card-title">Security</span></div>
                <p style="color:var(--text-2);font-size:13px;margin-bottom:1rem;">Change your account password. Must be at least 8 characters.</p>
                <div style="display:flex;flex-direction:column;gap:10px;max-width:400px;">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-input" id="settingsCurrentPwd" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-input" id="settingsNewPwd" placeholder="Enter new password (min 8 chars)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-input" id="settingsConfirmPwd" placeholder="Confirm new password">
                    </div>
                </div>
                <button class="btn-primary" onclick="changePassword()" style="margin-top:0.75rem;">Change Password</button>
            </div>

            <!-- Social -->
            <div class="card">
                <div class="card-header"><span class="card-title">Follow Us</span></div>
                <p style="color:var(--text-2);font-size:13px;margin-bottom:1rem;">Stay updated with the latest signals, news and trading insights.</p>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
                    <a href="https://t.me/infotieralba" target="_blank" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);text-decoration:none;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.12)'" onmouseout="this.style.borderColor='var(--border)'">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#5cb87a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                        <div>
                            <div style="font-size:13px;font-weight:600;color:var(--text);">Telegram</div>
                            <div style="font-size:11px;color:var(--text-3);">@infotieralba</div>
                        </div>
                    </a>
                    <a href="https://wa.me/message/AGLUYD2DQ7E3G1" target="_blank" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);text-decoration:none;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.12)'" onmouseout="this.style.borderColor='var(--border)'">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#5cb87a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                        <div>
                            <div style="font-size:13px;font-weight:600;color:var(--text);">WhatsApp</div>
                            <div style="font-size:11px;color:var(--text-3);">Message us</div>
                        </div>
                    </a>
                    <a href="https://instagram.com/tieralba" target="_blank" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);text-decoration:none;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.12)'" onmouseout="this.style.borderColor='var(--border)'">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
                        <div>
                            <div style="font-size:13px;font-weight:600;color:var(--text);">Instagram</div>
                            <div style="font-size:11px;color:var(--text-3);">@tieralba</div>
                        </div>
                    </a>
                    <a href="/cdn-cgi/l/email-protection#275452575748555367534e4255464b45460944484a" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);text-decoration:none;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.12)'" onmouseout="this.style.borderColor='var(--border)'">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        <div>
                            <div style="font-size:13px;font-weight:600;color:var(--text);">Email</div>
                            <div style="font-size:11px;color:var(--text-3);"><span class="__cf_email__" data-cfemail="5f2c2a2f2f302d2b1f2b363a2d3e333d3e713c3032">[email&#160;protected]</span></div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card" style="border-color:rgba(224,82,82,0.15);">
                <div class="card-header"><span class="card-title" style="color:var(--red);">Session</span></div>
                <p style="color:var(--text-2);font-size:13px;margin-bottom:1rem;">Log out from your current session on this device.</p>
                <button class="btn-primary" onclick="logout()" style="background:var(--red-dim);color:var(--red);border-color:rgba(224,82,82,0.2);max-width:200px;">Logout</button>
            </div>
        </div>

        <!-- ═══════ SUPPORT ═══════ -->
        <div id="support" class="section">
            <!-- Quick Contact -->
            <div class="card">
                <div class="card-header"><span class="card-title">Get in Touch</span></div>
                <p style="color:var(--text-2);font-size:13px;margin-bottom:1.25rem;">Reach our team through your preferred channel. We typically respond within a few hours.</p>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
                    <a href="https://t.me/infotieralba" target="_blank" id="supportTelegram" style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:1.25rem 0.5rem;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);text-decoration:none;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.12)'" onmouseout="this.style.borderColor='var(--border)'">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#5cb87a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                        <span style="font-size:13px;font-weight:600;color:var(--text);">Telegram</span>
                        <span style="font-size:10px;color:var(--text-3);">Fastest response</span>
                    </a>
                    <a href="https://wa.me/message/AGLUYD2DQ7E3G1" target="_blank" id="supportWhatsapp" style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:1.25rem 0.5rem;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);text-decoration:none;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.12)'" onmouseout="this.style.borderColor='var(--border)'">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#5cb87a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                        <span style="font-size:13px;font-weight:600;color:var(--text);">WhatsApp</span>
                        <span style="font-size:10px;color:var(--text-3);">Direct message</span>
                    </a>
                    <a href="/cdn-cgi/l/email-protection#3b484e4b4b54494f7b4f525e495a57595a15585456" style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:1.25rem 0.5rem;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);text-decoration:none;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,255,255,0.12)'" onmouseout="this.style.borderColor='var(--border)'">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                        <span style="font-size:13px;font-weight:600;color:var(--text);">Email</span>
                        <span style="font-size:10px;color:var(--text-3);"><span class="__cf_email__" data-cfemail="2f5c5a5f5f405d5b6f5b464a5d4e434d4e014c4042">[email&#160;protected]</span></span>
                    </a>
                </div>
            </div>

            <!-- Contact Form -->
            <div class="card">
                <div class="card-header"><span class="card-title">Send a Message</span></div>
                <div class="form-group">
                    <label class="form-label">Subject</label>
                    <select class="form-input" id="supportSubject" style="cursor:pointer;">
                        <option value="">Select a topic...</option>
                        <option value="Technical Issue">Technical Issue</option>
                        <option value="Billing & Subscription">Billing & Subscription</option>
                        <option value="Broker Connection">Broker Connection</option>
                        <option value="Expert Advisor">Expert Advisor (EA)</option>
                        <option value="Trading Signals">Trading Signals</option>
                        <option value="Feature Request">Feature Request</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-input" id="supportMessage" rows="5" placeholder="Describe your issue or question in detail..." style="resize:vertical;min-height:100px;"></textarea>
                </div>
                <button class="btn-primary" onclick="sendSupportMessage()" id="supportSendBtn" style="width:100%;">Send Message</button>
                <div id="supportStatus" style="margin-top:10px;"></div>
            </div>
        </div>

        <!-- ═══════ ADMIN PANEL ═══════ -->
        <div id="admin" class="section">
            <!-- Stats Row -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
                <div class="stat-card"><div class="stat-label">Total Users</div><div class="stat-value" id="adminTotalUsers">—</div></div>
                <div class="stat-card"><div class="stat-label">Active Services</div><div class="stat-value" id="adminActiveServices">—</div></div>
                <div class="stat-card"><div class="stat-label">Total Revenue</div><div class="stat-value" id="adminTotalRevenue">—</div></div>
                <div class="stat-card"><div class="stat-label">This Month</div><div class="stat-value" id="adminMonthRevenue">—</div></div>
            </div>

            <!-- Search & Filters -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Client Management</span>
                    <button class="btn-primary" onclick="loadAdminUsers()" style="font-size:12px;padding:6px 14px;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px;"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                        Refresh
                    </button>
                </div>
                <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
                    <input type="text" class="form-input" id="adminSearch" placeholder="Search by name or email..." style="flex:1;min-width:200px;" oninput="filterAdminUsers()">
                    <select class="form-input" id="adminFilterService" style="width:160px;cursor:pointer;" onchange="filterAdminUsers()">
                        <option value="">All Services</option>
                        <option value="tierpass">Tier Pass</option>
                        <option value="tiermanage">Tier Manage</option>
                        <option value="tradesalba">TradesAlba</option>
                    </select>
                    <select class="form-input" id="adminFilterStatus" style="width:140px;cursor:pointer;" onchange="filterAdminUsers()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                        <option value="expired">Expired</option>
                        <option value="free">Free (No Service)</option>
                    </select>
                </div>

                <!-- Users Table -->
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;font-size:13px;" id="adminUsersTable">
                        <thead>
                            <tr style="border-bottom:1px solid var(--border);">
                                <th style="text-align:left;padding:10px 12px;color:var(--text-3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">User</th>
                                <th style="text-align:left;padding:10px 12px;color:var(--text-3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Plan</th>
                                <th style="text-align:left;padding:10px 12px;color:var(--text-3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Services</th>
                                <th style="text-align:left;padding:10px 12px;color:var(--text-3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Joined</th>
                                <th style="text-align:center;padding:10px 12px;color:var(--text-3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersBody">
                            <tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-3);">Loading clients...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Purchases -->
            <div class="card">
                <div class="card-header"><span class="card-title">Recent Purchases</span></div>
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;font-size:13px;" id="adminPurchasesTable">
                        <thead>
                            <tr style="border-bottom:1px solid var(--border);">
                                <th style="text-align:left;padding:10px 12px;color:var(--text-3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Date</th>
                                <th style="text-align:left;padding:10px 12px;color:var(--text-3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Client</th>
                                <th style="text-align:left;padding:10px 12px;color:var(--text-3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Service</th>
                                <th style="text-align:left;padding:10px 12px;color:var(--text-3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Plan</th>
                                <th style="text-align:right;padding:10px 12px;color:var(--text-3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="adminPurchasesBody">
                            <tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-3);">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Edit Service Modal -->
        <div class="modal-overlay" id="adminServiceModal" style="display:none;">
            <div class="modal" style="max-width:480px;">
                <div class="modal-header">
                    <div class="modal-title" id="adminModalTitle">Edit Services</div>
                    <button class="modal-close" onclick="document.getElementById('adminServiceModal').style.display='none'">&times;</button>
                </div>
                <div id="adminModalUserInfo" style="padding:12px 16px;background:var(--surface-2);border-radius:var(--radius);margin-bottom:16px;font-size:13px;">
                    <div style="font-weight:600;" id="adminModalUserName">—</div>
                    <div style="color:var(--text-3);font-size:12px;" id="adminModalUserEmail">—</div>
                </div>

                <!-- Tier Pass -->
                <div style="padding:14px 0;border-bottom:1px solid var(--border);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div style="font-weight:600;font-size:13px;">Tier Pass</div>
                        <div id="adminTpStatus" style="font-size:11px;padding:3px 8px;border-radius:6px;background:var(--surface-2);color:var(--text-3);">Inactive</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <select class="form-input" id="adminTpPlan" style="flex:1;font-size:12px;padding:8px 10px;">
                            <option value="">No plan</option>
                            <option value="Bronze 5K">Bronze 5K</option>
                            <option value="Silver 10K">Silver 10K</option>
                            <option value="Gold 25K">Gold 25K</option>
                            <option value="Platinum 50K">Platinum 50K</option>
                            <option value="Emerald 100K">Emerald 100K</option>
                            <option value="Diamond 200K">Diamond 200K</option>
                        </select>
                        <select class="form-input" id="adminTpStat" style="width:110px;font-size:12px;padding:8px 10px;">
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                </div>

                <!-- Tier Manage -->
                <div style="padding:14px 0;border-bottom:1px solid var(--border);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div style="font-weight:600;font-size:13px;">Tier Manage</div>
                        <div id="adminTmStatus" style="font-size:11px;padding:3px 8px;border-radius:6px;background:var(--surface-2);color:var(--text-3);">Inactive</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <select class="form-input" id="adminTmPlan" style="flex:1;font-size:12px;padding:8px 10px;">
                            <option value="">No plan</option>
                            <option value="Lite Funded">Lite Funded</option>
                            <option value="Starter Funded">Starter Funded</option>
                            <option value="Pro Funded">Pro Funded</option>
                        </select>
                        <select class="form-input" id="adminTmStat" style="width:110px;font-size:12px;padding:8px 10px;">
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                </div>

                <!-- TradesAlba -->
                <div style="padding:14px 0;border-bottom:1px solid var(--border);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div style="font-weight:600;font-size:13px;">TradesAlba</div>
                        <div id="adminTaStatus" style="font-size:11px;padding:3px 8px;border-radius:6px;background:var(--surface-2);color:var(--text-3);">Inactive</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <select class="form-input" id="adminTaPlan" style="flex:1;font-size:12px;padding:8px 10px;">
                            <option value="">No plan</option>
                            <option value="standard">Standard</option>
                            <option value="pro">Pro</option>
                        </select>
                        <select class="form-input" id="adminTaStat" style="width:110px;font-size:12px;padding:8px 10px;">
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                </div>

                <!-- Dashboard Plan -->
                <div style="padding:14px 0;margin-bottom:16px;">
                    <div style="font-weight:600;font-size:13px;margin-bottom:8px;">Dashboard Plan</div>
                    <select class="form-input" id="adminDashPlan" style="font-size:12px;padding:8px 10px;">
                        <option value="free">Free</option>
                        <option value="standard">Standard</option>
                        <option value="pro">Pro</option>
                    </select>
                    <div style="font-size:11px;color:var(--text-3);margin-top:4px;">Controls which dashboard sections the user can access.</div>
                </div>

                <div style="display:flex;gap:8px;">
                    <button class="btn-primary" onclick="saveAdminServices()" style="flex:1;">Save Changes</button>
                    <button class="btn-primary" onclick="document.getElementById('adminServiceModal').style.display='none'" style="flex:1;background:var(--surface-2);color:var(--text-2);">Cancel</button>
                </div>
                <div id="adminSaveStatus" style="margin-top:10px;font-size:12px;text-align:center;"></div>
            </div>
        </div>

    </main>
    <div class="modal-overlay" id="brokerModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Connect Broker</div>
                <button class="modal-close" onclick="closeBrokerModal()">&times;</button>
            </div>
            <p style="color:var(--text-2);font-size:13px;margin-bottom:1.25rem;">Connect your trading account using your <strong>investor password</strong> (read-only). Your trades and equity will sync automatically.</p>
            <div class="form-group">
                <label class="form-label">Account Number</label>
                <input type="text" class="form-input" id="modalAccount" placeholder="e.g. 12345678">
            </div>
            <div class="form-group">
                <label class="form-label">Investor Password (read-only)</label>
                <input type="password" class="form-input" id="modalInvestorPwd" placeholder="Your investor/viewer password">
            </div>
            <div class="form-group">
                <label class="form-label">Broker Server</label>
                <input type="text" class="form-input" id="modalBrokerName" placeholder="e.g. AquaFunded-Live, FTMODemo-Server">
                <div style="font-size:11px;color:var(--text-3);margin-top:4px;">Find this in MetaTrader: File → Login to Trade Account → Server field. Must match exactly.</div>
                <div style="font-size:11px;color:var(--text-3);margin-top:4px;">Find this in MetaTrader → File → Login → Server name</div>
            </div>
            <button class="btn-primary" onclick="connectBroker()" id="connectBrokerBtn" style="width:100%;">Connect Account</button>
        </div>
    </div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // ══════════════════════════════════════════════
    // CONFIG
    // ══════════════════════════════════════════════
    const API_URL = window.location.origin;
    let selectedPlatform = 'mt4';

    // ══════════════════════════════════════════════
    // AUTH
    // ══════════════════════════════════════════════
    function getToken() { return localStorage.getItem('auth_token'); }
    function getUserData() { try { return JSON.parse(localStorage.getItem('user_data')); } catch { return null; } }

    function logout() {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_data');
        window.location.href = '/login';
    }

    // Auth check
    if (!getToken()) { window.location.href = '/login'; }

    async function apiCall(endpoint, options = {}) {
        const token = getToken();
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        try {
            const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
            if (res.status === 429) { console.warn(`Rate limited: ${endpoint}`); return null; }
            if (res.status === 401) { logout(); return null; }
            if (res.status === 403) { console.warn(`Access denied: ${endpoint} (plan restriction)`); return null; }
            const text = await res.text();
            try { return JSON.parse(text); } catch { console.error(`Invalid JSON from ${endpoint}`); return null; }
        } catch (err) {
            console.error(`API error: ${endpoint}`, err);
            return null;
        }
    }

    // ══════════════════════════════════════════════
    // NAVIGATION
    // ══════════════════════════════════════════════
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.section');
    const pageTitle = document.getElementById('pageTitle');

    navLinks.forEach(link => {
        link.addEventListener('click', () => {
            const target = link.dataset.section;
            const allowed = planAccess[userPlan] || planAccess.free;
            
            if (!allowed.includes(target)) {
                const requiredPlan = planAccess.pro.includes(target) && !planAccess.standard.includes(target) ? 'pro' : 'standard';
                showUpgradeModal(requiredPlan);
                return;
            }
            
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            sections.forEach(s => s.classList.remove('active'));
            document.getElementById(target)?.classList.add('active');
            pageTitle.textContent = link.querySelector('span').textContent;
            document.getElementById('sidebar').classList.remove('open');

            // Load license keys when entering experts section
            if (target === 'experts') loadLicenseKeys();
            if (target === 'settings') loadSettingsData();
            if (target === 'journal') loadJournal();
            if (target === 'admin') loadAdminUsers();
        });
    });

    document.getElementById('menuToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('open');
    });

    // ══════════════════════════════════════════════
    // TOAST
    // ══════════════════════════════════════════════
    function toast(type, title, msg) {
        const container = document.getElementById('toastContainer');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = `<div><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div><div class="toast-close" onclick="this.parentElement.remove()">&times;</div>`;
        container.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 4000);
    }

    // ══════════════════════════════════════════════
    // CHARTS CONFIG
    // ══════════════════════════════════════════════
    const chartDefaults = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: '#0e0e10',
                titleColor: '#c8aa6e',
                bodyColor: '#f0ede6',
                borderColor: 'rgba(255,255,255,0.06)',
                borderWidth: 1,
                padding: 10,
                cornerRadius: 8
            }
        },
        scales: {
            y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#5c5952', font: { size: 11 } } },
            x: { grid: { display: false }, ticks: { color: '#5c5952', font: { size: 11 } } }
        }
    };

    let charts = {};

    // ══════════════════════════════════════════════
    // LOAD DATA
    // ══════════════════════════════════════════════
    async function loadDashboard() {
        // User info
        const user = getUserData();
        if (user) {
            const initials = (user.name || user.email || 'U').substring(0, 2).toUpperCase();
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('userName').textContent = user.name || user.email?.split('@')[0] || 'Utente';
            document.getElementById('userEmail').textContent = user.email || '';
            document.getElementById('settingsEmail').textContent = user.email || '—';
            checkAdminAccess(user.email);
        }

        // Verify token
        const me = await apiCall('/api/auth/me');
        if (!me) return;

        if (me.user?.created_at) {
            document.getElementById('settingsDate').textContent = new Date(me.user.created_at).toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // Load stats
        const stats = await apiCall('/api/stats');
        if (stats) {
            updateStats(stats);
            updatePerf(stats);
        }

        // Load equity history
        const equity = await apiCall('/api/equity-history?days=30');
        if (equity?.history) drawEquityChart(equity.history);

        // Load trades
        const trades = await apiCall('/api/trades?limit=200');
        if (trades?.trades) {
            drawMonthlyChart(trades.trades);
            drawAnalytics(trades.trades, stats);
            drawDrawdown(trades.trades);
            renderTradeList(trades.trades);
            drawDailyPL(trades.trades);
        }

        toast('success', 'Dashboard', `Welcome, ${user?.name || 'user'}!`);

        // Load new features
        updateRiskGuardian(stats);
        updateBotStatus();

        // Apply plan gating
        const planData = await apiCall('/api/user/plan');
        const plan = planData?.plan || me.user?.plan || 'free';
        applyPlanGating(plan);
        applyIndicatorGating(plan);
        loadRefundHistory();
        loadReferralData();
        if (plan === 'standard' || plan === 'pro') loadSignals();

        // Check for upgrade success
        if (window.location.search.includes('upgrade=success')) {
            toast('success', 'Upgrade Complete', 'Your plan has been upgraded!');
            window.history.replaceState({}, '', '/dashboard');
        }
    }

    // ══════════════════════════════════════════════
    // UPDATE STATS
    // ══════════════════════════════════════════════
    function fmt(v) { return '€' + Math.round(v || 0).toLocaleString('it-IT'); }

    function updateStats(s) {
        document.getElementById('statEquity').textContent = fmt(s.equity);
        const eqPct = s.equity > 0 && s.totalProfit ? ((s.totalProfit / (s.equity - s.totalProfit)) * 100).toFixed(1) : 0;
        document.getElementById('statEquityChange').textContent = s.equity > 0 ? (eqPct >= 0 ? '+' : '') + eqPct + '% all time' : 'No data';
        document.getElementById('statEquityChange').className = 'stat-change' + (eqPct >= 0 ? ' positive' : ' negative');

        document.getElementById('statWinRate').textContent = (s.winRate || 0).toFixed(1) + '%';
        document.getElementById('statWinRateChange').textContent = s.totalTrades + ' trades';
        document.getElementById('statWinRateChange').className = 'stat-change' + (s.winRate >= 50 ? ' positive' : s.totalTrades > 0 ? ' negative' : '');

        document.getElementById('statPF').textContent = (s.profitFactor || 0).toFixed(2);
        const pfText = s.profitFactor >= 2 ? 'Excellent' : s.profitFactor >= 1.5 ? 'Strong' : s.profitFactor >= 1 ? 'Decent' : 'Needs work';
        document.getElementById('statPFChange').textContent = pfText;
        document.getElementById('statPFChange').className = 'stat-change' + (s.profitFactor >= 1 ? ' positive' : ' negative');

        document.getElementById('statProfit').textContent = fmt(s.totalProfit);
        document.getElementById('statProfitChange').textContent = s.totalProfit >= 0 ? '↑ Profitable' : '↓ At a loss';
        document.getElementById('statProfitChange').className = 'stat-change' + (s.totalProfit >= 0 ? ' positive' : ' negative');

        // Mini stats row
        const todayPL = s.todayProfit || 0;
        const todayEl = document.getElementById('statTodayPL');
        todayEl.textContent = (todayPL >= 0 ? '+' : '') + fmt(todayPL);
        todayEl.style.color = todayPL >= 0 ? 'var(--green)' : 'var(--red)';
        document.getElementById('statOpenTrades').textContent = s.openTrades || 0;
        document.getElementById('statTotalTrades').textContent = s.totalTrades || 0;
        document.getElementById('statBestTrade').textContent = fmt(s.bestTrade);
        document.getElementById('statBestTrade').style.color = 'var(--green)';

        // Win/Loss card
        const wins = s.winningTrades || 0;
        const losses = s.losingTrades || 0;
        const total = wins + losses;
        document.getElementById('overviewWins').textContent = wins;
        document.getElementById('overviewLosses').textContent = losses;
        const wrPct = total > 0 ? (wins / total * 100) : 50;
        document.getElementById('overviewWLBar').style.width = wrPct + '%';
        document.getElementById('overviewWRPct').textContent = total > 0 ? wrPct.toFixed(0) + '% wins' : '—';
        document.getElementById('overviewLRPct').textContent = total > 0 ? (100 - wrPct).toFixed(0) + '% losses' : '—';

        // Avg win/loss
        const avgWin = wins > 0 && s.totalProfit !== undefined ? '—' : '—';
        document.getElementById('overviewAvgWin').textContent = fmt(s.bestTrade || 0);
        document.getElementById('overviewAvgLoss').textContent = fmt(s.worstTrade || 0);
    }

    function updatePerf(s) {
        document.getElementById('perfTotal').textContent = s.totalTrades || 0;
        document.getElementById('perfWins').textContent = s.winningTrades || 0;
        document.getElementById('perfLosses').textContent = s.losingTrades || 0;
        document.getElementById('perfWR').textContent = (s.winRate || 0).toFixed(1) + '%';
        document.getElementById('perfPF').textContent = (s.profitFactor || 0).toFixed(2);
        document.getElementById('perfAvg').textContent = fmt(s.avgProfit);
        document.getElementById('perfBest').textContent = fmt(s.bestTrade);
        document.getElementById('perfWorst').textContent = fmt(s.worstTrade);
        const avgWin = s.winningTrades > 0 ? (s.totalWinAmount || 0) / s.winningTrades : 0;
        const avgLoss = s.losingTrades > 0 ? (s.totalLossAmount || 0) / s.losingTrades : 0;
        document.getElementById('perfAvgWin').textContent = fmt(avgWin);
        document.getElementById('perfAvgLoss').textContent = fmt(avgLoss);
        const wr = (s.winRate || 0) / 100;
        const expectancy = (wr * avgWin) - ((1 - wr) * Math.abs(avgLoss));
        document.getElementById('perfExpect').textContent = fmt(expectancy);
        document.getElementById('perfExpect').className = 'perf-value ' + (expectancy >= 0 ? 'green' : 'red');
        document.getElementById('perfMaxDD').textContent = '—';
    }

    // ══════════════════════════════════════════════
    // CHARTS
    // ══════════════════════════════════════════════
    function drawEquityChart(history) {
        const ctx = document.getElementById('equityChart');
        if (charts.equity) charts.equity.destroy();
        const c = ctx.getContext('2d');
        const gradient = c.createLinearGradient(0, 0, 0, 340);
        gradient.addColorStop(0, 'rgba(212,185,120,0.25)');
        gradient.addColorStop(0.4, 'rgba(212,185,120,0.08)');
        gradient.addColorStop(1, 'rgba(212,185,120,0)');

        // Determine if trending up or down
        const firstVal = history[0]?.equity || 0;
        const lastVal = history[history.length - 1]?.equity || 0;
        const isUp = lastVal >= firstVal;
        const lineColor = isUp ? '#5cb87a' : '#e05252';
        const gradUp = c.createLinearGradient(0, 0, 0, 340);
        gradUp.addColorStop(0, isUp ? 'rgba(92,184,122,0.2)' : 'rgba(224,82,82,0.15)');
        gradUp.addColorStop(0.5, isUp ? 'rgba(92,184,122,0.05)' : 'rgba(224,82,82,0.03)');
        gradUp.addColorStop(1, 'transparent');

        charts.equity = new Chart(ctx, {
            type: 'line',
            data: {
                labels: history.map(h => new Date(h.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' })),
                datasets: [{
                    data: history.map(h => h.equity),
                    borderColor: lineColor,
                    backgroundColor: gradUp,
                    borderWidth: 2.5, tension: 0.3, fill: true,
                    pointRadius: 0, pointHoverRadius: 6,
                    pointHoverBackgroundColor: lineColor, pointHoverBorderColor: '#050505', pointHoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#0e0e10', titleColor: '#d4b978', bodyColor: '#f0ede6',
                        borderColor: 'rgba(255,255,255,0.06)', borderWidth: 1,
                        padding: 12, cornerRadius: 8, displayColors: false,
                        callbacks: {
                            title: (items) => items[0]?.label || '',
                            label: (ctx) => 'Equity: €' + Math.round(ctx.parsed.y).toLocaleString('it-IT')
                        }
                    }
                },
                scales: {
                    y: { 
                        grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                        ticks: { 
                            color: '#5c5952', font: { size: 11 },
                            callback: v => '€' + (v >= 1000 ? (v/1000).toFixed(1) + 'k' : v)
                        }
                    },
                    x: { grid: { display: false }, ticks: { color: '#5c5952', font: { size: 10 }, maxTicksLimit: 8 } }
                },
                animation: { duration: 800, easing: 'easeOutQuart' }
            }
        });
    }

    let equityHistoryCache = [];
    async function changeEquityRange(days, btn) {
        document.querySelectorAll('.chart-range-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const equity = await apiCall('/api/equity-history?days=' + days);
        if (equity?.history) drawEquityChart(equity.history);
    }

    function drawDailyPL(trades) {
        const ctx = document.getElementById('dailyPLChart');
        if (charts.dailyPL) charts.dailyPL.destroy();

        // Group closed trades by day
        const daily = {};
        trades.filter(t => t.closed_at).forEach(t => {
            const day = new Date(t.closed_at).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
            daily[day] = (daily[day] || 0) + (parseFloat(t.profit) || 0);
        });

        const labels = Object.keys(daily).slice(-14); // last 14 days with trades
        const data = labels.map(l => parseFloat(daily[l].toFixed(2)));

        charts.dailyPL = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: data.map(d => d >= 0 ? 'rgba(92,184,122,0.7)' : 'rgba(224,82,82,0.7)'),
                    hoverBackgroundColor: data.map(d => d >= 0 ? 'rgba(92,184,122,0.9)' : 'rgba(224,82,82,0.9)'),
                    borderRadius: 4, barPercentage: 0.55
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#0e0e10', titleColor: '#d4b978', bodyColor: '#f0ede6',
                        borderColor: 'rgba(255,255,255,0.06)', borderWidth: 1,
                        padding: 10, cornerRadius: 8, displayColors: false,
                        callbacks: {
                            label: (ctx) => (ctx.parsed.y >= 0 ? '+' : '') + '€' + ctx.parsed.y.toLocaleString('it-IT')
                        }
                    }
                },
                scales: {
                    y: { 
                        grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                        ticks: { color: '#5c5952', font: { size: 11 }, callback: v => '€' + v }
                    },
                    x: { grid: { display: false }, ticks: { color: '#5c5952', font: { size: 10 } } }
                },
                animation: { duration: 600, easing: 'easeOutQuart' }
            }
        });
    }

    // ══════════════════════════════════════════════
    // TRADE LIST (Overview)
    // ══════════════════════════════════════════════
    function switchTradeTab(tab, btn) {
        document.querySelectorAll('.trade-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.trade-tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(tab === 'open' ? 'tradeTabOpen' : 'tradeTabHistory').classList.add('active');
    }

    function renderTradeList(trades) {
        const open = trades.filter(t => !t.closed_at);
        const closed = trades.filter(t => t.closed_at).sort((a,b) => new Date(b.closed_at) - new Date(a.closed_at)).slice(0, 30);

        // Update tab labels with counts
        const tabs = document.querySelectorAll('.trade-tab');
        if (tabs[0]) tabs[0].textContent = `Open (${open.length})`;
        if (tabs[1]) tabs[1].textContent = `History (${closed.length})`;

        // Open trades
        const openEl = document.getElementById('openTradesList');
        if (open.length === 0) {
            openEl.innerHTML = '<div class="trade-empty"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg><div>No open trades</div></div>';
        } else {
            openEl.innerHTML = '<div class="trade-list-header"><span>Symbol</span><span>Lots</span><span>Entry</span><span>P/L</span><span>Time</span></div>' +
                open.map(t => {
                    const dir = (t.type || '').toUpperCase();
                    const dirClass = dir === 'BUY' ? 'buy' : 'sell';
                    const pnl = parseFloat(t.profit) || 0;
                    const price = t.entry_price ? parseFloat(t.entry_price).toFixed(t.symbol?.includes('JPY') ? 3 : 5) : '—';
                    return `<div class="trade-row">
                        <div class="trade-row-symbol"><span class="trade-row-dir ${dirClass}">${dir}</span>${t.symbol || '—'}</div>
                        <div class="trade-row-lots">${parseFloat(t.lots || 0).toFixed(2)}</div>
                        <div class="trade-row-price">${price}</div>
                        <div class="trade-row-pnl ${pnl >= 0 ? 'positive' : 'negative'}">${pnl >= 0 ? '+' : ''}€${Math.round(pnl).toLocaleString('it-IT')}</div>
                        <div class="trade-row-time">${tradeTimeAgo(t.opened_at)}</div>
                    </div>`;
                }).join('');
        }

        // Trade history
        const histEl = document.getElementById('historyTradesList');
        if (closed.length === 0) {
            histEl.innerHTML = '<div class="trade-empty"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg><div>No closed trades yet</div></div>';
        } else {
            histEl.innerHTML = '<div class="trade-list-header"><span>Symbol</span><span>Lots</span><span>Exit</span><span>P/L</span><span>Closed</span></div>' +
                closed.map(t => {
                    const dir = (t.type || '').toUpperCase();
                    const dirClass = dir === 'BUY' ? 'buy' : 'sell';
                    const pnl = parseFloat(t.profit) || 0;
                    const price = t.exit_price ? parseFloat(t.exit_price).toFixed(t.symbol?.includes('JPY') ? 3 : 5) : '—';
                    return `<div class="trade-row">
                        <div class="trade-row-symbol"><span class="trade-row-dir ${dirClass}">${dir}</span>${t.symbol || '—'}</div>
                        <div class="trade-row-lots">${parseFloat(t.lots || 0).toFixed(2)}</div>
                        <div class="trade-row-price">${price}</div>
                        <div class="trade-row-pnl ${pnl >= 0 ? 'positive' : 'negative'}">${pnl >= 0 ? '+' : ''}€${Math.round(pnl).toLocaleString('it-IT')}</div>
                        <div class="trade-row-time">${tradeTimeAgo(t.closed_at)}</div>
                    </div>`;
                }).join('');
        }
    }

    function tradeTimeAgo(dateStr) {
        if (!dateStr) return '—';
        const diff = Date.now() - new Date(dateStr).getTime();
        const mins = Math.floor(diff / 60000);
        if (mins < 1) return 'Just now';
        if (mins < 60) return mins + 'm ago';
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return hrs + 'h ago';
        const days = Math.floor(hrs / 24);
        if (days < 7) return days + 'd ago';
        return new Date(dateStr).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
    }

    function drawMonthlyChart(trades) {
        const ctx = document.getElementById('monthlyChart');
        const months = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
        const data = Array(12).fill(0);
        trades.forEach(t => {
            if (t.closed_at && t.profit) data[new Date(t.closed_at).getMonth()] += parseFloat(t.profit);
        });
        if (charts.monthly) charts.monthly.destroy();
        charts.monthly = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    data: data.map(d => parseFloat(d.toFixed(2))),
                    backgroundColor: data.map(d => d >= 0 ? 'rgba(92,184,122,0.7)' : 'rgba(224,82,82,0.7)'),
                    borderRadius: 4, barPercentage: 0.6
                }]
            },
            options: chartDefaults
        });
    }

    function drawAnalytics(trades, stats) {
        const closed = trades.filter(t => t.closed_at);
        const tt = { backgroundColor:'#0e0e10', titleColor:'#d4b978', bodyColor:'#f0ede6', borderColor:'rgba(255,255,255,0.06)', borderWidth:1, cornerRadius:8 };
        const br = { borderRadius:4, barPercentage:0.6 };

        // Win/Loss/BE Distribution
        const distCtx = document.getElementById('distributionChart');
        if (charts.dist) charts.dist.destroy();
        const be = (stats?.totalTrades||0) - (stats?.winningTrades||0) - (stats?.losingTrades||0);
        charts.dist = new Chart(distCtx, {
            type:'doughnut',
            data:{ labels:['Winners','Losers','Breakeven'], datasets:[{ data:[stats?.winningTrades||0, stats?.losingTrades||0, be], backgroundColor:['#5cb87a','#e05252','#5c5952'], borderWidth:0, spacing:3 }] },
            options:{ responsive:true, maintainAspectRatio:true, cutout:'65%', plugins:{ legend:{ position:'bottom', labels:{ color:'#9b978f', padding:14, font:{size:11}, usePointStyle:true }}}}
        });

        // P/L by Day of Week
        const dowPL = {Mon:0,Tue:0,Wed:0,Thu:0,Fri:0};
        const dowN = {Mon:0,Tue:0,Wed:0,Thu:0,Fri:0};
        const dn = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        closed.forEach(t => { const d = dn[new Date(t.closed_at).getDay()]; if(dowPL[d]!==undefined){ dowPL[d]+=parseFloat(t.profit)||0; dowN[d]++; }});
        const dowV = Object.values(dowPL).map(v=>parseFloat(v.toFixed(2)));
        const dowCtx = document.getElementById('dayOfWeekChart');
        if (charts.dow) charts.dow.destroy();
        charts.dow = new Chart(dowCtx, {
            type:'bar', data:{ labels:Object.keys(dowPL), datasets:[{ data:dowV, backgroundColor:dowV.map(v=>v>=0?'rgba(92,184,122,0.6)':'rgba(224,82,82,0.6)'), ...br }] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false},tooltip:{...tt,callbacks:{label:c=>(c.parsed.y>=0?'+':'')+'€'+c.parsed.y+' ('+dowN[c.label]+' trades)'}}}, scales:{y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#5c5952',font:{size:10},callback:v=>'€'+v}},x:{grid:{display:false},ticks:{color:'#9b978f',font:{size:11,weight:600}}}}}
        });

        // Hourly P/L
        const hPL = Array(12).fill(0), hN = Array(12).fill(0);
        closed.forEach(t => { if(t.opened_at){ const h=Math.floor(new Date(t.opened_at).getHours()/2); hPL[h]+=parseFloat(t.profit)||0; hN[h]++; }});
        const hourCtx = document.getElementById('hourlyChart');
        if (charts.hourly) charts.hourly.destroy();
        charts.hourly = new Chart(hourCtx, {
            type:'bar', data:{ labels:['0-2h','2-4h','4-6h','6-8h','8-10h','10-12h','12-14h','14-16h','16-18h','18-20h','20-22h','22-24h'],
                datasets:[{ data:hPL.map(v=>parseFloat(v.toFixed(2))), backgroundColor:hPL.map(v=>v>=0?'rgba(200,170,110,0.5)':'rgba(224,82,82,0.4)'), ...br }] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false},tooltip:{...tt,callbacks:{label:c=>(c.parsed.y>=0?'+':'')+'€'+c.parsed.y+' ('+hN[c.dataIndex]+' trades)'}}}, scales:{y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#5c5952',font:{size:10},callback:v=>'€'+v}},x:{grid:{display:false},ticks:{color:'#5c5952',font:{size:9}}}}}
        });

        // P/L by Symbol (horizontal bar)
        const sym = {};
        closed.forEach(t => { if(t.symbol) sym[t.symbol]=(sym[t.symbol]||0)+(parseFloat(t.profit)||0); });
        const sL = Object.keys(sym).sort((a,b)=>sym[b]-sym[a]);
        const sV = sL.map(l=>parseFloat(sym[l].toFixed(2)));
        const symCtx = document.getElementById('symbolPLChart');
        if (charts.symPL) charts.symPL.destroy();
        charts.symPL = new Chart(symCtx, {
            type:'bar', data:{ labels:sL, datasets:[{ data:sV, backgroundColor:sV.map(v=>v>=0?'rgba(92,184,122,0.6)':'rgba(224,82,82,0.6)'), ...br }] },
            options:{ responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{legend:{display:false},tooltip:{...tt,callbacks:{label:c=>(c.parsed.x>=0?'+':'')+'€'+c.parsed.x}}}, scales:{x:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#5c5952',font:{size:10},callback:v=>'€'+v}},y:{grid:{display:false},ticks:{color:'#9b978f',font:{size:11}}}}}
        });

        // Lots vs P/L Scatter
        const sc = closed.map(t=>({x:parseFloat(t.lots)||0,y:parseFloat(t.profit)||0})).filter(p=>p.x>0);
        const lotsCtx = document.getElementById('lotsPLChart');
        if (charts.lotsPL) charts.lotsPL.destroy();
        charts.lotsPL = new Chart(lotsCtx, {
            type:'scatter', data:{ datasets:[{ data:sc, backgroundColor:sc.map(p=>p.y>=0?'rgba(92,184,122,0.6)':'rgba(224,82,82,0.6)'), pointRadius:5, pointHoverRadius:7 }] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false},tooltip:{...tt,callbacks:{label:c=>'Lots: '+c.parsed.x.toFixed(2)+' → '+(c.parsed.y>=0?'+':'')+'€'+c.parsed.y.toFixed(2)}}}, scales:{x:{title:{display:true,text:'Lot Size',color:'#5c5952',font:{size:11}},grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#5c5952',font:{size:10}}},y:{title:{display:true,text:'P/L (€)',color:'#5c5952',font:{size:11}},grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#5c5952',font:{size:10},callback:v=>'€'+v}}}}
        });
    }

    function drawDrawdown(trades) {
        const sorted = [...trades].filter(t=>t.closed_at).sort((a,b)=>new Date(a.closed_at)-new Date(b.closed_at));
        if (!sorted.length) return;
        let cum=0, peak=0, maxDD=0;
        const dd=[], cumD=[], labels=[];
        sorted.forEach(t => {
            cum+=parseFloat(t.profit)||0;
            if(cum>peak) peak=cum;
            const d=peak>0?parseFloat(((cum-peak)/peak*100).toFixed(2)):0;
            if(d<maxDD) maxDD=d;
            dd.push(d); cumD.push(parseFloat(cum.toFixed(2)));
            labels.push(new Date(t.closed_at).toLocaleDateString('it-IT',{day:'2-digit',month:'short'}));
        });
        const ddEl=document.getElementById('perfMaxDD');
        if(ddEl) ddEl.textContent=maxDD.toFixed(1)+'%';
        const tt={backgroundColor:'#0e0e10',bodyColor:'#f0ede6',borderColor:'rgba(255,255,255,0.06)',borderWidth:1,cornerRadius:8};

        // Drawdown
        const ctx=document.getElementById('drawdownChart');
        if(charts.dd) charts.dd.destroy();
        charts.dd=new Chart(ctx,{type:'line',data:{labels,datasets:[{data:dd,borderColor:'#e05252',backgroundColor:'rgba(224,82,82,0.08)',borderWidth:2,tension:0.3,fill:true,pointRadius:0,pointHoverRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...tt,callbacks:{label:c=>c.parsed.y.toFixed(2)+'%'}}},scales:{y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#5c5952',font:{size:10},callback:v=>v+'%'}},x:{display:false}}}});

        // Cumulative P/L
        const cumCtx=document.getElementById('cumulativePLChart');
        if(charts.cumPL) charts.cumPL.destroy();
        const up=cumD[cumD.length-1]>=0;
        const lc=up?'#5cb87a':'#e05252';
        const gc=cumCtx.getContext('2d');
        const grd=gc.createLinearGradient(0,0,0,300);
        grd.addColorStop(0,up?'rgba(92,184,122,0.2)':'rgba(224,82,82,0.2)');
        grd.addColorStop(1,'transparent');
        charts.cumPL=new Chart(cumCtx,{type:'line',data:{labels,datasets:[{data:cumD,borderColor:lc,backgroundColor:grd,borderWidth:2,tension:0.3,fill:true,pointRadius:0,pointHoverRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...tt,callbacks:{label:c=>(c.parsed.y>=0?'+':'')+'€'+c.parsed.y}}},scales:{y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#5c5952',font:{size:10},callback:v=>'€'+v}},x:{display:false}}}});

        // Streaks
        let cs=0; const streaks=[];
        sorted.forEach(t=>{const p=parseFloat(t.profit)||0;if(p>0)cs=cs>0?cs+1:1;else if(p<0)cs=cs<0?cs-1:-1;else cs=0;streaks.push(cs);});
        const skCtx=document.getElementById('streakChart');
        if(charts.streak) charts.streak.destroy();
        const sl=streaks.slice(-30), slL=labels.slice(-30);
        charts.streak=new Chart(skCtx,{type:'bar',data:{labels:slL,datasets:[{data:sl,backgroundColor:sl.map(v=>v>0?'rgba(92,184,122,0.6)':'rgba(224,82,82,0.6)'),borderRadius:3,barPercentage:0.5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...tt,callbacks:{label:c=>(c.parsed.y>0?'+':'')+c.parsed.y+' streak'}}},scales:{y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#5c5952',font:{size:10},stepSize:1}},x:{display:false}}}});

        // Monthly Returns
        const mo={};
        sorted.forEach(t=>{const m=new Date(t.closed_at).toLocaleDateString('en-US',{month:'short',year:'2-digit'});mo[m]=(mo[m]||0)+(parseFloat(t.profit)||0);});
        const mL=Object.keys(mo), mV=mL.map(l=>parseFloat(mo[l].toFixed(2)));
        const mCtx=document.getElementById('monthlyRetChart');
        if(charts.monthRet) charts.monthRet.destroy();
        charts.monthRet=new Chart(mCtx,{type:'bar',data:{labels:mL,datasets:[{data:mV,backgroundColor:mV.map(v=>v>=0?'rgba(92,184,122,0.6)':'rgba(224,82,82,0.6)'),borderRadius:4,barPercentage:0.6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...tt,callbacks:{label:c=>(c.parsed.y>=0?'+':'')+'€'+c.parsed.y}}},scales:{y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#5c5952',font:{size:10},callback:v=>'€'+v}},x:{grid:{display:false},ticks:{color:'#9b978f',font:{size:10}}}}}});
    }

    // ══════════════════════════════════════════════
    // CALCULATOR
    // ══════════════════════════════════════════════
    function calculatePosition() {
        const account = parseFloat(document.getElementById('calcAccount').value);
        const risk = parseFloat(document.getElementById('calcRisk').value);
        const entry = parseFloat(document.getElementById('calcEntry').value);
        const sl = parseFloat(document.getElementById('calcSL').value);
        if (!account || !risk || !entry || !sl || entry === sl) {
            toast('error', 'Error', 'Please fill in all fields correctly');
            return;
        }
        const riskAmt = account * (risk / 100);
        const pips = Math.abs(entry - sl) * 10000;
        const lots = (riskAmt / (pips * 10)).toFixed(2);

        document.getElementById('calcLots').textContent = lots + ' Lots';
        document.getElementById('calcRiskAmt').textContent = '€' + riskAmt.toFixed(2);
        document.getElementById('calcPips').textContent = pips.toFixed(1);
        document.getElementById('calcProfit').textContent = '€' + (riskAmt * 2).toFixed(2);
        document.getElementById('calcResult').classList.add('show');
        toast('success', 'Calculated', `Position size: ${lots} lots`);
    }

    // ══════════════════════════════════════════════
    // BROKER MODAL
    // ══════════════════════════════════════════════
    function openBrokerModal(name, platform) {
        selectedPlatform = platform || 'mt4';
        document.getElementById('modalTitle').textContent = 'Connect ' + name;
        document.getElementById('brokerModal').classList.add('active');
    }

    function closeBrokerModal() {
        document.getElementById('brokerModal').classList.remove('active');
        document.getElementById('modalAccount').value = '';
        document.getElementById('modalInvestorPwd').value = '';
        document.getElementById('modalBrokerName').value = '';
    }

    async function connectBroker() {
        const account = document.getElementById('modalAccount').value.trim();
        const investorPassword = document.getElementById('modalInvestorPwd').value;
        const brokerName = document.getElementById('modalBrokerName').value.trim();
        if (!account || !investorPassword || !brokerName) { toast('error', 'Error', 'Please fill in all fields'); return; }

        const btn = document.getElementById('connectBrokerBtn');
        btn.disabled = true; btn.textContent = 'Connecting...';

        const res = await apiCall('/api/broker/connect', {
            method: 'POST',
            body: JSON.stringify({ platform: selectedPlatform, accountNumber: account, investorPassword, brokerName })
        });
        
        if (res?.success) {
            toast('success', 'Connected!', res.message || 'Account connected successfully');
            closeBrokerModal();
            // Auto sync after connect
            syncBrokerData();
            updateBotStatus();
        } else {
            toast('error', 'Connection Failed', res?.error || 'Check your credentials and broker server name');
            if (res?.error && res.error.length > 100) {
                // Show detailed error in a more readable way
                const errDiv = document.getElementById('brokerErrorDetail');
                if (errDiv) errDiv.remove();
                const div = document.createElement('div');
                div.id = 'brokerErrorDetail';
                div.style.cssText = 'margin-top:12px;padding:12px 16px;background:rgba(232,114,114,0.08);border:1px solid rgba(232,114,114,0.15);border-radius:10px;font-size:13px;color:var(--red);line-height:1.6;';
                div.textContent = res.error;
                document.getElementById('connectBrokerBtn').parentElement.appendChild(div);
            }
        }
        btn.disabled = false; btn.textContent = 'Connect Account';
    }

    async function syncBrokerData() {
        toast('info', 'Syncing', 'Fetching data from your broker...');
        const res = await apiCall('/api/broker/sync', { method: 'POST' });
        if (res?.success) {
            toast('success', 'Synced', `${res.synced} trades imported. Equity: €${(res.account?.equity || 0).toFixed(2)}`);
            // Full dashboard reload after sync
            const stats = await apiCall('/api/stats');
            if (stats) { updateStats(stats); updatePerf(stats); updateRiskGuardian(stats); }
            const equity = await apiCall('/api/equity-history?days=30');
            if (equity?.history) drawEquityChart(equity.history);
            const trades = await apiCall('/api/trades?limit=200');
            if (trades?.trades) {
                drawMonthlyChart(trades.trades);
                drawAnalytics(trades.trades, stats);
                drawDrawdown(trades.trades);
                renderTradeList(trades.trades);
                drawDailyPL(trades.trades);
            }
            // Refresh broker cards and bot status
            updateBotStatus();
        } else {
            toast('error', 'Sync Failed', res?.error || 'Could not sync data. Account may still be deploying, try again in 1 minute.');
        }
    }

    // Close modal on overlay click
    document.getElementById('brokerModal').addEventListener('click', function(e) {
        if (e.target === this) closeBrokerModal();
    });

    // ══════════════════════════════════════════════
    // COPY FUNCTIONS
    // ══════════════════════════════════════════════
    function copyReferral() {
        const code = document.getElementById('refCodeDisplay').textContent;
        if (code && code !== '—') {
            navigator.clipboard.writeText(code).then(() => toast('success', 'Copied', 'Referral code copied!'));
        } else {
            toast('error', 'Error', 'Referral code not loaded yet');
        }
    }

    // ══════════════════════════════════════════════
    // RISK GUARDIAN
    // ══════════════════════════════════════════════
    let riskSettings = JSON.parse(localStorage.getItem('riskSettings') || '{"capital":100000,"target":10,"dailyDD":5,"maxDD":10}');

    function saveRiskSettings() {
        riskSettings = {
            capital: parseFloat(document.getElementById('riskCapital').value) || 100000,
            target: parseFloat(document.getElementById('riskTarget').value) || 10,
            dailyDD: parseFloat(document.getElementById('riskDailyDD').value) || 5,
            maxDD: parseFloat(document.getElementById('riskMaxDD').value) || 10
        };
        localStorage.setItem('riskSettings', JSON.stringify(riskSettings));
        updateRiskGuardian();
        toast('success', 'Saved', 'Risk settings updated');
    }

    function updateRiskGuardian(stats) {
        const s = stats || {};
        const totalProfit = s.totalProfit || 0;
        const equity = s.equity || 0;
        
        // Use real equity as capital when broker is connected, otherwise use manual setting
        const realCapital = equity > 0 ? equity : riskSettings.capital;
        const capital = realCapital;
        const targetAmt = capital * (riskSettings.target / 100);

        // Account Overview — show/hide based on broker connection
        apiCall('/api/broker/connections').then(data => {
            const active = data?.connections?.find(c => c.is_active);
            const noAccEl = document.getElementById('rgNoAccount');
            const accInfoEl = document.getElementById('rgAccountInfo');
            const accBadge = document.getElementById('rgAccountBadge');

            if (active) {
                noAccEl.style.display = 'none';
                accInfoEl.style.display = 'block';
                accBadge.textContent = 'CONNECTED';
                accBadge.className = 'dd-status-badge';

                // Use real equity from broker
                document.getElementById('rgBalance').textContent = equity > 0 ? fmt(equity) : fmt(riskSettings.capital);
                document.getElementById('rgEquity').textContent = equity > 0 ? fmt(equity) : fmt(riskSettings.capital + totalProfit);

                // Today P&L from today's trades
                const todayPL = s.todayProfit || 0;
                const todayEl = document.getElementById('rgTodayPL');
                todayEl.textContent = (todayPL >= 0 ? '+' : '') + fmt(todayPL);
                todayEl.className = 'perf-value ' + (todayPL >= 0 ? 'green' : 'red');

                document.getElementById('rgOpenTrades').textContent = s.openTrades || '0';
            } else {
                noAccEl.style.display = 'block';
                accInfoEl.style.display = 'none';
                accBadge.textContent = 'NO ACCOUNT';
                accBadge.className = 'dd-status-badge warning';
            }
        });

        // Challenge progress
        const progress = targetAmt > 0 ? Math.min((totalProfit / targetAmt) * 100, 100) : 0;
        document.getElementById('challengeTarget').textContent = fmt(Math.max(totalProfit, 0)) + ' / ' + fmt(targetAmt);
        document.getElementById('challengeProgress').style.width = Math.max(progress, 0) + '%';
        document.getElementById('challengePercent').textContent = Math.max(progress, 0).toFixed(1) + '% completed';
        document.getElementById('challengeProfit').textContent = fmt(totalProfit);
        document.getElementById('challengeWR').textContent = (s.winRate || 0) + '%';

        const statusEl = document.getElementById('challengeStatus');
        if (totalProfit >= targetAmt && targetAmt > 0) {
            statusEl.textContent = 'TARGET HIT!'; statusEl.className = 'perf-value gold';
        } else if (totalProfit >= 0) {
            statusEl.textContent = 'In Progress'; statusEl.className = 'perf-value green';
        } else {
            statusEl.textContent = 'Losing'; statusEl.className = 'perf-value red';
        }

        // Drawdown calculations using real trade data
        // Daily loss: sum of today's closed losing trades
        const todayLoss = Math.abs(Math.min(s.todayProfit || 0, 0));
        const dailyDDPercent = capital > 0 ? (todayLoss / capital * 100) : 0;

        // Max drawdown: peak to trough from total P&L
        const maxDDAmount = Math.abs(Math.min(totalProfit, 0));
        const maxDDPercent = capital > 0 ? (maxDDAmount / capital * 100) : 0;
        
        const dailyLimit = riskSettings.dailyDD;
        const maxLimit = riskSettings.maxDD;
        const dailyRatio = Math.min(dailyDDPercent / dailyLimit * 100, 100);
        const maxRatio = Math.min(maxDDPercent / maxLimit * 100, 100);

        document.getElementById('ddDailyValue').textContent = dailyDDPercent.toFixed(2) + '% / ' + dailyLimit + '%';
        document.getElementById('ddDailyBar').style.width = dailyRatio + '%';
        document.getElementById('ddDailyBar').className = 'dd-bar-fill ' + (dailyRatio > 80 ? 'dd-danger' : dailyRatio > 50 ? 'dd-warning' : 'dd-safe');

        document.getElementById('ddMaxValue').textContent = maxDDPercent.toFixed(2) + '% / ' + maxLimit + '%';
        document.getElementById('ddMaxBar').style.width = maxRatio + '%';
        document.getElementById('ddMaxBar').className = 'dd-bar-fill ' + (maxRatio > 80 ? 'dd-danger' : maxRatio > 50 ? 'dd-warning' : 'dd-safe');

        // Status badge
        const badge = document.getElementById('ddStatusBadge');
        if (dailyRatio > 80 || maxRatio > 80) {
            badge.textContent = 'DANGER'; badge.className = 'dd-status-badge danger';
        } else if (dailyRatio > 50 || maxRatio > 50) {
            badge.textContent = 'WARNING'; badge.className = 'dd-status-badge warning';
        } else {
            badge.textContent = 'SAFE'; badge.className = 'dd-status-badge';
        }

        // Fill in settings form
        document.getElementById('riskCapital').value = riskSettings.capital;
        document.getElementById('riskTarget').value = riskSettings.target;
        document.getElementById('riskDailyDD').value = riskSettings.dailyDD;
        document.getElementById('riskMaxDD').value = riskSettings.maxDD;
    }

    function toggleEquityProtector() {
        const on = document.getElementById('equityProtectorToggle').checked;
        document.getElementById('epSettings').style.display = on ? 'block' : 'none';
        if (on) toast('info', 'Equity Protector', 'Set your alert threshold');
    }

    function saveEquityProtector() {
        const limit = document.getElementById('epLimit').value;
        localStorage.setItem('equityProtectorLimit', limit);
        toast('success', 'Alert Set', 'You will be alerted if daily loss exceeds ' + limit + '%');
    }

    // ══════════════════════════════════════════════
    // BOT CONTROL
    // ══════════════════════════════════════════════
    function updateBotStatus() {
        apiCall('/api/broker/connections').then(data => {
            const active = data?.connections?.find(c => c.is_active);
            const pulse = document.getElementById('botPulse');
            const text = document.getElementById('botStatusText');
            
            // Update Experts section
            if (active) {
                pulse.className = 'bot-pulse online';
                text.textContent = 'Online';
                document.getElementById('botEAStatus').textContent = 'Active';
                document.getElementById('botEAStatus').className = 'perf-value green';
                document.getElementById('botConnection').textContent = active.platform.toUpperCase();
                document.getElementById('botConnection').className = 'perf-value green';
                document.getElementById('botLastBeat').textContent = 'Now';
            } else {
                pulse.className = 'bot-pulse offline';
                text.textContent = 'Not connected';
                document.getElementById('botEAStatus').textContent = 'Inactive';
                document.getElementById('botEAStatus').className = 'perf-value red';
                document.getElementById('botConnection').textContent = 'None';
                document.getElementById('botConnection').className = 'perf-value red';
                document.getElementById('botLastBeat').textContent = '—';
            }

            // Update Broker section
            const badge = document.getElementById('brokerConnBadge');
            const info = document.getElementById('connectedBrokerInfo');
            if (active) {
                badge.textContent = 'CONNECTED'; badge.className = 'dd-status-badge';
                info.style.display = 'block';
                document.getElementById('connAccNum').textContent = '#' + active.account_number;
                document.getElementById('connPlatform').textContent = active.platform.toUpperCase();
                document.getElementById('connBroker').textContent = active.broker_name || '—';
            } else {
                badge.textContent = 'NOT CONNECTED'; badge.className = 'dd-status-badge warning';
                info.style.display = 'none';
            }
        });
    }

    async function disconnectBroker() {
        if (!confirm('Disconnect your trading account? This will also clear all trade data.')) return;
        await apiCall('/api/broker/disconnect', { method: 'POST' });
        toast('info', 'Disconnected', 'Broker account disconnected and data cleared');
        updateBotStatus();
        // Reset dashboard stats to zero
        updateStats({equity:0,totalProfit:0,winRate:0,profitFactor:0,totalTrades:0,openTrades:0,bestTrade:0,worstTrade:0,todayProfit:0,winningTrades:0,losingTrades:0});
        updatePerf({totalTrades:0,winningTrades:0,losingTrades:0,winRate:0,profitFactor:0,avgProfit:0,bestTrade:0,worstTrade:0});
    }

    async function resetBrokerData() {
        if (!confirm('Reset all trade data? This will clear old trades and equity history. You can then sync to reload fresh data from your current broker.')) return;
        const res = await apiCall('/api/broker/reset-data', { method: 'POST' });
        if (res?.success) {
            toast('success', 'Data Reset', res.message || 'Old data cleared. Syncing fresh data...');
            // Reset UI
            updateStats({equity:0,totalProfit:0,winRate:0,profitFactor:0,totalTrades:0,openTrades:0,bestTrade:0,worstTrade:0,todayProfit:0,winningTrades:0,losingTrades:0});
            // Auto sync fresh data
            await syncBrokerData();
        } else {
            toast('error', 'Error', res?.error || 'Failed to reset data');
        }
    }

    // ══════════════════════════════════════════════
    // PLAN GATING
    // ══════════════════════════════════════════════
    const planAccess = {
        free: ['overview', 'calculator', 'calendar', 'referral', 'refund', 'settings', 'support', 'admin'],
        standard: ['overview', 'signals', 'riskguard', 'performance', 'analytics', 'brokers', 'calculator', 'indicators', 'calendar', 'journal', 'referral', 'refund', 'settings', 'support', 'admin'],
        pro: ['overview', 'signals', 'riskguard', 'experts', 'performance', 'analytics', 'brokers', 'calculator', 'indicators', 'calendar', 'journal', 'referral', 'refund', 'settings', 'support', 'admin']
    };

    let userPlan = 'free';

    function applyPlanGating(plan) {
        userPlan = plan || 'free';
        const allowed = planAccess[userPlan] || planAccess.free;
        
        document.querySelectorAll('.nav-link').forEach(link => {
            const section = link.dataset.section;
            if (!section) return;
            const locked = !allowed.includes(section);
            link.classList.toggle('nav-locked', locked);
            
            // Add lock icon
            let lockEl = link.querySelector('.lock-icon');
            if (locked && !lockEl) {
                lockEl = document.createElement('span');
                lockEl.className = 'lock-icon';
                lockEl.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>';
                link.appendChild(lockEl);
            } else if (!locked && lockEl) {
                lockEl.remove();
            }
        });

        // Update plan badge in settings
        const planEl = document.querySelector('#settingsPlan');
        if (planEl) planEl.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
    }

    function showUpgradeModal(requiredPlan) {
        const modal = document.getElementById('upgradeModal');
        if (modal) {
            document.getElementById('upgradePlanName').textContent = requiredPlan === 'pro' ? 'Pro' : 'Standard';
            document.getElementById('upgradePrice').textContent = requiredPlan === 'pro' ? '€89.99' : '€49.99';
            modal.classList.add('active');
        }
    }

    function closeUpgradeModal() {
        document.getElementById('upgradeModal')?.classList.remove('active');
    }

    async function upgradePlan(plan) {
        const priceIds = {
            standard: window.STRIPE_STANDARD_PRICE_ID || '',
            pro: window.STRIPE_PRO_PRICE_ID || ''
        };
        const priceId = priceIds[plan];
        if (!priceId) {
            // Fallback to Stripe payment links from the website
            const links = {
                standard: 'https://buy.stripe.com/4gM5kF3UVgRFapEci85kk0h',
                pro: 'https://buy.stripe.com/6oU8wR0IJcBpbtI81S5kk0i'
            };
            window.open(links[plan], '_blank');
            closeUpgradeModal();
            return;
        }
        
        const res = await apiCall('/api/stripe/checkout', {
            method: 'POST',
            body: JSON.stringify({ priceId })
        });
        if (res?.url) {
            window.location.href = res.url;
        } else {
            toast('error', 'Error', 'Failed to start checkout');
        }
    }

    async function manageSubscription() {
        const res = await apiCall('/api/stripe/portal', { method: 'POST' });
        if (res?.url) {
            window.location.href = res.url;
        } else {
            toast('info', 'Info', 'No active subscription found');
        }
    }

    // ══════════════════════════════════════════════
    // THEME TOGGLE
    // ══════════════════════════════════════════════
    function toggleTheme() {
        const isLight = document.body.classList.toggle('light');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        // Update icon
        document.getElementById('themeIcon').innerHTML = isLight
            ? '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>'
            : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
    }

    // Load saved theme
    if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light');
        document.getElementById('themeIcon').innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
    }

    // ══════════════════════════════════════════════
    // INDICATORS
    // ══════════════════════════════════════════════
    function applyIndicatorGating(plan) {
        const badge = document.getElementById('indicatorPlanBadge');
        if (plan === 'pro') {
            badge.textContent = 'PRO — 3 INDICATORS'; badge.className = 'dd-status-badge';
            badge.style.background = 'var(--gold-dim)'; badge.style.color = 'var(--gold)';
        } else if (plan === 'standard') {
            badge.textContent = 'STANDARD — 1 INDICATOR'; badge.className = 'dd-status-badge';
        } else {
            badge.textContent = 'UPGRADE REQUIRED'; badge.className = 'dd-status-badge warning';
        }

        document.querySelectorAll('.indicator-card').forEach(card => {
            const reqPlan = card.dataset.plan;
            const locked = (reqPlan === 'pro' && plan !== 'pro') || (reqPlan === 'standard' && plan === 'free');
            card.style.opacity = locked ? '0.4' : '1';
            card.style.pointerEvents = locked ? 'none' : 'auto';
            const btn = card.querySelector('.btn-download');
            if (btn && locked) btn.textContent = reqPlan === 'pro' ? 'Pro Only' : 'Upgrade';
        });
    }

    function toggleInvite(num) {
        const el = document.getElementById('invite' + num);
        const btn = document.getElementById('inviteBtn' + num);
        if (el.style.display === 'none') {
            el.style.display = 'block';
            btn.style.display = 'none';
        } else {
            el.style.display = 'none';
            btn.style.display = 'inline-block';
        }
    }

    function requestIndicatorAccess(num) {
        const username = document.getElementById('tvUser' + num).value.trim();
        if (!username) { toast('error', 'Error', 'Please enter your TradingView username'); return; }
        
        // Save to localStorage for now (in production could save to DB)
        const requests = JSON.parse(localStorage.getItem('indicatorRequests') || '{}');
        requests[num] = { username, date: new Date().toISOString(), status: 'pending' };
        localStorage.setItem('indicatorRequests', JSON.stringify(requests));
        
        toast('success', 'Request Sent', 'We will add ' + username + ' to the indicator within 24 hours.');
        document.getElementById('invite' + num).innerHTML = '<div style="padding:8px 0;color:var(--green);font-size:13px;font-weight:600;">✓ Access requested for @' + username + '</div>';
    }

    // ══════════════════════════════════════════════
    // REFUND
    // ══════════════════════════════════════════════
    async function submitRefund() {
        const reason = document.getElementById('refundReason').value;
        const details = document.getElementById('refundDetails').value;
        if (!reason) { toast('error', 'Error', 'Please select a reason'); return; }

        const btn = document.getElementById('refundBtn');
        btn.disabled = true; btn.textContent = 'Submitting...';

        const res = await apiCall('/api/refund/request', {
            method: 'POST',
            body: JSON.stringify({ reason, details })
        });

        if (res?.success) {
            toast('success', 'Submitted', 'Your refund request has been submitted');
            document.getElementById('refundReason').value = '';
            document.getElementById('refundDetails').value = '';
            loadRefundHistory();
        } else {
            toast('error', 'Error', res?.error || 'Failed to submit');
        }
        btn.disabled = false; btn.textContent = 'Submit Refund Request';
    }

    async function loadRefundHistory() {
        const res = await apiCall('/api/refund/status');
        const container = document.getElementById('refundHistory');
        if (!res?.requests?.length) {
            container.innerHTML = '<p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">No refund requests yet.</p>';
            return;
        }
        container.innerHTML = res.requests.map(r => {
            const statusColors = { pending: 'gold', approved: 'green', rejected: 'red' };
            const statusLabels = { pending: 'Pending Review', approved: 'Approved', rejected: 'Rejected' };
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);">
                <div>
                    <div style="font-size:14px;font-weight:500;">${r.reason.replace(/_/g, ' ')}</div>
                    <div style="font-size:12px;color:var(--text-3);">${new Date(r.created_at).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' })}</div>
                </div>
                <span class="dd-status-badge ${r.status === 'approved' ? '' : r.status === 'rejected' ? 'danger' : 'warning'}">${statusLabels[r.status] || r.status}</span>
            </div>`;
        }).join('');
    }

    // ══════════════════════════════════════════════
    // EA DOWNLOADS
    // ══════════════════════════════════════════════
    async function downloadEA(filename) {
        toast('info', 'Download', 'Preparing ' + filename + '...');
        try {
            const token = getToken();
            const res = await fetch('/ea-files/' + filename, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.status === 403) {
                toast('error', 'Access Denied', 'Active subscription required to download EA files.');
                return;
            }
            if (!res.ok) {
                toast('error', 'Error', 'Download failed. Please try again.');
                return;
            }
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
            toast('success', 'Download', filename + ' downloaded!');
        } catch (err) {
            toast('error', 'Error', 'Download failed.');
        }
    }

    // ══════════════════════════════════════════════
    // LICENSE KEY MANAGEMENT
    // ══════════════════════════════════════════════

    async function loadLicenseKeys() {
        const container = document.getElementById('licenseKeysContainer');
        if (!container) return;

        try {
            const res = await apiCall('/api/ea/license');
            if (!res || !res.licenses) {
                container.innerHTML = '<div style="text-align:center;padding:1.5rem 0;color:var(--text-3);">Click "Generate Keys" to get your license keys.</div>';
                return;
            }

            const licenses = res.licenses;
            if (licenses.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:1.5rem 0;color:var(--text-3);">No license keys yet. Click "Generate Keys" to activate your EAs.</div>';
                return;
            }

            let html = '';
            for (const lic of licenses) {
                const productName = lic.product === 'tier_algo_gold' ? 'Tier Algo Gold' 
                                  : lic.product === 'tier_algo_us100' ? 'Tier Algo US100' 
                                  : lic.product;
                const productIcon = lic.product === 'tier_algo_gold' ? '🥇' : '📈';
                const statusColor = lic.is_active ? 'var(--green)' : 'var(--red)';
                const statusText = lic.is_active ? 'Active' : 'Revoked';
                const lastVerified = lic.last_verified ? new Date(lic.last_verified).toLocaleString() : 'Never';
                const mtAccount = lic.mt_account || '—';

                html += `
                <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:0.75rem;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;flex-wrap:wrap;gap:0.5rem;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:20px;">${productIcon}</span>
                            <span style="font-weight:600;font-size:14px;">${productName}</span>
                        </div>
                        <span style="color:${statusColor};font-size:11px;text-transform:uppercase;letter-spacing:1px;font-weight:600;">${statusText}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:0.75rem;">
                        <code style="background:var(--surface-3);padding:10px 14px;border-radius:8px;font-family:'DM Mono',monospace;font-size:14px;letter-spacing:1.5px;color:var(--gold);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${lic.license_key}</code>
                        <button class="btn-small" onclick="copyLicenseKey('${lic.license_key}')" style="white-space:nowrap;">Copy</button>
                    </div>
                    <div style="display:flex;gap:1.5rem;flex-wrap:wrap;font-size:11px;color:var(--text-3);">
                        <span>MT Account: <strong style="color:var(--text-2);">${mtAccount}</strong></span>
                        <span>Verifications: <strong style="color:var(--text-2);">${lic.verification_count || 0}</strong></span>
                        <span>Last Check: <strong style="color:var(--text-2);">${lastVerified}</strong></span>
                    </div>
                </div>`;
            }

            container.innerHTML = html;

        } catch (err) {
            container.innerHTML = '<div style="text-align:center;padding:1.5rem 0;color:var(--red);">Error loading licenses</div>';
        }
    }

    async function generateLicenseKeys() {
        const btn = document.getElementById('btnGenLicense');
        btn.disabled = true;
        btn.textContent = 'Generating...';

        try {
            const res = await apiCall('/api/ea/license/generate', { method: 'POST' });
            if (res?.error) {
                toast('error', 'License Error', res.error);
            } else {
                toast('success', 'License Keys', res.message || 'Keys generated successfully!');
                await loadLicenseKeys();
            }
        } catch (err) {
            toast('error', 'Error', 'Failed to generate license keys');
        }

        btn.disabled = false;
        btn.textContent = 'Generate Keys';
    }

    function copyLicenseKey(key) {
        navigator.clipboard.writeText(key).then(() => {
            toast('success', 'Copied!', 'License key copied to clipboard');
        }).catch(() => {
            // Fallback
            const ta = document.createElement('textarea');
            ta.value = key;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            toast('success', 'Copied!', 'License key copied to clipboard');
        });
    }

    // ══════════════════════════════════════════════
    // INIT
    // ══════════════════════════════════════════════
    // ══════════════════════════════════════════════
    // SIGNALS
    // ══════════════════════════════════════════════
    let allSignals = [];
    let signalFilter = 'all';

    async function loadSignals() {
        const res = await apiCall('/api/signals');
        if (!res?.signals) return;
        allSignals = res.signals;
        updateSignalStats();
        renderSignals();
    }

    function updateSignalStats() {
        const total = allSignals.length;
        const active = allSignals.filter(s => s.status !== 'closed').length;
        const wins = allSignals.filter(s => s.result === 'TP' || s.result === 'WIN').length;
        const losses = allSignals.filter(s => s.result === 'SL' || s.result === 'LOSS').length;
        const closed = wins + losses;
        const wr = closed > 0 ? ((wins / closed) * 100).toFixed(0) : '0';

        document.getElementById('sigStatTotal').textContent = total;
        document.getElementById('sigStatActive').textContent = active;
        document.getElementById('sigStatWR').textContent = wr + '%';
        document.getElementById('sigStatRecord').textContent = wins + 'W — ' + losses + 'L';
    }

    function renderSignals() {
        const filtered = signalFilter === 'all' ? allSignals : allSignals.filter(s => signalFilter === 'active' ? s.status !== 'closed' : s.status === 'closed');
        const container = document.getElementById('signalsList');

        if (!filtered.length) {
            container.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-3);">No signals yet. Stay tuned!</div>';
            return;
        }

        container.innerHTML = filtered.map(s => {
            const dir = s.direction?.toLowerCase();
            const isClosed = s.status === 'closed';
            const ago = timeAgo(s.created_at);
            const src = s.source === 'ea' ? 'ea' : '';

            // Result badge with clear labels
            let resultBadge = '';
            if (s.result === 'TP' || s.result === 'WIN') {
                resultBadge = '<span class="signal-result win">TP HIT</span>';
            } else if (s.result === 'SL' || s.result === 'LOSS') {
                resultBadge = '<span class="signal-result loss">SL HIT</span>';
            } else if (s.result === 'BE') {
                resultBadge = '<span class="signal-result be">BREAK EVEN</span>';
            }
            
            function fmtSigPrice(val) {
                if (!val) return '—';
                const n = parseFloat(val);
                if (isNaN(n)) return val;
                // Remove unnecessary trailing zeros but keep meaningful decimals
                // JPY pairs: 3 decimals, Indices/Gold: 2, Forex: 5
                const str = n.toString();
                if (str.includes('.')) {
                    const dec = str.split('.')[1].length;
                    if (dec <= 2) return n.toFixed(2);
                    if (n >= 100) return n.toFixed(2); // Gold, indices
                    return n.toFixed(dec > 5 ? 5 : dec);
                }
                return n.toFixed(n >= 100 ? 2 : 5);
            }

            let prices = '';
            if (s.entry_price) prices += `<div class="signal-price" onclick="copyPrice(this,'${s.entry_price}')"><span class="copy-hint">COPY</span><div class="signal-price-label">Entry</div><div class="signal-price-val entry">${fmtSigPrice(s.entry_price)}</div></div>`;
            if (s.stop_loss) prices += `<div class="signal-price" onclick="copyPrice(this,'${s.stop_loss}')"><span class="copy-hint">COPY</span><div class="signal-price-label">SL</div><div class="signal-price-val sl">${fmtSigPrice(s.stop_loss)}</div></div>`;
            if (s.tp1) prices += `<div class="signal-price" onclick="copyPrice(this,'${s.tp1}')"><span class="copy-hint">COPY</span><div class="signal-price-label">TP1</div><div class="signal-price-val tp">${fmtSigPrice(s.tp1)}</div></div>`;
            if (s.tp2) prices += `<div class="signal-price" onclick="copyPrice(this,'${s.tp2}')"><span class="copy-hint">COPY</span><div class="signal-price-label">TP2</div><div class="signal-price-val tp">${fmtSigPrice(s.tp2)}</div></div>`;
            if (s.tp3) prices += `<div class="signal-price" onclick="copyPrice(this,'${s.tp3}')"><span class="copy-hint">COPY</span><div class="signal-price-label">TP3</div><div class="signal-price-val tp">${fmtSigPrice(s.tp3)}</div></div>`;

            const closedInfo = s.closed_at ? `<div style="font-size:11px;color:var(--text-3);margin-top:6px;">Closed ${timeAgo(s.closed_at)}</div>` : '';

            return `<div class="signal-card ${dir} ${isClosed ? 'closed' : ''}">
                <div class="signal-header">
                    <span class="signal-dir ${dir}">${s.direction}</span>
                    <span class="signal-symbol">${s.symbol}</span>
                    <span class="signal-source ${src}">${s.source === 'ea' ? 'AI' : 'Team'}</span>
                    ${resultBadge}
                    <span class="signal-time">${ago}</span>
                </div>
                <div class="signal-prices">${prices}</div>
                ${s.notes ? `<div class="signal-notes">${s.notes}</div>` : ''}
                ${closedInfo}
            </div>`;
        }).join('');
    }

    function filterSignals(filter) {
        signalFilter = filter;
        document.querySelectorAll('[data-sigfilter]').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-sigfilter="${filter}"]`).classList.add('active');
        renderSignals();
    }

    function copyPrice(el, value) {
        navigator.clipboard.writeText(value).then(() => {
            el.classList.add('copied');
            toast('success', 'Copied', value + ' copied to clipboard');
            setTimeout(() => el.classList.remove('copied'), 800);
        }).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = value; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy');
            document.body.removeChild(ta);
            el.classList.add('copied');
            toast('success', 'Copied', value + ' copied');
            setTimeout(() => el.classList.remove('copied'), 800);
        });
    }

    function timeAgo(dateStr) {
        if (!dateStr) return '';
        const diff = Date.now() - new Date(dateStr).getTime();
        const mins = Math.floor(diff / 60000);
        if (mins < 1) return 'Just now';
        if (mins < 60) return mins + 'm ago';
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return hrs + 'h ago';
        const days = Math.floor(hrs / 24);
        if (days < 7) return days + 'd ago';
        return new Date(dateStr).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
    }

    // ══════════════════════════════════════════════
    // JOURNAL
    // ══════════════════════════════════════════════
    let journalImageData = null;
    let journalEntries = [];
    let jFollowedRules = null;

    function openJournalModal(editId) {
        document.getElementById('journalEditId').value = editId || '';
        document.getElementById('journalModalTitle').textContent = editId ? 'Edit Entry' : 'New Trade Entry';
        // Reset all fields
        ['jPair','jDir','jLots','jRisk','jEntry','jSL','jTP','jPnL','jRRPlan','jDateTime','jSetup','jTF','jNotes'].forEach(id => {
            const el = document.getElementById(id); if (el) el.value = '';
        });
        document.getElementById('journalTradeId').value = '';
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        jFollowedRules = null;
        document.getElementById('jRulesYes').classList.remove('selected');
        document.getElementById('jRulesNo').classList.remove('selected');
        journalImageData = null;
        document.getElementById('journalImagePreview').style.display = 'none';
        document.getElementById('journalUploadArea').style.display = 'flex';

        populateTradeDropdown();

        if (editId) {
            const e = journalEntries.find(x => x.id === editId);
            if (e) {
                document.getElementById('jPair').value = e.symbol || '';
                document.getElementById('jDir').value = e.direction || '';
                document.getElementById('jLots').value = e.lots || '';
                document.getElementById('jRisk').value = e.risk_pct || '';
                document.getElementById('jEntry').value = e.entry_price || '';
                document.getElementById('jSL').value = e.sl || '';
                document.getElementById('jTP').value = e.tp || '';
                document.getElementById('jPnL').value = e.pnl || '';
                document.getElementById('jRRPlan').value = e.rr_planned || '';
                document.getElementById('jSetup').value = e.setup || '';
                document.getElementById('jTF').value = e.timeframe || '';
                document.getElementById('jNotes').value = e.notes || '';
                document.getElementById('journalTradeId').value = e.trade_id || '';
                if (e.trade_date) document.getElementById('jDateTime').value = e.trade_date.substring(0,16);
                if (e.mood) { const mb = document.querySelector(`.mood-btn[data-mood="${e.mood}"]`); if (mb) mb.classList.add('selected'); }
                if (e.followed_rules === true) { jFollowedRules = true; document.getElementById('jRulesYes').classList.add('selected'); }
                if (e.followed_rules === false) { jFollowedRules = false; document.getElementById('jRulesNo').classList.add('selected'); }
                if (e.image_url) { journalImageData = e.image_url; document.getElementById('journalPreviewImg').src = e.image_url; document.getElementById('journalImagePreview').style.display = 'block'; document.getElementById('journalUploadArea').style.display = 'none'; }
            }
        } else {
            document.getElementById('jDateTime').value = new Date().toISOString().substring(0,16);
        }
        document.getElementById('journalModal').classList.add('active');
    }

    function closeJournalModal() { document.getElementById('journalModal').classList.remove('active'); }
    function selectMood(btn) { document.querySelectorAll('.mood-btn[data-mood]').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
    function selectRules(val) {
        jFollowedRules = val;
        document.getElementById('jRulesYes').classList.toggle('selected', val === true);
        document.getElementById('jRulesNo').classList.toggle('selected', val === false);
    }

    async function populateTradeDropdown() {
        const sel = document.getElementById('journalTradeId');
        sel.innerHTML = '<option value="">Manual entry</option>';
        const trades = await apiCall('/api/trades?limit=50');
        if (trades?.trades) {
            trades.trades.forEach(t => {
                const pnl = parseFloat(t.profit) || 0;
                const date = t.closed_at ? new Date(t.closed_at).toLocaleDateString('it-IT', { day:'2-digit', month:'short' }) : 'Open';
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.dataset.symbol = t.symbol || '';
                opt.dataset.type = t.type || '';
                opt.dataset.lots = t.lots || '';
                opt.dataset.entry = t.entry_price || '';
                opt.dataset.exit = t.exit_price || '';
                opt.dataset.profit = t.profit || '';
                opt.dataset.opened = t.opened_at || '';
                opt.textContent = `${t.symbol} ${t.type} ${pnl >= 0 ? '+' : ''}€${Math.round(pnl)} (${date})`;
                sel.appendChild(opt);
            });
        }
    }

    function autoFillFromTrade() {
        const sel = document.getElementById('journalTradeId');
        const opt = sel.selectedOptions[0];
        if (!opt || !opt.value) return;
        document.getElementById('jPair').value = opt.dataset.symbol || '';
        document.getElementById('jDir').value = (opt.dataset.type || '').toUpperCase();
        document.getElementById('jLots').value = opt.dataset.lots || '';
        document.getElementById('jEntry').value = opt.dataset.entry || '';
        document.getElementById('jPnL').value = opt.dataset.profit || '';
        if (opt.dataset.opened) document.getElementById('jDateTime').value = opt.dataset.opened.substring(0,16);
    }

    function handleJournalImage(input) {
        const file = input.files[0]; if (!file) return;
        if (file.size > 2*1024*1024) { toast('error','Error','Max 2MB'); return; }
        const r = new FileReader();
        r.onload = e => { journalImageData = e.target.result; document.getElementById('journalPreviewImg').src = journalImageData; document.getElementById('journalImagePreview').style.display = 'block'; document.getElementById('journalUploadArea').style.display = 'none'; };
        r.readAsDataURL(file);
    }
    function removeJournalImage() { journalImageData = null; document.getElementById('journalImagePreview').style.display = 'none'; document.getElementById('journalUploadArea').style.display = 'flex'; document.getElementById('journalFileInput').value = ''; }

    async function saveJournalEntry() {
        const pair = document.getElementById('jPair').value.trim().toUpperCase();
        const dir = document.getElementById('jDir').value;
        if (!pair) { toast('error','Error','Pair is required'); return; }

        const body = {
            symbol: pair, direction: dir,
            lots: parseFloat(document.getElementById('jLots').value) || null,
            risk_pct: parseFloat(document.getElementById('jRisk').value) || null,
            entry_price: parseFloat(document.getElementById('jEntry').value) || null,
            sl: parseFloat(document.getElementById('jSL').value) || null,
            tp: parseFloat(document.getElementById('jTP').value) || null,
            pnl: parseFloat(document.getElementById('jPnL').value) || null,
            rr_planned: parseFloat(document.getElementById('jRRPlan').value) || null,
            trade_date: document.getElementById('jDateTime').value || null,
            setup: document.getElementById('jSetup').value || null,
            timeframe: document.getElementById('jTF').value || null,
            mood: document.querySelector('.mood-btn[data-mood].selected')?.dataset.mood || null,
            followed_rules: jFollowedRules,
            notes: document.getElementById('jNotes').value.trim() || null,
            trade_id: document.getElementById('journalTradeId').value || null,
            image: journalImageData
        };

        const btn = document.getElementById('journalSaveBtn');
        btn.disabled = true; btn.textContent = 'Saving...';
        const editId = document.getElementById('journalEditId').value;
        const res = editId
            ? await apiCall('/api/journal/' + editId, { method: 'PUT', body: JSON.stringify(body) })
            : await apiCall('/api/journal', { method: 'POST', body: JSON.stringify(body) });

        if (res?.success) { toast('success','Saved', editId ? 'Updated' : 'Entry added'); closeJournalModal(); loadJournal(); }
        else toast('error','Error', res?.error || 'Failed');
        btn.disabled = false; btn.textContent = 'Save Entry';
    }

    async function deleteJournalEntry(id) {
        if (!confirm('Delete this entry?')) return;
        const res = await apiCall('/api/journal/' + id, { method: 'DELETE' });
        if (res?.success) { toast('info','Deleted','Entry removed'); loadJournal(); }
    }

    async function loadJournal() {
        const res = await apiCall('/api/journal');
        if (!res?.entries) return;
        journalEntries = res.entries;
        updateJournalStats();
        updateJournalFilters();
        renderJournal();
        drawJournalCharts();
    }

    function updateJournalStats() {
        const entries = journalEntries.filter(e => e.pnl !== null);
        const wins = entries.filter(e => e.pnl > 0).length;
        const losses = entries.filter(e => e.pnl < 0).length;
        const total = wins + losses;
        const wr = total > 0 ? (wins/total*100) : 0;
        document.getElementById('jStatWR').textContent = total > 0 ? wr.toFixed(0)+'%' : '—';
        document.getElementById('jStatWRSub').textContent = total + ' trades';
        document.getElementById('jStatWRSub').className = 'stat-change' + (wr >= 50 ? ' positive' : total > 0 ? ' negative' : '');

        const winSum = entries.filter(e=>e.pnl>0).reduce((s,e)=>s+e.pnl,0);
        const lossSum = Math.abs(entries.filter(e=>e.pnl<0).reduce((s,e)=>s+e.pnl,0));
        const pf = lossSum > 0 ? (winSum/lossSum) : 0;
        document.getElementById('jStatPF').textContent = pf > 0 ? pf.toFixed(2) : '—';
        document.getElementById('jStatPFSub').textContent = pf >= 1.5 ? 'Strong' : pf >= 1 ? 'Decent' : pf > 0 ? 'Weak' : '—';
        document.getElementById('jStatPFSub').className = 'stat-change' + (pf >= 1 ? ' positive' : pf > 0 ? ' negative' : '');

        const rrEntries = journalEntries.filter(e => e.rr_planned);
        const avgRR = rrEntries.length > 0 ? rrEntries.reduce((s,e)=>s+e.rr_planned,0)/rrEntries.length : 0;
        document.getElementById('jStatRR').textContent = avgRR > 0 ? avgRR.toFixed(1)+'R' : '—';
        document.getElementById('jStatRRSub').textContent = rrEntries.length + ' entries with RR';

        const rulesEntries = journalEntries.filter(e => e.followed_rules !== null);
        const rulesYes = rulesEntries.filter(e => e.followed_rules === true).length;
        const discScore = rulesEntries.length > 0 ? Math.round(rulesYes/rulesEntries.length*100) : 0;
        document.getElementById('jStatDisc').textContent = rulesEntries.length > 0 ? discScore + '/100' : '—';
        document.getElementById('jStatDiscSub').textContent = rulesEntries.length > 0 ? rulesYes + '/' + rulesEntries.length + ' rules followed' : '—';
        document.getElementById('jStatDiscSub').className = 'stat-change' + (discScore >= 80 ? ' positive' : discScore > 0 ? ' negative' : '');

        // Overtrading alert
        const today = new Date().toDateString();
        const todayCount = journalEntries.filter(e => e.trade_date && new Date(e.trade_date).toDateString() === today).length;
        if (todayCount >= 5) toast('error', '⚠️ Overtrading Alert', todayCount + ' trades today. Step back and review.');
    }

    function updateJournalFilters() {
        const pairs = [...new Set(journalEntries.map(e=>e.symbol).filter(Boolean))];
        const setups = [...new Set(journalEntries.map(e=>e.setup).filter(Boolean))];
        const pairSel = document.getElementById('jFilterPair');
        const setupSel = document.getElementById('jFilterSetup');
        const pairVal = pairSel.value; const setupVal = setupSel.value;
        pairSel.innerHTML = '<option value="">All Pairs</option>' + pairs.map(p=>`<option>${p}</option>`).join('');
        setupSel.innerHTML = '<option value="">All Setups</option>' + setups.map(s=>`<option>${s}</option>`).join('');
        pairSel.value = pairVal; setupSel.value = setupVal;
    }

    function getFilteredJournal() {
        let entries = journalEntries;
        const pair = document.getElementById('jFilterPair').value;
        const setup = document.getElementById('jFilterSetup').value;
        const from = document.getElementById('jFilterFrom').value;
        const to = document.getElementById('jFilterTo').value;
        if (pair) entries = entries.filter(e => e.symbol === pair);
        if (setup) entries = entries.filter(e => e.setup === setup);
        if (from) entries = entries.filter(e => e.trade_date && e.trade_date >= from);
        if (to) entries = entries.filter(e => e.trade_date && e.trade_date <= to + 'T23:59');
        return entries;
    }

    function renderJournal() {
        const el = document.getElementById('journalEntries');
        const entries = getFilteredJournal();
        if (entries.length === 0) {
            el.innerHTML = '<div class="trade-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity:0.3;margin-bottom:8px;"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg><div>No entries found</div></div>';
            return;
        }
        el.innerHTML = entries.map(e => {
            const dir = e.direction || '';
            const dc = dir==='BUY'?'buy':dir==='SELL'?'sell':'';
            const pnl = e.pnl !== null ? parseFloat(e.pnl) : null;
            const date = e.trade_date ? new Date(e.trade_date).toLocaleDateString('it-IT',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '—';
            const moodE = {confident:'😎',calm:'😌',neutral:'😐',anxious:'😰',fomo:'🤑',revenge:'😤'}[e.mood]||'';
            const rulesIcon = e.followed_rules===true?'✅':e.followed_rules===false?'❌':'';
            return `<div class="journal-card">
                <div class="journal-card-header">
                    <div class="journal-card-symbol">
                        ${dir?`<span class="trade-row-dir ${dc}" style="font-size:10px;">${dir}</span>`:''}
                        ${e.symbol||'—'}
                        ${e.setup?`<span class="journal-tag">${e.setup}</span>`:''}
                        ${e.timeframe?`<span class="journal-tag">${e.timeframe}</span>`:''}
                        ${moodE} ${rulesIcon}
                    </div>
                    <div class="journal-card-meta">${date}</div>
                </div>
                <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:12px;color:var(--text-2);margin-bottom:6px;">
                    ${e.lots?`<span>Lots: <b>${e.lots}</b></span>`:''}
                    ${e.entry_price?`<span>Entry: <b>${e.entry_price}</b></span>`:''}
                    ${e.sl?`<span>SL: <b>${e.sl}</b></span>`:''}
                    ${e.tp?`<span>TP: <b>${e.tp}</b></span>`:''}
                    ${e.rr_planned?`<span>RR: <b>${e.rr_planned}R</b></span>`:''}
                    ${e.risk_pct?`<span>Risk: <b>${e.risk_pct}%</b></span>`:''}
                    ${pnl!==null?`<span style="color:${pnl>=0?'var(--green)':'var(--red)'};font-weight:700;">P/L: ${pnl>=0?'+':''}€${pnl.toFixed(2)}</span>`:''}
                </div>
                ${e.notes?`<div class="journal-card-notes">${e.notes.replace(/\n/g,'<br>')}</div>`:''}
                ${e.image_url?`<img src="${e.image_url}" class="journal-card-img" onclick="window.open(this.src)">`:''}
                <div class="journal-card-actions">
                    <button onclick="openJournalModal(${e.id})">Edit</button>
                    <button onclick="deleteJournalEntry(${e.id})" style="color:var(--red);">Delete</button>
                </div>
            </div>`;
        }).join('');
    }

    function drawJournalCharts() {
        const entries = journalEntries.filter(e => e.pnl !== null);
        const barOpts = (cb) => ({ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false},tooltip:{backgroundColor:'#0e0e10',bodyColor:'#f0ede6',borderColor:'rgba(255,255,255,0.06)',borderWidth:1,cornerRadius:8,callbacks:{label:cb||function(c){return (c.parsed.y>=0?'+':'')+'€'+c.parsed.y}}}}, scales:{y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#5c5952',font:{size:10},callback:v=>'€'+v}},x:{grid:{display:false},ticks:{color:'#5c5952',font:{size:10}}}} });

        // P/L by pair
        const pairData = {};
        entries.forEach(e => { pairData[e.symbol] = (pairData[e.symbol]||0) + e.pnl; });
        const pairLabels = Object.keys(pairData);
        const pairVals = pairLabels.map(l => parseFloat(pairData[l].toFixed(2)));
        const pCtx = document.getElementById('jChartPair');
        if (charts.jPair) charts.jPair.destroy();
        charts.jPair = new Chart(pCtx, {
            type:'bar', data:{ labels:pairLabels, datasets:[{ data:pairVals, backgroundColor:pairVals.map(v=>v>=0?'rgba(92,184,122,0.7)':'rgba(224,82,82,0.7)'), borderRadius:4, barPercentage:0.6 }] },
            options: barOpts()
        });

        // P/L by setup
        const setupData = {};
        entries.forEach(e => { if(e.setup) setupData[e.setup] = (setupData[e.setup]||0) + e.pnl; });
        const setupLabels = Object.keys(setupData);
        const setupVals = setupLabels.map(l => parseFloat(setupData[l].toFixed(2)));
        const sCtx = document.getElementById('jChartSetup');
        if (charts.jSetup) charts.jSetup.destroy();
        charts.jSetup = new Chart(sCtx, {
            type:'bar', data:{ labels:setupLabels, datasets:[{ data:setupVals, backgroundColor:setupVals.map(v=>v>=0?'rgba(92,184,122,0.7)':'rgba(224,82,82,0.7)'), borderRadius:4, barPercentage:0.6 }] },
            options: barOpts()
        });

        // P/L by hour
        const hourData = {};
        entries.forEach(e => {
            if (e.trade_date) {
                const h = new Date(e.trade_date).getHours();
                const slot = h.toString().padStart(2,'0') + ':00';
                hourData[slot] = (hourData[slot]||0) + e.pnl;
            }
        });
        const hourLabels = Object.keys(hourData).sort();
        const hourVals = hourLabels.map(l => parseFloat(hourData[l].toFixed(2)));
        const hCtx = document.getElementById('jChartHour');
        if (charts.jHour) charts.jHour.destroy();
        charts.jHour = new Chart(hCtx, {
            type:'bar', data:{ labels:hourLabels, datasets:[{ data:hourVals, backgroundColor:hourVals.map(v=>v>=0?'rgba(92,184,122,0.6)':'rgba(224,82,82,0.6)'), borderRadius:3, barPercentage:0.5 }] },
            options: barOpts()
        });

        // Win/Loss doughnut
        const wins = entries.filter(e => e.pnl > 0).length;
        const losses = entries.filter(e => e.pnl < 0).length;
        const be = entries.filter(e => e.pnl === 0).length;
        const wlCtx = document.getElementById('jChartWL');
        if (charts.jWL) charts.jWL.destroy();
        charts.jWL = new Chart(wlCtx, {
            type:'doughnut',
            data:{
                labels:['Wins','Losses','Breakeven'],
                datasets:[{ data:[wins,losses,be], backgroundColor:['#5cb87a','#e05252','#5c5952'], borderWidth:0, spacing:2 }]
            },
            options:{
                responsive:true, maintainAspectRatio:true, cutout:'65%',
                plugins:{ legend:{ position:'bottom', labels:{ color:'#9b978f', padding:12, font:{size:11}, usePointStyle:true } } }
            }
        });
    }

    // ══════════════════════════════════════════════
    // SETTINGS
    // ══════════════════════════════════════════════
    function loadSettingsData() {
        const user = getUserData();
        if (user) {
            document.getElementById('settingsName').value = user.name || '';
            document.getElementById('settingsEmailInput').value = user.email || '';
        }
    }

    async function updateProfile() {
        const name = document.getElementById('settingsName').value.trim();
        if (!name) { toast('error', 'Error', 'Name is required'); return; }
        const res = await apiCall('/api/user/profile', {
            method: 'PUT',
            body: JSON.stringify({ name })
        });
        if (res?.success) {
            toast('success', 'Updated', 'Profile updated successfully');
            const user = getUserData();
            if (user) { user.name = name; localStorage.setItem('user_data', JSON.stringify(user)); }
            document.getElementById('userName').textContent = name;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
        } else {
            toast('error', 'Error', res?.error || 'Failed to update');
        }
    }

    async function changePassword() {
        const current = document.getElementById('settingsCurrentPwd').value;
        const newPwd = document.getElementById('settingsNewPwd').value;
        const confirm = document.getElementById('settingsConfirmPwd').value;

        if (!current) { toast('error', 'Error', 'Enter current password'); return; }
        if (!newPwd || newPwd.length < 8) { toast('error', 'Error', 'New password must be at least 8 characters'); return; }
        if (newPwd !== confirm) { toast('error', 'Error', 'Passwords do not match'); return; }

        const res = await apiCall('/api/user/password', {
            method: 'PUT',
            body: JSON.stringify({ currentPassword: current, newPassword: newPwd })
        });
        if (res?.success) {
            toast('success', 'Updated', 'Password changed successfully');
            document.getElementById('settingsCurrentPwd').value = '';
            document.getElementById('settingsNewPwd').value = '';
            document.getElementById('settingsConfirmPwd').value = '';
        } else {
            toast('error', 'Error', res?.error || 'Failed to change password');
        }
    }

    // ══════════════════════════════════════════════
    // SUPPORT
    // ══════════════════════════════════════════════
    async function sendSupportMessage() {
        const subject = document.getElementById('supportSubject').value;
        const message = document.getElementById('supportMessage').value.trim();
        const btn = document.getElementById('supportSendBtn');
        const status = document.getElementById('supportStatus');

        if (!subject) { toast('error', 'Required', 'Please select a subject'); return; }
        if (!message || message.length < 10) { toast('error', 'Required', 'Please write a detailed message (min 10 chars)'); return; }

        btn.disabled = true; btn.textContent = 'Sending...';
        try {
            const res = await apiCall('/api/support/message', {
                method: 'POST',
                body: JSON.stringify({ subject, message })
            });
            if (res?.success) {
                toast('success', 'Sent!', 'Your message has been received.');
                document.getElementById('supportSubject').value = '';
                document.getElementById('supportMessage').value = '';
                status.innerHTML = '<div style="padding:10px;background:var(--green-dim);color:var(--green);border-radius:var(--radius);font-size:12px;font-weight:600;">Message sent! We\'ll reply within 24 hours.</div>';
            } else {
                toast('error', 'Error', res?.error || 'Failed to send');
            }
        } catch (e) {
            toast('error', 'Error', 'Connection failed');
        }
        btn.disabled = false; btn.textContent = 'Send Message';
    }

    // ══════════════════════════════════════════════
    // REFERRAL SYSTEM
    // ══════════════════════════════════════════════
    async function loadReferralData() {
        const res = await apiCall('/api/referral/info');
        if (!res) return;

        const baseUrl = window.location.origin;
        document.getElementById('refBalance').textContent = '€' + (res.balance || 0).toFixed(2);
        document.getElementById('refPayoutBalance').textContent = '€' + (res.balance || 0).toFixed(2);
        document.getElementById('refTotalEarned').textContent = '€' + (res.total_earned || 0).toFixed(2);
        document.getElementById('refTotalReferrals').textContent = res.total_referrals || 0;
        document.getElementById('refCodeDisplay').textContent = res.referral_code || '—';
        document.getElementById('refLinkInput').value = baseUrl + '/login?ref=' + (res.referral_code || '');
        if (res.usdt_wallet) document.getElementById('refWallet').value = res.usdt_wallet;

        document.getElementById('refBalanceNote').textContent = res.balance >= 50 ? 'Ready for payout!' : 'Min. €50 for payout';
        document.getElementById('refBalanceNote').className = 'stat-change' + (res.balance >= 50 ? ' positive' : '');

        // Commissions
        const commDiv = document.getElementById('refCommissions');
        if (!res.commissions?.length) {
            commDiv.innerHTML = '<p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">No commissions yet. Share your link to start earning!</p>';
        } else {
            commDiv.innerHTML = res.commissions.map(c => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
                    <div>
                        <div style="font-size:13px;font-weight:500;">${c.referred_email}</div>
                        <div style="font-size:11px;color:var(--text-3);">${c.plan_purchased?.toUpperCase()} · ${new Date(c.created_at).toLocaleDateString('en-US', {day:'numeric',month:'short'})}</div>
                    </div>
                    <div style="font-family:'DM Mono',monospace;font-size:14px;font-weight:600;color:var(--green);">+€${parseFloat(c.commission_amount).toFixed(2)}</div>
                </div>
            `).join('');
        }

        // Payouts
        const payDiv = document.getElementById('refPayouts');
        if (!res.payouts?.length) {
            payDiv.innerHTML = '<p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">No payouts yet.</p>';
        } else {
            payDiv.innerHTML = res.payouts.map(p => {
                const statusLabels = { pending: 'Pending', completed: 'Completed', rejected: 'Rejected' };
                return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
                    <div>
                        <div style="font-size:13px;font-weight:500;">€${parseFloat(p.amount).toFixed(2)} → USDT</div>
                        <div style="font-size:11px;color:var(--text-3);">${new Date(p.created_at).toLocaleDateString('en-US', {day:'numeric',month:'short',year:'numeric'})}</div>
                    </div>
                    <span class="dd-status-badge ${p.status === 'completed' ? '' : p.status === 'rejected' ? 'danger' : 'warning'}">${statusLabels[p.status] || p.status}</span>
                </div>`;
            }).join('');
        }
    }

    function copyRefLink() {
        const input = document.getElementById('refLinkInput');
        navigator.clipboard.writeText(input.value).then(() => toast('success', 'Copied!', 'Referral link copied to clipboard'));
    }

    function copyRefCode() {
        const code = document.getElementById('refCodeDisplay').textContent;
        navigator.clipboard.writeText(code).then(() => toast('success', 'Copied!', 'Referral code copied'));
    }

    async function saveRefWallet() {
        const wallet = document.getElementById('refWallet').value.trim();
        if (!wallet || wallet.length < 10) { toast('error', 'Error', 'Enter a valid USDT wallet address'); return; }
        const res = await apiCall('/api/referral/wallet', { method: 'POST', body: JSON.stringify({ wallet }) });
        if (res?.success) toast('success', 'Saved', 'USDT wallet saved');
        else toast('error', 'Error', res?.error || 'Failed to save');
    }

    async function requestRefPayout() {
        if (!confirm('Request payout of your full balance in USDT?')) return;
        const btn = document.getElementById('refPayoutBtn');
        btn.disabled = true; btn.textContent = 'Processing...';
        const res = await apiCall('/api/referral/payout', { method: 'POST' });
        if (res?.success) {
            toast('success', 'Payout Requested', res.message);
            loadReferralData();
        } else {
            toast('error', 'Error', res?.error || 'Failed to request payout');
        }
        btn.disabled = false; btn.textContent = 'Request Payout';
    }

    // ══════════════════════════════════════════════
    // ECONOMIC CALENDAR
    // ══════════════════════════════════════════════
    const countryFlags = {
        'USD': '🇺🇸', 'EUR': '🇪🇺', 'GBP': '🇬🇧', 'JPY': '🇯🇵', 'AUD': '🇦🇺',
        'CAD': '🇨🇦', 'CHF': '🇨🇭', 'NZD': '🇳🇿', 'CNY': '🇨🇳', 'INR': '🇮🇳',
        'BRL': '🇧🇷', 'KRW': '🇰🇷', 'MXN': '🇲🇽', 'SGD': '🇸🇬', 'HKD': '🇭🇰',
        'TRY': '🇹🇷', 'ZAR': '🇿🇦', 'SEK': '🇸🇪', 'NOK': '🇳🇴', 'DKK': '🇩🇰',
        'PLN': '🇵🇱', 'CZK': '🇨🇿', 'HUF': '🇭🇺', 'RUB': '🇷🇺', 'ALL': '🌐'
    };

    // Sample calendar data (in production, fetch from an API like forex factory)
    let calendarData = [];
    let calendarFilter = 'all';
    let calendarDayOffset = 0;

    function generateCalendarData(dayOffset) {
        const date = new Date();
        date.setDate(date.getDate() + dayOffset);
        const events = [
            { time: '08:30', currency: 'EUR', title: 'ECB Interest Rate Decision', impact: 'high', actual: '', forecast: '4.50%', previous: '4.50%' },
            { time: '09:00', currency: 'EUR', title: 'CPI (YoY)', impact: 'high', actual: '', forecast: '2.6%', previous: '2.8%' },
            { time: '10:00', currency: 'GBP', title: 'GDP (QoQ)', impact: 'high', actual: '', forecast: '0.3%', previous: '0.1%' },
            { time: '10:30', currency: 'CHF', title: 'SNB Monetary Policy Assessment', impact: 'high', actual: '', forecast: '', previous: '' },
            { time: '13:30', currency: 'USD', title: 'Core CPI (MoM)', impact: 'high', actual: '', forecast: '0.3%', previous: '0.4%' },
            { time: '13:30', currency: 'USD', title: 'Initial Jobless Claims', impact: 'medium', actual: '', forecast: '218K', previous: '211K' },
            { time: '13:30', currency: 'USD', title: 'CPI (YoY)', impact: 'high', actual: '', forecast: '2.9%', previous: '3.1%' },
            { time: '14:00', currency: 'CAD', title: 'BoC Rate Statement', impact: 'high', actual: '', forecast: '', previous: '' },
            { time: '15:00', currency: 'USD', title: 'Existing Home Sales', impact: 'medium', actual: '', forecast: '3.95M', previous: '4.15M' },
            { time: '15:30', currency: 'USD', title: 'Natural Gas Storage', impact: 'low', actual: '', forecast: '-85B', previous: '-116B' },
            { time: '16:00', currency: 'USD', title: 'Crude Oil Inventories', impact: 'medium', actual: '', forecast: '-1.8M', previous: '-0.2M' },
            { time: '19:00', currency: 'USD', title: '10-Year Bond Auction', impact: 'low', actual: '', forecast: '', previous: '4.68%' },
            { time: '21:00', currency: 'NZD', title: 'RBNZ Interest Rate Decision', impact: 'high', actual: '', forecast: '4.25%', previous: '4.75%' },
            { time: '23:50', currency: 'JPY', title: 'Tankan Manufacturing Index', impact: 'medium', actual: '', forecast: '14', previous: '13' },
        ];
        // Shuffle slightly based on day to vary data
        const shift = dayOffset * 3;
        return events.slice(shift % 4).concat(events.slice(0, shift % 4));
    }

    function renderCalendar() {
        const events = generateCalendarData(calendarDayOffset);
        const filtered = calendarFilter === 'all' ? events : events.filter(e => e.impact === calendarFilter);
        const container = document.getElementById('calendarContent');

        if (filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-3);">No events match this filter.</div>';
            return;
        }

        container.innerHTML = filtered.map(e => `
            <div class="cal-event" data-impact="${e.impact}">
                <div class="cal-event-top">
                    <div class="cal-time">${e.time}</div>
                    <div class="cal-flag">${countryFlags[e.currency] || '🌐'}</div>
                    <div class="cal-impact ${e.impact}"></div>
                    <div class="cal-title">${e.title}</div>
                    <div class="cal-currency">${e.currency}</div>
                </div>
                <div class="cal-values-row">
                    <div class="cal-val">
                        <div class="cal-val-label">Actual</div>
                        <div class="cal-val-num">${e.actual || '—'}</div>
                    </div>
                    <div class="cal-val">
                        <div class="cal-val-label">Forecast</div>
                        <div class="cal-val-num">${e.forecast || '—'}</div>
                    </div>
                    <div class="cal-val">
                        <div class="cal-val-label">Previous</div>
                        <div class="cal-val-num">${e.previous || '—'}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function filterCalendar(impact) {
        calendarFilter = impact;
        document.querySelectorAll('.cal-filter').forEach(b => b.classList.remove('active'));
        document.querySelector(`.cal-filter[data-impact="${impact}"]`).classList.add('active');
        renderCalendar();
    }

    function loadCalendarDay(offset) {
        calendarDayOffset = offset;
        document.querySelectorAll('.cal-day-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.cal-day-tab')[offset].classList.add('active');
        renderCalendar();
    }

    // Set day tab labels
    (function initCalendarTabs() {
        const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        for (let i = 2; i <= 4; i++) {
            const d = new Date();
            d.setDate(d.getDate() + i);
            const el = document.getElementById('calDay' + i);
            if (el) el.textContent = days[d.getDay()] + ' ' + d.getDate();
        }
        renderCalendar();
    })();

    // ══════════════════════════════════════════════
    // AUTO REFRESH & SYNC
    // ══════════════════════════════════════════════

    // Full sync with MetaAPI (heavy, every 60s)
    async function autoSync() {
        try {
            const res = await apiCall('/api/broker/sync', { method: 'POST' });
            if (res?.success && res.synced > 0) {
                console.log(`🔄 Auto-sync: ${res.synced} trades synced`);
                // Refresh entire UI after new data arrives
                refreshDashboard();
            }
        } catch (e) { /* silent */ }
    }

    // Light refresh from DB only (fast, every 10s)
    async function refreshDashboard() {
        try {
            // Stats (from DB, instant)
            const stats = await apiCall('/api/stats');
            if (stats) {
                updateStats(stats);
                updatePerf(stats);
                updateRiskGuardian(stats);
            }

            // Trades (from DB, instant)
            const trades = await apiCall('/api/trades?limit=200');
            if (trades?.trades) {
                renderTradeList(trades.trades);
                drawMonthlyChart(trades.trades);
                drawAnalytics(trades.trades, stats);
                drawDrawdown(trades.trades);
                drawDailyPL(trades.trades);
            }

            // Equity (from DB snapshots)
            const activeDays = document.querySelector('.chart-range-btn.active');
            const days = activeDays ? parseInt(activeDays.textContent) || 30 : 30;
            const equity = await apiCall('/api/equity-history?days=' + days);
            if (equity?.history) drawEquityChart(equity.history);
        } catch (e) { /* silent */ }
    }

    // ══════════════════════════════════════════════
    // ADMIN PANEL
    // ══════════════════════════════════════════════
    const ADMIN_EMAILS = ['info@tieralba.com']; // Add your admin emails here
    let adminUsersCache = [];
    let currentEditUserId = null;

    function checkAdminAccess(email) {
        if (ADMIN_EMAILS.includes(email?.toLowerCase())) {
            document.getElementById('adminNavLabel').style.display = '';
            document.getElementById('adminNavItem').style.display = '';
        }
    }

    async function adminApiCall(endpoint, options = {}) {
        const token = getToken();
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
        try {
            const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
            if (res.status === 429) { console.warn(`Rate limited: ${endpoint}`); return null; }
            if (res.status === 401 || res.status === 403) { toast('error', 'Unauthorized', 'Admin access required'); return null; }
            const text = await res.text();
            try { return JSON.parse(text); } catch { console.error(`Invalid JSON from ${endpoint}`); return null; }
        } catch (err) {
            console.error(`Admin API error: ${endpoint}`, err);
            return null;
        }
    }

    async function loadAdminUsers() {
        const data = await adminApiCall('/api/admin/clients');
        if (!data?.users) return;
        adminUsersCache = data.users;

        // Stats
        document.getElementById('adminTotalUsers').textContent = data.stats?.total_users || data.users.length;
        document.getElementById('adminActiveServices').textContent = data.stats?.active_services || '—';
        document.getElementById('adminTotalRevenue').textContent = `€${data.stats?.total_revenue || 0}`;
        document.getElementById('adminMonthRevenue').textContent = `€${data.stats?.month_revenue || 0}`;

        renderAdminUsers(data.users);
        
        // Load purchases
        const purchases = await adminApiCall('/api/admin/purchases');
        if (purchases?.purchases) renderAdminPurchases(purchases.purchases);
    }

    function renderAdminUsers(users) {
        const tbody = document.getElementById('adminUsersBody');
        if (!users.length) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-3);">No clients found</td></tr>';
            return;
        }
        tbody.innerHTML = users.map(u => {
            const services = u.active_services || {};
            const badges = [];
            if (services.tierpass?.status === 'active') badges.push(`<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:rgba(200,169,78,0.1);color:var(--gold);margin-right:4px;">TP: ${services.tierpass.plan || '—'}</span>`);
            if (services.tierpass?.status === 'completed') badges.push(`<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:rgba(94,224,160,0.1);color:#5ee0a0;margin-right:4px;">TP ✓</span>`);
            if (services.tiermanage?.status === 'active') badges.push(`<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:rgba(100,180,255,0.1);color:#64b4ff;margin-right:4px;">TM: ${services.tiermanage.plan || '—'}</span>`);
            if (services.tiermanage?.status === 'completed') badges.push(`<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:rgba(94,224,160,0.1);color:#5ee0a0;margin-right:4px;">TM ✓</span>`);
            if (services.tradesalba?.status === 'active') badges.push(`<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;background:rgba(168,130,255,0.1);color:#a882ff;margin-right:4px;">TA: ${services.tradesalba.plan || '—'}</span>`);
            const serviceHtml = badges.length ? badges.join('') : '<span style="color:var(--text-3);font-size:11px;">No service</span>';
            const joined = u.created_at ? new Date(u.created_at).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' }) : '—';
            
            return `<tr style="border-bottom:1px solid var(--border);transition:background 0.2s;" onmouseover="this.style.background='var(--surface-2)'" onmouseout="this.style.background='transparent'">
                <td style="padding:10px 12px;">
                    <div style="font-weight:600;font-size:13px;">${u.name || '—'}</div>
                    <div style="font-size:11px;color:var(--text-3);">${u.email}</div>
                </td>
                <td style="padding:10px 12px;">
                    <span style="display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700;
                        background:${u.plan === 'pro' ? 'rgba(200,169,78,0.12)' : u.plan === 'standard' ? 'rgba(94,224,160,0.08)' : 'var(--surface-2)'};
                        color:${u.plan === 'pro' ? 'var(--gold)' : u.plan === 'standard' ? '#5ee0a0' : 'var(--text-3)'};">
                        ${(u.plan || 'free').charAt(0).toUpperCase() + (u.plan || 'free').slice(1)}
                    </span>
                </td>
                <td style="padding:10px 12px;">${serviceHtml}</td>
                <td style="padding:10px 12px;font-size:12px;color:var(--text-2);">${joined}</td>
                <td style="padding:10px 12px;text-align:center;">
                    <button onclick="openAdminEdit(${u.id})" style="padding:5px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);font-size:11px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--gold)';this.style.color='var(--gold)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text)'">
                        Edit
                    </button>
                </td>
            </tr>`;
        }).join('');
    }

    function renderAdminPurchases(purchases) {
        const tbody = document.getElementById('adminPurchasesBody');
        if (!purchases.length) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-3);">No purchases yet</td></tr>';
            return;
        }
        tbody.innerHTML = purchases.slice(0, 20).map(p => {
            const date = p.created_at ? new Date(p.created_at).toLocaleDateString('en-GB', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' }) : '—';
            const sColor = p.service === 'tierpass' ? 'var(--gold)' : p.service === 'tiermanage' ? '#64b4ff' : '#a882ff';
            return `<tr style="border-bottom:1px solid var(--border);">
                <td style="padding:10px 12px;font-size:12px;color:var(--text-2);">${date}</td>
                <td style="padding:10px 12px;font-size:13px;font-weight:500;">${p.email || '—'}</td>
                <td style="padding:10px 12px;"><span style="color:${sColor};font-weight:600;font-size:12px;">${p.service || '—'}</span></td>
                <td style="padding:10px 12px;font-size:12px;color:var(--text-2);">${p.plan_label || '—'}</td>
                <td style="padding:10px 12px;text-align:right;font-weight:700;font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--gold);">€${p.amount || 0}</td>
            </tr>`;
        }).join('');
    }

    function filterAdminUsers() {
        const q = document.getElementById('adminSearch').value.toLowerCase();
        const service = document.getElementById('adminFilterService').value;
        const status = document.getElementById('adminFilterStatus').value;
        
        let filtered = adminUsersCache;
        if (q) filtered = filtered.filter(u => (u.name || '').toLowerCase().includes(q) || (u.email || '').toLowerCase().includes(q));
        if (service) filtered = filtered.filter(u => u.active_services?.[service]);
        if (status === 'free') {
            filtered = filtered.filter(u => !u.active_services || Object.keys(u.active_services).length === 0);
        } else if (status) {
            filtered = filtered.filter(u => {
                const s = u.active_services || {};
                return Object.values(s).some(v => v.status === status);
            });
        }
        renderAdminUsers(filtered);
    }

    function openAdminEdit(userId) {
        const user = adminUsersCache.find(u => u.id === userId);
        if (!user) return;
        currentEditUserId = userId;
        const s = user.active_services || {};

        document.getElementById('adminModalUserName').textContent = user.name || '—';
        document.getElementById('adminModalUserEmail').textContent = user.email || '—';

        // Tier Pass
        document.getElementById('adminTpPlan').value = s.tierpass?.plan || '';
        document.getElementById('adminTpStat').value = s.tierpass?.status || 'active';
        updateStatusBadge('adminTpStatus', s.tierpass?.status);

        // Tier Manage
        document.getElementById('adminTmPlan').value = s.tiermanage?.plan || '';
        document.getElementById('adminTmStat').value = s.tiermanage?.status || 'active';
        updateStatusBadge('adminTmStatus', s.tiermanage?.status);

        // TradesAlba
        document.getElementById('adminTaPlan').value = s.tradesalba?.plan || '';
        document.getElementById('adminTaStat').value = s.tradesalba?.status || 'active';
        updateStatusBadge('adminTaStatus', s.tradesalba?.status);

        // Dashboard plan
        document.getElementById('adminDashPlan').value = user.plan || 'free';

        document.getElementById('adminSaveStatus').textContent = '';
        document.getElementById('adminServiceModal').style.display = 'flex';
    }

    function updateStatusBadge(id, status) {
        const el = document.getElementById(id);
        if (status === 'active') { el.textContent = 'Active'; el.style.background = 'rgba(94,224,160,0.1)'; el.style.color = '#5ee0a0'; }
        else if (status === 'completed') { el.textContent = 'Completed'; el.style.background = 'rgba(100,180,255,0.1)'; el.style.color = '#64b4ff'; }
        else if (status === 'expired') { el.textContent = 'Expired'; el.style.background = 'rgba(232,114,114,0.1)'; el.style.color = '#e87272'; }
        else { el.textContent = 'Inactive'; el.style.background = 'var(--surface-2)'; el.style.color = 'var(--text-3)'; }
    }

    async function saveAdminServices() {
        if (!currentEditUserId) return;
        const services = {};

        const tpPlan = document.getElementById('adminTpPlan').value;
        if (tpPlan) services.tierpass = { plan: tpPlan, status: document.getElementById('adminTpStat').value, updated_at: new Date().toISOString() };

        const tmPlan = document.getElementById('adminTmPlan').value;
        if (tmPlan) services.tiermanage = { plan: tmPlan, status: document.getElementById('adminTmStat').value, updated_at: new Date().toISOString() };

        const taPlan = document.getElementById('adminTaPlan').value;
        if (taPlan) services.tradesalba = { plan: taPlan, status: document.getElementById('adminTaStat').value, updated_at: new Date().toISOString() };

        const dashPlan = document.getElementById('adminDashPlan').value;

        const res = await adminApiCall('/api/admin/update-user', {
            method: 'POST',
            body: JSON.stringify({ userId: currentEditUserId, active_services: services, plan: dashPlan })
        });

        if (res?.success) {
            document.getElementById('adminSaveStatus').innerHTML = '<span style="color:#5ee0a0;">✓ Changes saved</span>';
            toast('success', 'Updated', 'Client services updated successfully');
            setTimeout(() => { document.getElementById('adminServiceModal').style.display = 'none'; loadAdminUsers(); }, 800);
        } else {
            document.getElementById('adminSaveStatus').innerHTML = `<span style="color:#e87272;">✗ ${res?.error || 'Failed to save'}</span>`;
        }
    }

    window.addEventListener('load', () => {
        loadDashboard();
        // Full MetaAPI sync every 2 minutes
        setInterval(autoSync, 120000);
        // Light DB refresh every 15 seconds
        setInterval(refreshDashboard, 15000);
        // Refresh signals every 30 seconds
        setInterval(loadSignals, 30000);
    });
</script>
    <!-- Upgrade Modal -->
    <div class="modal-overlay" id="upgradeModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Upgrade Required</div>
                <button class="modal-close" onclick="closeUpgradeModal()">&times;</button>
            </div>
            <div style="text-align:center;padding:1rem 0;">
                <div style="width:60px;height:60px;background:var(--gold-dim);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;margin-bottom:1rem;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                </div>
                <p style="font-size:15px;margin-bottom:0.5rem;">This feature requires a <strong id="upgradePlanName">Standard</strong> plan.</p>
                <p style="font-size:24px;font-weight:700;color:var(--gold);margin-bottom:1.5rem;" id="upgradePrice">€49.99<span style="font-size:14px;color:var(--text-3);font-weight:400;">/month</span></p>
                <button class="btn-primary" onclick="upgradePlan('standard')" id="upgradeStdBtn" style="width:100%;margin-bottom:0.5rem;">Upgrade
 to Standard — €49.99/mo</b
utton>
                <button class="btn-secondary" onclick="closeUpgradeModal()" style="width:100%;">Maybe Later</button>
            </div>
        </div>
    </div>

    <script>
    function closeUpgradeModal() {
        document.getElementById('upgradeModal').style.display = 'none';
    }
    function upgradePlan(plan) {
        window.location.href = '/api/checkout?plan=' + plan;
    }
    </script>
</body>
</html>
