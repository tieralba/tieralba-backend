<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TierAlba — Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Cormorant+Garamond:wght@500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #07080b;
            --surface: #0e0f14;
            --surface-2: #15161e;
            --surface-3: #1d1e28;
            --border: rgba(255,255,255,0.05);
            --border-hover: rgba(255,255,255,0.1);
            --gold: #d4b978;
            --gold-light: #f0dfa8;
            --gold-dim: rgba(212,185,120,0.10);
            --gold-glow: rgba(212,185,120,0.05);
            --text: #f4f1ea;
            --text-2: #a09b91;
            --text-3: #5c5952;
            --green: #5cb87a;
            --green-dim: rgba(92,184,122,0.10);
            --red: #e05252;
            --red-dim: rgba(224,82,82,0.10);
            --radius: 12px;
            --radius-lg: 16px;
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            position: relative;
            overflow-x: hidden;
        }

        html { overflow-x: hidden; }

        body::before {
            content: '';
            position: fixed;
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(212,185,120,0.04) 0%, transparent 70%);
            top: -100px; right: -100px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: ambientFloat 30s ease-in-out infinite;
        }

        @keyframes ambientFloat {
            0%,100% { transform: translate(0,0); }
            50% { transform: translate(-30px, 40px); }
        }

        /* ── Sidebar ── */
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 260px;
            height: 100vh;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 1.75rem 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar::after {
            content: '';
            position: absolute;
            top: 0; right: -1px;
            width: 1px; height: 100%;
            background: linear-gradient(180deg, transparent 5%, rgba(212,185,120,0.12) 50%, transparent 95%);
            pointer-events: none;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 1.5rem 1.75rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .logo-mark {
            width: 38px; height: 38px;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Cormorant Garamond', serif;
            font-weight: 700; font-size: 19px; color: var(--bg);
            box-shadow: 0 2px 12px rgba(212,185,120,0.2);
        }

        .logo-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 21px; font-weight: 700;
            letter-spacing: -0.3px;
        }

        .nav-menu { list-style: none; padding: 0.5rem 0.75rem; flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; }

        /* Custom scrollbar for sidebar */
        .nav-menu::-webkit-scrollbar { width: 3px; }
        .nav-menu::-webkit-scrollbar-track { background: transparent; }
        .nav-menu::-webkit-scrollbar-thumb { background: rgba(212,185,120,0.15); border-radius: 3px; }
        .nav-menu::-webkit-scrollbar-thumb:hover { background: rgba(212,185,120,0.3); }
        .nav-menu { scrollbar-width: thin; scrollbar-color: rgba(212,185,120,0.15) transparent; }

        .nav-item { margin-bottom: 2px; }

        .nav-link {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 14px;
            color: var(--text-2);
            text-decoration: none;
            font-size: 14px; font-weight: 500;
            border-radius: 8px;
            transition: all var(--transition);
            cursor: pointer;
        }

        .nav-link:hover { color: var(--text); background: var(--surface-2); }

        .nav-link.active {
            color: var(--gold);
            background: var(--gold-dim);
            box-shadow: inset 0 0 0 1px rgba(212,185,120,0.06);
        }

        .nav-link.nav-locked { opacity: 0.4; }
        .nav-link.nav-locked:hover { opacity: 0.6; }
        .lock-icon { margin-left: auto; opacity: 0.5; display: flex; }

        .nav-icon {
            width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.7;
        }

        .nav-link.active .nav-icon { opacity: 1; }

        .nav-icon svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 1.8; }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .user-card {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background var(--transition);
        }

        .user-card:hover { background: var(--surface-2); }

        .user-avatar {
            width: 34px; height: 34px;
            background: linear-gradient(135deg, var(--gold), #c5a855);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700; color: var(--bg);
            box-shadow: 0 2px 10px rgba(212,185,120,0.15);
        }

        .user-name { font-size: 13px; font-weight: 600; }
        .user-email { font-size: 11px; color: var(--text-3); }

        /* ── Main Layout ── */
        .main {
            margin-left: 260px;
            min-height: 100vh;
            padding: 2rem 2.5rem;
            transition: margin-left 0.3s;
            overflow-x: hidden;
            max-width: 100vw;
        }

        /* ── Topbar ── */
        .topbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem;
        }

        .topbar-left { display: flex; align-items: center; gap: 1rem; }

        .menu-toggle {
            display: none;
            width: 38px; height: 38px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            align-items: center; justify-content: center;
            cursor: pointer; color: var(--text); font-size: 18px;
        }

        .page-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px; font-weight: 600;
            letter-spacing: -0.5px;
        }

        .topbar-right { display: flex; align-items: center; gap: 0.75rem; }

        .btn-icon {
            width: 38px; height: 38px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-2);
            transition: all var(--transition);
            position: relative;
        }

        .btn-icon:hover { border-color: var(--border-hover); color: var(--text); }
        .btn-icon svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 1.8; }

        .btn-logout {
            padding: 8px 16px;
            background: none;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-2);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn-logout:hover { border-color: var(--red); color: var(--red); }

        /* ── Cards ── */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            transition: all var(--transition);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212,185,120,0.08), transparent);
        }

        .card:hover { border-color: var(--border-hover); }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.25rem;
        }

        .card-title {
            font-size: 15px; font-weight: 600;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ── Stats Grid ── */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.25rem 1.5rem;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212,185,120,0.15), transparent);
            opacity: 0;
            transition: opacity var(--transition);
        }

        .stat-card:hover {
            border-color: rgba(212,185,120,0.12);
            box-shadow: 0 4px 20px rgba(212,185,120,0.04), 0 0 0 1px rgba(212,185,120,0.06);
            transform: translateY(-2px);
        }

        .stat-card:hover::before { opacity: 1; }

        .stat-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'DM Mono', monospace;
            font-size: 28px;
            font-weight: 500;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
            background: linear-gradient(135deg, var(--text), rgba(244,241,234,0.8));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-3);
        }

        .stat-change.positive { color: var(--green); }
        .stat-change.negative { color: var(--red); }

        /* ── Chart Container ── */
        .chart-wrap {
            height: 300px;
            position: relative;
        }

        /* ── Grids ── */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        /* ── Content Sections ── */
        .section { display: none; }
        .section.active {
            display: block;
            animation: fadeIn 0.35s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ── Performance Items ── */
        .perf-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .perf-item {
            background: var(--surface-2);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            text-align: center;
        }

        .perf-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
        }

        .perf-value {
            font-family: 'DM Mono', monospace;
            font-size: 18px;
            font-weight: 500;
        }

        .perf-value.green { color: var(--green); }
        .perf-value.red { color: var(--red); }
        .perf-value.gold { color: var(--gold); }

        /* ── Broker Cards ── */
        .broker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .broker-card {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition);
        }

        .broker-card:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .broker-card.connected { border-color: var(--green); }

        .broker-icon {
            width: 42px; height: 42px;
            background: var(--surface-3);
            border-radius: 10px;
            display: inline-flex; align-items: center; justify-content: center;
            margin-bottom: 10px;
            color: var(--gold);
        }

        .broker-icon svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 1.8; }

        .broker-name {
            font-size: 14px; font-weight: 600;
            margin-bottom: 4px;
        }

        .broker-status {
            font-size: 11px; font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-3);
        }

        .broker-card.connected .broker-status { color: var(--green); }

        /* ── Calculator ── */
        .calc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group { margin-bottom: 1rem; }

        .form-label {
            display: block;
            font-size: 11px; font-weight: 600;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 11px 14px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px var(--gold-dim);
        }

        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--gold) 0%, #c5a855 50%, var(--gold-light) 100%);
            background-size: 200% 200%;
            border: none;
            border-radius: var(--radius);
            color: var(--bg);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .btn-primary:hover::before { transform: translateX(100%); }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(212,185,120,0.25);
            background-position: 100% 0;
        }

        .calc-result {
            background: var(--gold-dim);
            border: 1px solid rgba(200,170,110,0.2);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            margin-top: 1.25rem;
            display: none;
        }

        .calc-result.show { display: block; animation: fadeIn 0.3s ease; }

        .calc-result-label {
            font-size: 11px; font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .calc-result-value {
            font-family: 'DM Mono', monospace;
            font-size: 32px; font-weight: 500;
            color: var(--gold-light);
        }

        /* ── Referral ── */
        .referral-hero {
            background: var(--gold-dim);
            border: 1px solid rgba(200,170,110,0.15);
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            text-align: center;
        }

        .referral-hero h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px; margin-bottom: 0.75rem;
        }

        .referral-code {
            display: inline-block;
            padding: 12px 28px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: 'DM Mono', monospace;
            font-size: 20px; font-weight: 500;
            color: var(--gold);
            margin: 1.25rem 0;
            letter-spacing: 2px;
        }

        /* ── Modal ── */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center; justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 420px;
            max-width: 90vw;
        }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
        }

        .modal-close {
            width: 32px; height: 32px;
            background: var(--surface-2);
            border: none; border-radius: 6px;
            color: var(--text-2); font-size: 18px;
            cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            transition: all var(--transition);
        }

        .modal-close:hover { background: var(--surface-3); color: var(--text); }

        /* ── Toast ── */
        .toast-container {
            position: fixed; top: 1.5rem; right: 1.5rem;
            z-index: 300; display: flex;
            flex-direction: column; gap: 0.5rem;
        }

        .toast {
            background: rgba(14,15,20,0.95);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 18px;
            display: flex; gap: 10px;
            align-items: flex-start;
            min-width: 300px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.03);
            backdrop-filter: blur(12px);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.success { border-left: 3px solid var(--green); }
        .toast.error { border-left: 3px solid var(--red); }
        .toast.info { border-left: 3px solid var(--gold); }

        .toast-title { font-size: 13px; font-weight: 600; }
        .toast-msg { font-size: 12px; color: var(--text-2); }
        .toast-close {
            margin-left: auto; cursor: pointer;
            color: var(--text-3); font-size: 16px;
            line-height: 1;
        }
        .toast-close:hover { color: var(--text); }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ── Loading State ── */
        .skeleton {
            background: linear-gradient(90deg, var(--surface-2) 25%, rgba(212,185,120,0.04) 50%, var(--surface-2) 75%);
            background-size: 300% 100%;
            animation: shimmer 2s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 300% 0; }
            100% { background-position: -300% 0; }
        }

        /* ── Progress Bar (Challenge) ── */
        .progress-bar-bg {
            width: 100%;
            height: 10px;
            background: var(--surface-2);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        /* ── Drawdown Bars ── */
        .dd-bar-bg {
            width: 100%;
            height: 12px;
            background: var(--surface-2);
            border-radius: 12px;
            overflow: hidden;
        }

        .dd-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.6s ease, background 0.3s;
        }

        .dd-bar-fill.dd-safe { background: linear-gradient(90deg, #3a8a5c, var(--green)); }
        .dd-bar-fill.dd-warning { background: linear-gradient(90deg, #c89a2e, #e8b830); }
        .dd-bar-fill.dd-danger { background: linear-gradient(90deg, #c84040, var(--red)); }

        .dd-status-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--green-dim);
            color: var(--green);
        }

        .dd-status-badge.warning { background: rgba(232,184,48,0.12); color: #e8b830; }
        .dd-status-badge.danger { background: var(--red-dim); color: var(--red); }

        /* ── Equity Protector ── */
        .equity-protector {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
        }

        /* ── Toggle Switch ── */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input { opacity: 0; width: 0; height: 0; }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--surface-3);
            border-radius: 26px;
            transition: background 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px; height: 20px;
            left: 3px; bottom: 3px;
            background: var(--text-2);
            border-radius: 50%;
            transition: transform 0.3s, background 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider { background: var(--gold-dim); }
        .toggle-switch input:checked + .toggle-slider::before { transform: translateX(22px); background: var(--gold); }

        /* ── Bot Status ── */
        .bot-status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            padding: 5px 14px;
            border-radius: 20px;
            background: var(--surface-2);
            color: var(--text-2);
        }

        .bot-pulse {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--text-3);
        }

        .bot-pulse.online {
            background: var(--green);
            box-shadow: 0 0 0 3px rgba(92,184,122,0.2);
            animation: pulse 2s infinite;
        }

        .bot-pulse.offline {
            background: var(--red);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 3px rgba(92,184,122,0.2); }
            50% { box-shadow: 0 0 0 6px rgba(92,184,122,0.1); }
        }

        /* ── Panic Button ── */
        .panic-btn {
            padding: 16px 40px;
            background: linear-gradient(135deg, #c83030, #e05252);
            border: 2px solid rgba(224,82,82,0.3);
            border-radius: var(--radius);
            color: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .panic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(224,82,82,0.35);
        }

        .panic-btn:active { transform: translateY(0); }

        /* ── EA Download Cards ── */
        .ea-grid { display: flex; flex-direction: column; gap: 0.75rem; }
        .ea-card {
            display: flex; align-items: center; gap: 1rem;
            background: var(--surface-2); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem 1.25rem;
            transition: border-color var(--transition);
        }
        .ea-card:hover { border-color: var(--gold); }
        .ea-icon { color: var(--gold); flex-shrink: 0; }
        .ea-name { font-size: 14px; font-weight: 600; }
        .ea-meta { font-size: 12px; color: var(--text-3); margin-top: 2px; }
        .btn-small {
            padding: 7px 16px;
            background: var(--surface-3); border: 1px solid var(--border);
            border-radius: var(--radius); color: var(--text);
            font-family: 'DM Sans', sans-serif; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.8px; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-small:hover { background: var(--surface-2); border-color: rgba(212,185,120,0.3); color: var(--gold); }
        .btn-small.gold {
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: var(--bg); border: none; font-weight: 700; letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(212,185,120,0.25);
        }
        .btn-small.gold:hover { box-shadow: 0 6px 20px rgba(212,185,120,0.4); transform: translateY(-1px); }

        .btn-download {
            margin-left: auto;
            padding: 8px 18px;
            background: var(--gold-dim); border: 1px solid rgba(200,170,110,0.2);
            border-radius: var(--radius); color: var(--gold);
            font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-download:hover { background: var(--gold); color: var(--bg); }

        /* ── Setup Steps ── */
        .setup-steps { display: flex; flex-direction: column; gap: 0; }
        .setup-step {
            display: flex; align-items: flex-start; gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }
        .setup-step:last-child { border-bottom: none; }
        .step-num {
            width: 30px; height: 30px; flex-shrink: 0;
            background: var(--gold-dim); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700; color: var(--gold);
        }
        .step-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .step-desc { font-size: 13px; color: var(--text-2); line-height: 1.5; }

        /* ── Theme Toggle ── */
        .theme-toggle-btn {
            width: 38px; height: 38px;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-2); transition: all var(--transition);
        }
        .theme-toggle-btn:hover { border-color: var(--border-hover); color: var(--text); }
        .theme-toggle-btn svg { width: 18px; height: 18px; }

        /* ── Signal Cards ── */
        .signal-card {
            background: var(--surface-2); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem; margin-bottom: 0.75rem;
            transition: border-color var(--transition); overflow: hidden;
        }
        .signal-card:hover { border-color: var(--border-hover); }
        .signal-card.buy { border-left: 3px solid var(--green); }
        .signal-card.sell { border-left: 3px solid var(--red); }
        .signal-card.closed { opacity: 0.6; }
        .signal-header {
            display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;
        }
        .signal-dir {
            padding: 3px 10px; border-radius: 4px; font-size: 11px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        }
        .signal-dir.buy { background: var(--green-dim); color: var(--green); }
        .signal-dir.sell { background: var(--red-dim); color: var(--red); }
        .signal-symbol { font-size: 16px; font-weight: 700; }
        .signal-source {
            font-size: 10px; padding: 2px 8px; border-radius: 4px;
            background: var(--gold-dim); color: var(--gold); font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .signal-source.ea { background: rgba(92,184,122,0.1); color: var(--green); }
        .signal-time { font-size: 11px; color: var(--text-3); margin-left: auto; }
        .signal-prices {
            display: flex; gap: 0; margin-bottom: 8px;
            overflow: hidden; border-radius: 6px;
        }
        .signal-price {
            flex: 1; text-align: center; padding: 8px 4px;
            background: var(--surface-3);
            min-width: 0; position: relative; cursor: pointer;
            transition: background var(--transition);
        }
        .signal-price:hover { background: var(--surface-2); }
        .signal-price .copy-hint {
            display: none; position: absolute; top: -2px; right: 2px;
            font-size: 9px; color: var(--gold); font-weight: 600;
        }
        .signal-price:hover .copy-hint { display: block; }
        .signal-price.copied { background: rgba(212,185,120,0.15); }
        .signal-price:first-child { border-radius: 6px 0 0 6px; }
        .signal-price:last-child { border-radius: 0 6px 6px 0; }
        .signal-price-label {
            font-size: 9px; color: var(--text-3); text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 2px;
        }
        .signal-price-val {
            font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .signal-price-val.entry { color: var(--gold); }
        .signal-price-val.sl { color: var(--red); }
        .signal-price-val.tp { color: var(--green); }
        .signal-notes { font-size: 12px; color: var(--text-2); margin-top: 8px; font-style: italic; }
        .signal-result {
            display: inline-block; padding: 2px 10px; border-radius: 4px;
            font-size: 11px; font-weight: 700; text-transform: uppercase;
        }
        .signal-result.win { background: var(--green-dim); color: var(--green); }
        .signal-result.loss { background: var(--red-dim); color: var(--red); }
        .signal-result.be { background: var(--gold-dim); color: var(--gold); }

        @media (max-width: 640px) {
            .signal-time { margin-left: 0; width: 100%; margin-top: 4px; }
        }

        /* ── Calendar ── */
        .cal-filter {
            padding: 6px 14px; font-size: 11px; font-weight: 700;
            border: 1px solid var(--border); border-radius: 20px;
            background: none; color: var(--text-3); cursor: pointer;
            transition: all var(--transition); text-transform: uppercase; letter-spacing: 0.5px;
            font-family: 'DM Sans', sans-serif;
        }
        .cal-filter:hover { border-color: var(--gold); color: var(--gold); }
        .cal-filter.active { background: var(--gold-dim); border-color: var(--gold); color: var(--gold); }

        .cal-day-tab {
            padding: 7px 14px; font-size: 12px; font-weight: 600;
            border: 1px solid var(--border); border-radius: var(--radius);
            background: none; color: var(--text-2); cursor: pointer;
            transition: all var(--transition); font-family: 'DM Sans', sans-serif;
        }
        .cal-day-tab:hover { border-color: var(--gold); color: var(--gold); }
        .cal-day-tab.active { background: var(--gold-dim); border-color: var(--gold); color: var(--gold); }

        .cal-event {
            padding: 14px 0; border-bottom: 1px solid var(--border);
        }
        .cal-event:last-child { border-bottom: none; }
        .cal-event-top {
            display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
        }
        .cal-time {
            font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-3);
            min-width: 44px;
        }
        .cal-flag { font-size: 16px; }
        .cal-impact {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
        }
        .cal-impact.high { background: #e05252; box-shadow: 0 0 6px rgba(224,82,82,0.4); }
        .cal-impact.medium { background: #e8a830; box-shadow: 0 0 6px rgba(232,168,48,0.3); }
        .cal-impact.low { background: #c8aa6e; }
        .cal-title { font-size: 13px; font-weight: 600; flex: 1; }
        .cal-currency {
            font-size: 10px; color: var(--text-3); font-weight: 700;
            background: var(--surface-2); padding: 2px 8px; border-radius: 4px;
            letter-spacing: 0.5px;
        }
        .cal-values-row {
            display: flex; gap: 0; margin-left: 62px;
        }
        .cal-val {
            flex: 1; text-align: center;
            padding: 6px 4px;
            background: var(--surface-2); 
        }
        .cal-val:first-child { border-radius: 6px 0 0 6px; }
        .cal-val:last-child { border-radius: 0 6px 6px 0; }
        .cal-val-label { font-size: 9px; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .cal-val-num { font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500; }

        @media (max-width: 640px) {
            .cal-values-row { margin-left: 0; }
        }

        /* ── LIGHT MODE ── */
        body.light {
            --bg: #f7f5f0;
            --surface: #ffffff;
            --surface-2: #f0ede6;
            --surface-3: #e8e4dc;
            --border: rgba(0,0,0,0.07);
            --border-hover: rgba(0,0,0,0.14);
            --gold: #b89a50;
            --gold-light: #c8aa6e;
            --gold-dim: rgba(184,154,80,0.08);
            --gold-glow: rgba(184,154,80,0.04);
            --text: #1a1815;
            --text-2: #5c5952;
            --text-3: #9b978f;
            --green: #3a8a5c;
            --green-dim: rgba(58,138,92,0.08);
            --red: #c83030;
            --red-dim: rgba(200,48,48,0.08);
        }

        body.light .sidebar { background: #ffffff; border-right-color: rgba(0,0,0,0.08); }
        body.light .card { background: #ffffff; }
        body.light .stat-card { background: #ffffff; }
        body.light .nav-link.active { background: rgba(184,154,80,0.1); }
        body.light .perf-item { background: #f0ede6; }
        body.light .equity-protector { background: #f0ede6; }
        body.light .broker-card { background: #f0ede6; }
        body.light .form-input { background: #f0ede6; color: #1a1815; }
        body.light .modal { background: #ffffff; }
        body.light .toast { background: #ffffff; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        body.light .btn-primary { color: #ffffff; }
        body.light .panic-btn { box-shadow: 0 4px 16px rgba(200,48,48,0.2); }
        body.light .dd-status-badge { background: rgba(58,138,92,0.1); color: #3a8a5c; }
        body.light .bot-status-badge { background: #f0ede6; }
        body.light .ea-card { background: #f0ede6; }
        body.light .btn-download { background: rgba(184,154,80,0.1); }
        body.light .btn-download:hover { background: #b89a50; color: #ffffff; }
        body.light .theme-toggle-btn { background: #ffffff; }
        body.light .btn-logout { border-color: rgba(0,0,0,0.1); }
        body.light .user-card:hover { background: #f0ede6; }
        body.light .progress-bar-bg { background: #e8e4dc; }
        body.light .dd-bar-bg { background: #e8e4dc; }

        body.light .dark-only { display: none !important; }
        body.light .light-only { display: inline-block !important; }
        body:not(.light) .light-only { display: none !important; }

        /* ── Responsive ── */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main { margin-left: 0; }
            .menu-toggle { display: flex; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .perf-grid { grid-template-columns: repeat(2, 1fr); }
            .broker-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 640px) {
            .main { padding: 1rem; }
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 0.75rem; }
            .grid-2 { grid-template-columns: 1fr; }
            .grid-3 { grid-template-columns: 1fr; }
            .calc-grid { grid-template-columns: 1fr; }
            .perf-grid { grid-template-columns: 1fr 1fr; gap: 0.75rem; }
            .page-title { font-size: 20px; }
            .broker-grid { grid-template-columns: 1fr 1fr; }

            /* Fix card overflow */
            .card { padding: 1rem; overflow: hidden; }
            .stat-card { padding: 1rem 1.15rem; }
            .stat-value { font-size: 22px; }
            .stat-label { font-size: 11px; letter-spacing: 0.5px; }

            /* Fix signal prices overflow */
            .signal-prices { 
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 0;
            }
            .signal-price { padding: 6px 2px; }
            .signal-price-val { font-size: 11px; word-break: break-all; }
            .signal-price-label { font-size: 8px; }
            .signal-symbol { font-size: 14px; }
            .signal-card { padding: 0.75rem; }
            .signal-header { gap: 6px; }
            .signal-time { margin-left: 0; width: 100%; margin-top: 4px; }

            /* Fix Expert Advisor perf grid (4 cols → 2 cols) */
            .perf-item { padding: 0.75rem; }
            .perf-value { font-size: 15px; }
            .perf-label { font-size: 10px; letter-spacing: 0.5px; }

            /* Fix calendar values overflow */
            .cal-values-row { margin-left: 0; }
            .cal-val-num { font-size: 11px; }
            .cal-event-top { flex-wrap: wrap; gap: 6px; }
            .cal-title { font-size: 12px; min-width: 0; }
            .cal-time { min-width: 38px; font-size: 11px; }

            /* Fix referral hero */
            .referral-hero { padding: 1.5rem 1rem; }
            .referral-hero h2 { font-size: 20px; }
            .referral-code { font-size: 16px; padding: 10px 20px; letter-spacing: 1px; }

            /* Fix modal overflow */
            .modal { padding: 1.25rem; width: 95vw; }
            .modal-title { font-size: 18px; }

            /* Fix EA cards */
            .ea-card { flex-wrap: wrap; gap: 0.75rem; }
            .ea-card .btn-download { margin-left: 0; width: 100%; text-align: center; }

            /* Fix topbar */
            .topbar { flex-wrap: wrap; gap: 0.75rem; }
            .topbar-right { gap: 0.5rem; }

            /* Fix toast */
            .toast-container { left: 0.75rem; right: 0.75rem; top: 0.75rem; }
            .toast { min-width: auto; }

            /* Fix drawdown bars */
            .dd-bar-bg { height: 10px; }

            /* Fix setup steps */
            .setup-step { gap: 0.75rem; }
            .step-num { width: 26px; height: 26px; font-size: 12px; }

            /* Fix upgrade modal buttons */
            .btn-primary { padding: 11px 18px; font-size: 12px; letter-spacing: 1px; }

            /* Fix equity protector */
            .equity-protector { padding: 0.75rem 1rem; }

            /* Fix filter buttons wrapping */
            .cal-filter { padding: 5px 10px; font-size: 10px; }
            .cal-day-tab { padding: 6px 10px; font-size: 11px; }

            /* Panic button mobile */
            .panic-btn { padding: 14px 28px; font-size: 13px; letter-spacing: 1.5px; }

            /* Progress bar label */
            .progress-bar-bg { height: 8px; }
        }

        @media (max-width: 380px) {
            .main { padding: 0.75rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .perf-grid { grid-template-columns: 1fr 1fr; }
            .stat-value { font-size: 20px; }
            .signal-prices { 
                grid-template-columns: repeat(3, 1fr);
            }
            .signal-price-val { font-size: 10px; }
            .page-title { font-size: 18px; }
            .card-title { font-size: 13px; }
        }
    </style>
</head>
<body>

    <div class="toast-container" id="toastContainer"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <img class="logo-img logo-dark-only" src="data:image/png;base64,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" alt="TierAlba" style="width:36px;height:36px;border-radius:8px;"><img class="logo-img logo-light-only" src="data:image/png;base64,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" alt="TierAlba" style="width:36px;height:36px;border-radius:8px;display:none;">
            <div class="logo-text">TierAlba</div>
        </div>
        <nav style="flex:1;min-height:0;overflow:hidden;display:flex;flex-direction:column;">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-section="overview">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="signals">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
                        <span>Signals</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="riskguard">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
                        <span>Risk Guardian</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="experts">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="12" x2="6" y2="12"/><line x1="12" y1="12" x2="12" y2="12"/><line x1="18" y1="12" x2="18" y2="12"/><line x1="12" y1="2" x2="12" y2="6"/></svg></div>
                        <span>Experts</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="performance">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
                        <span>Performance</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="analytics">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
                        <span>Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="brokers">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></div>
                        <span>Broker</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="calculator">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="10" y2="14"/><line x1="14" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></svg></div>
                        <span>Calculator</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="indicators">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
                        <span>Indicators</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="calendar">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
                        <span>Calendar</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="referral">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
                        <span>Referral</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="refund">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></div>
                        <span>Refund</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" data-section="settings">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <div class="user-card" id="userCard">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div class="user-name" id="userName">User</div>
                    <div class="user-email" id="userEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bcd9d1ddd5d0fcc8d9cfc892dfd3d1">[email&#160;protected]</a></div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="main" id="mainContent">
        <div class="topbar">
            <div class="topbar-left">
                <div class="menu-toggle" id="menuToggle">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                </div>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="topbar-right">
                <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme">
                    <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
                <button class="btn-logout" onclick="logout()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 4px;"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Logout
                </button>
            </div>
        </div>

        <!-- ═══════ OVERVIEW ═══════ -->
        <div id="overview" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Equity</div>
                    <div class="stat-value" id="statEquity">—</div>
                    <div class="stat-change" id="statEquityChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value" id="statWinRate">—</div>
                    <div class="stat-change" id="statWinRateChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Profit Factor</div>
                    <div class="stat-value" id="statPF">—</div>
                    <div class="stat-change" id="statPFChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Profit</div>
                    <div class="stat-value" id="statProfit">—</div>
                    <div class="stat-change" id="statProfitChange">Loading...</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><span class="card-title">Equity Curve</span></div>
                    <div class="chart-wrap"><canvas id="equityChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Monthly Performance</span></div>
                    <div class="chart-wrap"><canvas id="monthlyChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ═══════ SIGNALS ═══════ -->
        <div id="signals" class="section">
            <!-- Signal Stats -->
            <div class="perf-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:1.25rem;">
                <div class="perf-item">
                    <div class="perf-label">Total Signals</div>
                    <div class="perf-value gold" id="sigStatTotal">0</div>
                </div>
                <div class="perf-item">
                    <div class="perf-label">Active</div>
                    <div class="perf-value" id="sigStatActive">0</div>
                </div>
                <div class="perf-item">
                    <div class="perf-label">Win Rate</div>
                    <div class="perf-value green" id="sigStatWR">0%</div>
                </div>
                <div class="perf-item">
                    <div class="perf-label">Record</div>
                    <div class="perf-value" id="sigStatRecord" style="font-size:14px;">0W — 0L</div>
                </div>
            </div>

            <!-- Signal List -->
            <div class="card">
                <div class="card-header" style="flex-wrap:wrap;gap:8px;">
                    <span class="card-title">Live Signals</span>
                    <div style="display:flex;gap:6px;">
                        <button class="cal-filter active" data-sigfilter="all" onclick="filterSignals('all')">All</button>
                        <button class="cal-filter" data-sigfilter="active" onclick="filterSignals('active')">Active</button>
                        <button class="cal-filter" data-sigfilter="closed" onclick="filterSignals('closed')">Closed</button>
                    </div>
                </div>
                <div id="signalsList" style="min-height:200px;">
                    <div style="text-align:center;padding:2rem;color:var(--text-3);">Loading signals...</div>
                </div>
            </div>
        </div>

        <!-- ═══════ RISK GUARDIAN ═══════ -->
        <div id="riskguard" class="section">
            <!-- Account Overview -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">Account Overview</span>
                    <span class="dd-status-badge" id="rgAccountBadge">NO ACCOUNT</span>
                </div>
                <div id="rgNoAccount" style="text-align:center;padding:2rem 0;color:var(--text-3);">
                    <p style="margin-bottom:1rem;">Connect a broker account to use Risk Guardian</p>
                    <button class="btn-primary" onclick="document.querySelector('[data-section=brokers]').click()">Connect Broker</button>
                </div>
                <div id="rgAccountInfo" style="display:none;">
                    <div class="perf-grid" style="grid-template-columns:repeat(4,1fr);">
                        <div class="perf-item">
                            <div class="perf-label">Balance</div>
                            <div class="perf-value gold" id="rgBalance">—</div>
                        </div>
                        <div class="perf-item">
                            <div class="perf-label">Equity</div>
                            <div class="perf-value" id="rgEquity">—</div>
                        </div>
                        <div class="perf-item">
                            <div class="perf-label">Today P&L</div>
                            <div class="perf-value" id="rgTodayPL">—</div>
                        </div>
                        <div class="perf-item">
                            <div class="perf-label">Open Trades</div>
                            <div class="perf-value" id="rgOpenTrades">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drawdown Monitor -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">Drawdown Monitor</span>
                    <span class="dd-status-badge" id="ddStatusBadge">SAFE</span>
                </div>
                <!-- Daily Drawdown -->
                <div style="margin-bottom:1.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-size:13px;font-weight:600;color:var(--text-2);">Daily Loss</span>
                        <span style="font-size:13px;font-weight:600;" id="ddDailyValue">0% / 5%</span>
                    </div>
                    <div class="dd-bar-bg">
                        <div class="dd-bar-fill dd-safe" id="ddDailyBar" style="width:0%"></div>
                    </div>
                </div>
                <!-- Max Drawdown -->
                <div style="margin-bottom:1.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-size:13px;font-weight:600;color:var(--text-2);">Max Total Drawdown</span>
                        <span style="font-size:13px;font-weight:600;" id="ddMaxValue">0% / 10%</span>
                    </div>
                    <div class="dd-bar-bg">
                        <div class="dd-bar-fill dd-safe" id="ddMaxBar" style="width:0%"></div>
                    </div>
                </div>
                <!-- Equity Protector -->
                <div class="equity-protector">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-size:14px;font-weight:600;">Equity Protector</div>
                            <div style="font-size:12px;color:var(--text-3);">Alert when you approach the daily drawdown limit</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="equityProtectorToggle" onchange="toggleEquityProtector()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="epSettings" style="display:none;margin-top:1rem;">
                        <div style="display:flex;gap:1rem;align-items:end;">
                            <div style="flex:1;">
                                <label class="form-label">Alert at daily loss (%)</label>
                                <input type="number" class="form-input" id="epLimit" value="4" step="0.5" min="1" max="10">
                            </div>
                            <button class="btn-primary" onclick="saveEquityProtector()">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Challenge Progress (optional) -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">Challenge Tracker</span>
                    <span style="font-size:12px;color:var(--gold);font-weight:600;" id="challengePhase">PHASE 1</span>
                </div>
                <div style="margin-bottom:1.25rem;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span style="font-size:13px;color:var(--text-2);">Profit Target</span>
                        <span style="font-size:13px;font-weight:600;" id="challengeTarget">$0 / $0</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="challengeProgress" style="width:0%"></div>
                    </div>
                    <div style="text-align:right;margin-top:4px;font-size:12px;color:var(--text-3);" id="challengePercent">0% completed</div>
                </div>
                <div class="perf-grid" style="grid-template-columns:repeat(3,1fr);">
                    <div class="perf-item">
                        <div class="perf-label">Total Profit</div>
                        <div class="perf-value green" id="challengeProfit">$0</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Win Rate</div>
                        <div class="perf-value gold" id="challengeWR">0%</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Status</div>
                        <div class="perf-value green" id="challengeStatus">—</div>
                    </div>
                </div>
            </div>

            <!-- Risk Settings -->
            <div class="card">
                <div class="card-header"><span class="card-title">Risk Settings</span></div>
                <p style="color:var(--text-2);font-size:13px;margin-bottom:1rem;">Set your risk limits. These are used to calculate drawdown bars and alerts.</p>
                <div class="calc-grid">
                    <div class="form-group">
                        <label class="form-label">Starting Capital ($)</label>
                        <input type="number" class="form-input" id="riskCapital" value="100000" step="1000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Profit Target (%)</label>
                        <input type="number" class="form-input" id="riskTarget" value="10" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Daily Drawdown (%)</label>
                        <input type="number" class="form-input" id="riskDailyDD" value="5" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Total Drawdown (%)</label>
                        <input type="number" class="form-input" id="riskMaxDD" value="10" step="0.5">
                    </div>
                </div>
                <div style="text-align:center;margin-top:0.5rem;">
                    <button class="btn-primary" onclick="saveRiskSettings()">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- ═══════ EXPERTS ═══════ -->
        <div id="experts" class="section">
            <!-- Bot Status -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">Expert Advisor Status</span>
                    <span class="bot-status-badge" id="botBadge">
                        <span class="bot-pulse" id="botPulse"></span>
                        <span id="botStatusText">Checking...</span>
                    </span>
                </div>
                <div class="perf-grid" style="grid-template-columns:repeat(4,1fr);">
                    <div class="perf-item">
                        <div class="perf-label">EA Status</div>
                        <div class="perf-value" id="botEAStatus" style="font-size:15px;">—</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Connection</div>
                        <div class="perf-value" id="botConnection" style="font-size:15px;">—</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Open Trades</div>
                        <div class="perf-value" id="botOpenTrades" style="font-size:15px;">0</div>
                    </div>
                    <div class="perf-item">
                        <div class="perf-label">Last Heartbeat</div>
                        <div class="perf-value" id="botLastBeat" style="font-size:15px;">—</div>
                    </div>
                </div>
            </div>

            <!-- License Keys -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">Your License Keys</span>
                    <button class="btn-small gold" onclick="generateLicenseKeys()" id="btnGenLicense">Generate Keys</button>
                </div>
                <p style="color:var(--text-2);margin-bottom:1rem;font-size:14px;">Your unique license keys for EA activation. Copy and paste into the EA settings on MetaTrader 5.</p>
                <div id="licenseKeysContainer">
                    <div style="text-align:center;padding:2rem 0;color:var(--text-3);">Loading licenses...</div>
                </div>
            </div>

            <!-- EA Downloads -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Download Expert Advisors</span></div>
                <p style="color:var(--text-2);margin-bottom:1.5rem;font-size:14px;">Download and install our proprietary EAs on your MetaTrader 5 platform.</p>
                <div class="ea-grid">
                    <div class="ea-card">
                        <div class="ea-icon" style="color:var(--gold);"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 18 15 15"/></svg></div>
                        <div>
                            <div class="ea-name">Tier Algo Gold</div>
                            <div class="ea-meta">MetaTrader 5 · .ex5 · XAUUSD</div>
                        </div>
                        <button class="btn-download" onclick="downloadEA('Tier_Algo_Gold.ex5')">Download</button>
                    </div>
                    <div class="ea-card">
                        <div class="ea-icon" style="color:var(--gold);"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 18 15 15"/></svg></div>
                        <div>
                            <div class="ea-name">Tier Algo US100</div>
                            <div class="ea-meta">MetaTrader 5 · .ex5 · NAS100</div>
                        </div>
                        <button class="btn-download" onclick="downloadEA('Tier_Algo_us100.ex5')">Download</button>
                    </div>
                </div>
            </div>

            <!-- Setup Guide -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Setup Guide</span></div>
                <div class="setup-steps">
                    <div class="setup-step">
                        <div class="step-num">1</div>
                        <div>
                            <div class="step-title">Generate your License Keys</div>
                            <div class="step-desc">Click "Generate Keys" above. You'll get a unique key for each EA.</div>
                        </div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">2</div>
                        <div>
                            <div class="step-title">Download the EA files</div>
                            <div class="step-desc">Download Tier Algo Gold (.ex5) and/or Tier Algo US100 (.ex5) above.</div>
                        </div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">3</div>
                        <div>
                            <div class="step-title">Copy EA to MetaTrader</div>
                            <div class="step-desc">In MT5: File → Open Data Folder → MQL5 → Experts → paste the .ex5 file.</div>
                        </div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">4</div>
                        <div>
                            <div class="step-title">Allow Web Requests</div>
                            <div class="step-desc">In MT5: Tools → Options → Expert Advisors → Check "Allow WebRequest" and add your server URL.</div>
                        </div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">5</div>
                        <div>
                            <div class="step-title">Attach & Enter License Key</div>
                            <div class="step-desc">Drag the EA onto a chart. In the Inputs tab, paste your License Key. Enable AutoTrading. ✅</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panic Button -->
            <div class="card">
                <div class="card-header"><span class="card-title">Emergency Control</span></div>
                <div style="text-align:center;padding:1.5rem 0;">
                    <p style="color:var(--text-2);margin-bottom:1.5rem;font-size:14px;">Close all trades and stop the EA immediately</p>
                    <button class="panic-btn" onclick="panicButton()">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-4px;margin-right:8px;"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        PANIC — CLOSE ALL
                    </button>
                    <p style="color:var(--text-3);margin-top:1rem;font-size:12px;">This action is irreversible. All open trades will be closed at market price.</p>
                </div>
            </div>
        </div>

        <!-- ═══════ PERFORMANCE ═══════ -->
        <div id="performance" class="section">
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Detailed Statistics</span></div>
                <div class="perf-grid" id="perfGrid">
                    <div class="perf-item"><div class="perf-label">Total Trades</div><div class="perf-value" id="perfTotal">—</div></div>
                    <div class="perf-item"><div class="perf-label">Winners</div><div class="perf-value green" id="perfWins">—</div></div>
                    <div class="perf-item"><div class="perf-label">Losers</div><div class="perf-value red" id="perfLosses">—</div></div>
                    <div class="perf-item"><div class="perf-label">Win Rate</div><div class="perf-value gold" id="perfWR">—</div></div>
                    <div class="perf-item"><div class="perf-label">Profit Factor</div><div class="perf-value gold" id="perfPF">—</div></div>
                    <div class="perf-item"><div class="perf-label">Avg Profit</div><div class="perf-value green" id="perfAvg">—</div></div>
                    <div class="perf-item"><div class="perf-label">Best Trade</div><div class="perf-value green" id="perfBest">—</div></div>
                    <div class="perf-item"><div class="perf-label">Worst Trade</div><div class="perf-value red" id="perfWorst">—</div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">Drawdown</span></div>
                <div class="chart-wrap"><canvas id="drawdownChart"></canvas></div>
            </div>
        </div>

        <!-- ═══════ ANALYTICS ═══════ -->
        <div id="analytics" class="section">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><span class="card-title">Trade Distribution</span></div>
                    <div class="chart-wrap"><canvas id="distributionChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Hourly Activity</span></div>
                    <div class="chart-wrap"><canvas id="hourlyChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- ═══════ BROKERS ═══════ -->
        <div id="brokers" class="section">
            <div class="card" style="margin-bottom:1.5rem;" id="connectedBrokerCard" style="display:none;">
                <div class="card-header">
                    <span class="card-title">Connected Account</span>
                    <span class="dd-status-badge" id="brokerConnBadge">Not Connected</span>
                </div>
                <div id="connectedBrokerInfo" style="display:none;">
                    <div class="perf-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:1rem;">
                        <div class="perf-item"><div class="perf-label">Account</div><div class="perf-value" id="connAccNum" style="font-size:15px;">—</div></div>
                        <div class="perf-item"><div class="perf-label">Platform</div><div class="perf-value gold" id="connPlatform" style="font-size:15px;">—</div></div>
                        <div class="perf-item"><div class="perf-label">Broker</div><div class="perf-value" id="connBroker" style="font-size:15px;">—</div></div>
                    </div>
                    <div style="text-align:center;">
                        <button class="btn-primary" onclick="syncBrokerData()" style="margin-right:8px;">Sync Now</button>
                        <button class="btn-logout" onclick="disconnectBroker()">Disconnect</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">Connect Trading Account</span></div>
                <p style="color:var(--text-2);margin-bottom:1.5rem;font-size:14px;">Connect your MT4/MT5 account using your investor password. Read-only — we never place trades.</p>
                <div class="broker-grid">
                    <div class="broker-card" data-platform="mt4" onclick="openBrokerModal('MetaTrader 4','mt4')">
                        <div class="broker-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg></div>
                        <div class="broker-name">MetaTrader 4</div>
                        <div class="broker-status">Connect</div>
                    </div>
                    <div class="broker-card" data-platform="mt5" onclick="openBrokerModal('MetaTrader 5','mt5')">
                        <div class="broker-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg></div>
                        <div class="broker-name">MetaTrader 5</div>
                        <div class="broker-status">Connect</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════ CALCULATOR ═══════ -->
        <div id="calculator" class="section">
            <div class="card">
                <div class="card-header"><span class="card-title">Position Size Calculator</span></div>
                <div class="calc-grid">
                    <div class="form-group">
                        <label class="form-label">Account Size (€)</label>
                        <input type="number" class="form-input" id="calcAccount" value="10000" step="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Risk per Trade (%)</label>
                        <input type="number" class="form-input" id="calcRisk" value="1" step="0.1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Entry Price</label>
                        <input type="number" class="form-input" id="calcEntry" value="1.0850" step="0.0001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stop Loss</label>
                        <input type="number" class="form-input" id="calcSL" value="1.0800" step="0.0001">
                    </div>
                </div>
                <div style="text-align:center;margin-top:0.5rem;">
                    <button class="btn-primary" onclick="calculatePosition()">Calculate Position Size</button>
                </div>
                <div class="calc-result" id="calcResult">
                    <div class="calc-result-label">Optimal Position Size</div>
                    <div class="calc-result-value" id="calcLots">0.00 Lots</div>
                    <div style="margin-top:1rem;">
                        <div class="perf-grid" style="grid-template-columns:repeat(3,1fr);">
                            <div class="perf-item"><div class="perf-label">Risk</div><div class="perf-value gold" id="calcRiskAmt">€0</div></div>
                            <div class="perf-item"><div class="perf-label">Pips</div><div class="perf-value" id="calcPips">0</div></div>
                            <div class="perf-item"><div class="perf-label">R:R 1:2</div><div class="perf-value green" id="calcProfit">€0</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════ INDICATORS ═══════ -->
        <div id="indicators" class="section">
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header">
                    <span class="card-title">TradingView Indicators</span>
                    <span class="dd-status-badge" id="indicatorPlanBadge">FREE</span>
                </div>
                <p style="color:var(--text-2);margin-bottom:1.5rem;font-size:14px;">Access our proprietary TradingView indicators. Standard gets 1 indicator, Pro gets all 3.</p>
                
                <div class="ea-grid" id="indicatorsList">
                    <!-- Indicator 1 - Standard + Pro -->
                    <div class="ea-card indicator-card" data-plan="standard" id="indicator1">
                        <div class="ea-icon"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
                        <div style="flex:1;">
                            <div class="ea-name">TierAlba Trend Pro</div>
                            <div class="ea-meta">Multi-timeframe trend detection · All pairs</div>
                            <div class="indicator-invite" style="margin-top:8px;display:none;" id="invite1">
                                <div class="form-label" style="margin-bottom:4px;">Your TradingView Username</div>
                                <div style="display:flex;gap:8px;">
                                    <input type="text" class="form-input" id="tvUser1" placeholder="e.g. trader123" style="flex:1;padding:8px 12px;font-size:13px;">
                                    <button class="btn-download" onclick="requestIndicatorAccess(1)">Request Access</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn-download" onclick="toggleInvite(1)" id="inviteBtn1">Get Access</button>
                    </div>

                    <!-- Indicator 2 - Pro only -->
                    <div class="ea-card indicator-card" data-plan="pro" id="indicator2">
                        <div class="ea-icon"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                        <div style="flex:1;">
                            <div class="ea-name">TierAlba Scalper AI</div>
                            <div class="ea-meta">AI-powered scalping signals · M5-M15 timeframes</div>
                            <div class="indicator-invite" style="margin-top:8px;display:none;" id="invite2">
                                <div class="form-label" style="margin-bottom:4px;">Your TradingView Username</div>
                                <div style="display:flex;gap:8px;">
                                    <input type="text" class="form-input" id="tvUser2" placeholder="e.g. trader123" style="flex:1;padding:8px 12px;font-size:13px;">
                                    <button class="btn-download" onclick="requestIndicatorAccess(2)">Request Access</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn-download" onclick="toggleInvite(2)" id="inviteBtn2">Get Access</button>
                    </div>

                    <!-- Indicator 3 - Pro only -->
                    <div class="ea-card indicator-card" data-plan="pro" id="indicator3">
                        <div class="ea-icon"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg></div>
                        <div style="flex:1;">
                            <div class="ea-name">TierAlba Smart Grid</div>
                            <div class="ea-meta">Support & resistance grid · Auto S/R levels</div>
                            <div class="indicator-invite" style="margin-top:8px;display:none;" id="invite3">
                                <div class="form-label" style="margin-bottom:4px;">Your TradingView Username</div>
                                <div style="display:flex;gap:8px;">
                                    <input type="text" class="form-input" id="tvUser3" placeholder="e.g. trader123" style="flex:1;padding:8px 12px;font-size:13px;">
                                    <button class="btn-download" onclick="requestIndicatorAccess(3)">Request Access</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn-download" onclick="toggleInvite(3)" id="inviteBtn3">Get Access</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">How It Works</span></div>
                <div class="setup-steps">
                    <div class="setup-step">
                        <div class="step-num">1</div>
                        <div><div class="step-title">Click "Get Access"</div><div class="step-desc">Enter your TradingView username for the indicator you want.</div></div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">2</div>
                        <div><div class="step-title">We Invite You</div><div class="step-desc">Our team will add your username to the indicator's access list within 24 hours.</div></div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">3</div>
                        <div><div class="step-title">Start Using</div><div class="step-desc">Open TradingView, go to Indicators → Invite-Only, and you'll find your indicators there.</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════ ECONOMIC CALENDAR ═══════ -->
        <div id="calendar" class="section">
            <div class="card">
                <div class="card-header" style="flex-wrap:wrap;gap:8px;">
                    <span class="card-title">Economic Calendar</span>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        <button class="cal-filter active" data-impact="all" onclick="filterCalendar('all')">All</button>
                        <button class="cal-filter" data-impact="high" onclick="filterCalendar('high')">High</button>
                        <button class="cal-filter" data-impact="medium" onclick="filterCalendar('medium')">Med</button>
                        <button class="cal-filter" data-impact="low" onclick="filterCalendar('low')">Low</button>
                    </div>
                </div>
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:1.25rem;">
                    <button class="cal-day-tab active" onclick="loadCalendarDay(0)">Today</button>
                    <button class="cal-day-tab" onclick="loadCalendarDay(1)">Tomorrow</button>
                    <button class="cal-day-tab" onclick="loadCalendarDay(2)" id="calDay2">—</button>
                    <button class="cal-day-tab" onclick="loadCalendarDay(3)" id="calDay3">—</button>
                    <button class="cal-day-tab" onclick="loadCalendarDay(4)" id="calDay4">—</button>
                </div>
                <div id="calendarContent" style="min-height:200px;">
                    <div style="text-align:center;padding:2rem;color:var(--text-3);">Loading...</div>
                </div>
            </div>
        </div>

        <!-- ═══════ REFERRAL ═══════ -->
        <div id="referral" class="section">
            <!-- Stats -->
            <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:1.5rem;">
                <div class="stat-card">
                    <div class="stat-label">Available Balance</div>
                    <div class="stat-value" style="color:var(--green);" id="refBalance">€0.00</div>
                    <div class="stat-change" id="refBalanceNote">Min. €50 for payout</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Earned</div>
                    <div class="stat-value" style="color:var(--gold);" id="refTotalEarned">€0.00</div>
                    <div class="stat-change positive">Lifetime earnings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Referrals</div>
                    <div class="stat-value" id="refTotalReferrals">0</div>
                    <div class="stat-change">People you invited</div>
                </div>
            </div>

            <!-- Referral Link -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Your Referral Link</span></div>
                <p style="color:var(--text-2);font-size:13px;margin-bottom:1rem;">Share your link and earn <strong style="color:var(--gold);">15% commission</strong> on every purchase made by people you refer.</p>
                <div style="display:flex;gap:8px;margin-bottom:1rem;">
                    <input type="text" class="form-input" id="refLinkInput" readonly style="font-size:13px;flex:1;">
                    <button class="btn-primary" onclick="copyRefLink()" style="white-space:nowrap;">Copy Link</button>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <span style="font-size:12px;color:var(--text-3);">Your code:</span>
                    <span class="referral-code" id="refCodeDisplay" style="padding:8px 20px;font-size:16px;margin:0;">—</span>
                    <button class="btn-download" onclick="copyRefCode()">Copy Code</button>
                </div>
            </div>

            <!-- How it works -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">How It Works</span></div>
                <div class="setup-steps">
                    <div class="setup-step">
                        <div class="step-num">1</div>
                        <div><div class="step-title">Share Your Link</div><div class="step-desc">Send your referral link or code to friends, on social media, or in trading communities.</div></div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">2</div>
                        <div><div class="step-title">They Sign Up & Subscribe</div><div class="step-desc">When someone registers using your link and purchases any plan, you earn a commission.</div></div>
                    </div>
                    <div class="setup-step">
                        <div class="step-num">3</div>
                        <div><div class="step-title">Get Paid in USDT</div><div class="step-desc">Request a payout when your balance reaches €50. We send USDT to your wallet within 48 hours.</div></div>
                    </div>
                </div>
            </div>

            <!-- Wallet & Payout -->
            <div class="grid-2" style="margin-bottom:1.5rem;">
                <div class="card">
                    <div class="card-header"><span class="card-title">USDT Wallet</span></div>
                    <div class="form-group" style="margin-bottom:0.75rem;">
                        <label class="form-label">Your USDT Wallet Address (TRC20)</label>
                        <input type="text" class="form-input" id="refWallet" placeholder="e.g. TXyz...abc">
                    </div>
                    <button class="btn-primary" onclick="saveRefWallet()" style="width:100%;">Save Wallet</button>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Request Payout</span></div>
                    <div style="text-align:center;padding:0.5rem 0;">
                        <p style="font-size:13px;color:var(--text-2);margin-bottom:1rem;">Available: <strong style="color:var(--green);" id="refPayoutBalance">€0.00</strong></p>
                        <button class="btn-primary" onclick="requestRefPayout()" id="refPayoutBtn" style="width:100%;">Request Payout</button>
                        <p style="font-size:11px;color:var(--text-3);margin-top:8px;">Minimum €50 · Paid in USDT (TRC20) · 48h processing</p>
                    </div>
                </div>
            </div>

            <!-- Commission History -->
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Commission History</span></div>
                <div id="refCommissions" style="min-height:60px;">
                    <p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">Loading...</p>
                </div>
            </div>

            <!-- Payout History -->
            <div class="card">
                <div class="card-header"><span class="card-title">Payout History</span></div>
                <div id="refPayouts" style="min-height:60px;">
                    <p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- ═══════ REFUND ═══════ -->
        <div id="refund" class="section">
            <div class="card" style="margin-bottom:1.5rem;">
                <div class="card-header"><span class="card-title">Request a Refund</span></div>
                <p style="color:var(--text-2);margin-bottom:1.5rem;font-size:14px;">Submit a refund request within 7 days of your purchase. Our team will review it within 48 hours.</p>
                
                <div id="refundForm">
                    <div class="form-group">
                        <label class="form-label">Reason for Refund</label>
                        <select class="form-input" id="refundReason" style="font-family:'DM Sans',sans-serif;">
                            <option value="">Select a reason...</option>
                            <option value="not_as_expected">Product not as expected</option>
                            <option value="technical_issues">Technical issues</option>
                            <option value="no_longer_needed">No longer needed</option>
                            <option value="duplicate_charge">Duplicate charge</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Additional Details (optional)</label>
                        <textarea class="form-input" id="refundDetails" rows="4" placeholder="Please describe your issue..." style="font-family:'DM Sans',sans-serif;resize:vertical;"></textarea>
                    </div>
                    <button class="btn-primary" onclick="submitRefund()" id="refundBtn">Submit Refund Request</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">Your Refund History</span></div>
                <div id="refundHistory" style="min-height:60px;">
                    <p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- ═══════ SETTINGS ═══════ -->
        <div id="settings" class="section">
            <div class="card">
                <div class="card-header"><span class="card-title">Account</span></div>
                <div class="perf-grid">
                    <div class="perf-item"><div class="perf-label">Plan</div><div class="perf-value gold" id="settingsPlan">Free</div></div>
                    <div class="perf-item"><div class="perf-label">Email</div><div class="perf-value" id="settingsEmail" style="font-size:14px;">—</div></div>
                    <div class="perf-item"><div class="perf-label">Member since</div><div class="perf-value" id="settingsDate" style="font-size:14px;">—</div></div>
                    <div class="perf-item"><div class="perf-label">Status</div><div class="perf-value green">Active</div></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Broker Modal -->
    <div class="modal-overlay" id="brokerModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Connect Broker</div>
                <button class="modal-close" onclick="closeBrokerModal()">&times;</button>
            </div>
            <p style="color:var(--text-2);font-size:13px;margin-bottom:1.25rem;">Connect your trading account using your <strong>investor password</strong> (read-only). Your trades and equity will sync automatically.</p>
            <div class="form-group">
                <label class="form-label">Account Number</label>
                <input type="text" class="form-input" id="modalAccount" placeholder="e.g. 12345678">
            </div>
            <div class="form-group">
                <label class="form-label">Investor Password (read-only)</label>
                <input type="password" class="form-input" id="modalInvestorPwd" placeholder="Your investor/viewer password">
            </div>
            <div class="form-group">
                <label class="form-label">Broker Server</label>
                <input type="text" class="form-input" id="modalBrokerName" placeholder="e.g. ICMarketsSC-Demo, FTMODemo-Server">
                <div style="font-size:11px;color:var(--text-3);margin-top:4px;">Find this in MetaTrader → File → Login → Server name</div>
            </div>
            <button class="btn-primary" onclick="connectBroker()" id="connectBrokerBtn" style="width:100%;">Connect Account</button>
        </div>
    </div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // ══════════════════════════════════════════════
    // CONFIG
    // ══════════════════════════════════════════════
    const API_URL = window.location.origin;
    let selectedPlatform = 'mt4';

    // ══════════════════════════════════════════════
    // AUTH
    // ══════════════════════════════════════════════
    function getToken() { return localStorage.getItem('auth_token'); }
    function getUserData() { try { return JSON.parse(localStorage.getItem('user_data')); } catch { return null; } }

    function logout() {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_data');
        window.location.href = 'login.html';
    }

    // Auth check
    if (!getToken()) { window.location.href = 'login.html'; }

    async function apiCall(endpoint, options = {}) {
        const token = getToken();
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        try {
            const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
            if (res.status === 401 || res.status === 403) { logout(); return null; }
            return await res.json();
        } catch (err) {
            console.error(`API error: ${endpoint}`, err);
            return null;
        }
    }

    // ══════════════════════════════════════════════
    // NAVIGATION
    // ══════════════════════════════════════════════
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.section');
    const pageTitle = document.getElementById('pageTitle');

    navLinks.forEach(link => {
        link.addEventListener('click', () => {
            const target = link.dataset.section;
            const allowed = planAccess[userPlan] || planAccess.free;
            
            if (!allowed.includes(target)) {
                const requiredPlan = planAccess.pro.includes(target) && !planAccess.standard.includes(target) ? 'pro' : 'standard';
                showUpgradeModal(requiredPlan);
                return;
            }
            
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            sections.forEach(s => s.classList.remove('active'));
            document.getElementById(target)?.classList.add('active');
            pageTitle.textContent = link.querySelector('span').textContent;
            document.getElementById('sidebar').classList.remove('open');

            // Load license keys when entering experts section
            if (target === 'experts') loadLicenseKeys();
        });
    });

    document.getElementById('menuToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('open');
    });

    // ══════════════════════════════════════════════
    // TOAST
    // ══════════════════════════════════════════════
    function toast(type, title, msg) {
        const container = document.getElementById('toastContainer');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerHTML = `<div><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div><div class="toast-close" onclick="this.parentElement.remove()">&times;</div>`;
        container.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 4000);
    }

    // ══════════════════════════════════════════════
    // CHARTS CONFIG
    // ══════════════════════════════════════════════
    const chartDefaults = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: '#1a1b25',
                titleColor: '#c8aa6e',
                bodyColor: '#f0ede6',
                borderColor: 'rgba(255,255,255,0.06)',
                borderWidth: 1,
                padding: 10,
                cornerRadius: 8
            }
        },
        scales: {
            y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#5c5952', font: { size: 11 } } },
            x: { grid: { display: false }, ticks: { color: '#5c5952', font: { size: 11 } } }
        }
    };

    let charts = {};

    // ══════════════════════════════════════════════
    // LOAD DATA
    // ══════════════════════════════════════════════
    async function loadDashboard() {
        // User info
        const user = getUserData();
        if (user) {
            const initials = (user.name || user.email || 'U').substring(0, 2).toUpperCase();
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('userName').textContent = user.name || user.email?.split('@')[0] || 'Utente';
            document.getElementById('userEmail').textContent = user.email || '';
            document.getElementById('settingsEmail').textContent = user.email || '—';
        }

        // Verify token
        const me = await apiCall('/api/auth/me');
        if (!me) return;

        if (me.user?.created_at) {
            document.getElementById('settingsDate').textContent = new Date(me.user.created_at).toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // Load stats
        const stats = await apiCall('/api/stats');
        if (stats) {
            updateStats(stats);
            updatePerf(stats);
        }

        // Load equity history
        const equity = await apiCall('/api/equity-history?days=30');
        if (equity?.history) drawEquityChart(equity.history);

        // Load trades
        const trades = await apiCall('/api/trades?limit=200');
        if (trades?.trades) {
            drawMonthlyChart(trades.trades);
            drawAnalytics(trades.trades, stats);
            drawDrawdown(trades.trades);
        }

        toast('success', 'Dashboard', `Welcome, ${user?.name || 'user'}!`);

        // Load new features
        updateRiskGuardian(stats);
        updateBotStatus();

        // Apply plan gating
        const planData = await apiCall('/api/user/plan');
        const plan = planData?.plan || me.user?.plan || 'free';
        applyPlanGating(plan);
        applyIndicatorGating(plan);
        loadRefundHistory();
        loadReferralData();
        loadSignals();

        // Check for upgrade success
        if (window.location.search.includes('upgrade=success')) {
            toast('success', 'Upgrade Complete', 'Your plan has been upgraded!');
            window.history.replaceState({}, '', 'index.html');
        }
    }

    // ══════════════════════════════════════════════
    // UPDATE STATS
    // ══════════════════════════════════════════════
    function fmt(v) { return '€' + Math.round(v || 0).toLocaleString('it-IT'); }

    function updateStats(s) {
        document.getElementById('statEquity').textContent = fmt(s.equity);
        document.getElementById('statEquityChange').textContent = s.equity > 0 ? 'Updated' : 'No data';
        document.getElementById('statEquityChange').className = 'stat-change' + (s.equity > 0 ? ' positive' : '');

        document.getElementById('statWinRate').textContent = (s.winRate || 0).toFixed(1) + '%';
        document.getElementById('statWinRateChange').textContent = s.winRate >= 50 ? 'Good performance' : 'Needs improvement';
        document.getElementById('statWinRateChange').className = 'stat-change' + (s.winRate >= 50 ? ' positive' : ' negative');

        document.getElementById('statPF').textContent = (s.profitFactor || 0).toFixed(2);
        const pfText = s.profitFactor >= 1.5 ? 'Excellent' : s.profitFactor >= 1 ? 'Decent' : 'At a loss';
        document.getElementById('statPFChange').textContent = pfText;
        document.getElementById('statPFChange').className = 'stat-change' + (s.profitFactor >= 1 ? ' positive' : ' negative');

        document.getElementById('statProfit').textContent = fmt(s.totalProfit);
        document.getElementById('statProfitChange').textContent = s.totalProfit >= 0 ? 'Profitable' : 'At a loss';
        document.getElementById('statProfitChange').className = 'stat-change' + (s.totalProfit >= 0 ? ' positive' : ' negative');
    }

    function updatePerf(s) {
        document.getElementById('perfTotal').textContent = s.totalTrades || 0;
        document.getElementById('perfWins').textContent = s.winningTrades || 0;
        document.getElementById('perfLosses').textContent = s.losingTrades || 0;
        document.getElementById('perfWR').textContent = (s.winRate || 0).toFixed(1) + '%';
        document.getElementById('perfPF').textContent = (s.profitFactor || 0).toFixed(2);
        document.getElementById('perfAvg').textContent = fmt(s.avgProfit);
        document.getElementById('perfBest').textContent = fmt(s.bestTrade);
        document.getElementById('perfWorst').textContent = fmt(s.worstTrade);
    }

    // ══════════════════════════════════════════════
    // CHARTS
    // ══════════════════════════════════════════════
    function drawEquityChart(history) {
        const ctx = document.getElementById('equityChart');
        if (charts.equity) charts.equity.destroy();
        charts.equity = new Chart(ctx, {
            type: 'line',
            data: {
                labels: history.map(h => new Date(h.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' })),
                datasets: [{
                    data: history.map(h => h.equity),
                    borderColor: '#c8aa6e',
                    backgroundColor: 'rgba(200,170,110,0.08)',
                    borderWidth: 2, tension: 0.4, fill: true,
                    pointRadius: 3, pointBackgroundColor: '#c8aa6e', pointBorderWidth: 0
                }]
            },
            options: chartDefaults
        });
    }

    function drawMonthlyChart(trades) {
        const ctx = document.getElementById('monthlyChart');
        const months = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
        const data = Array(12).fill(0);
        trades.forEach(t => {
            if (t.closed_at && t.profit) data[new Date(t.closed_at).getMonth()] += parseFloat(t.profit);
        });
        if (charts.monthly) charts.monthly.destroy();
        charts.monthly = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    data: data.map(d => parseFloat(d.toFixed(2))),
                    backgroundColor: data.map(d => d >= 0 ? 'rgba(92,184,122,0.7)' : 'rgba(224,82,82,0.7)'),
                    borderRadius: 4, barPercentage: 0.6
                }]
            },
            options: chartDefaults
        });
    }

    function drawAnalytics(trades, stats) {
        // Distribution
        const distCtx = document.getElementById('distributionChart');
        if (charts.dist) charts.dist.destroy();
        charts.dist = new Chart(distCtx, {
            type: 'doughnut',
            data: {
                labels: ['Winners', 'Losers'],
                datasets: [{ data: [stats?.winningTrades || 0, stats?.losingTrades || 0], backgroundColor: ['#5cb87a', '#e05252'], borderWidth: 0, spacing: 3 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                cutout: '70%',
                plugins: { legend: { position: 'bottom', labels: { color: '#9b978f', padding: 16, font: { size: 12 }, usePointStyle: true } } }
            }
        });

        // Hourly
        const hourCtx = document.getElementById('hourlyChart');
        const hourData = Array(12).fill(0);
        trades.forEach(t => { if (t.opened_at) hourData[Math.floor(new Date(t.opened_at).getHours() / 2)]++; });
        if (charts.hourly) charts.hourly.destroy();
        charts.hourly = new Chart(hourCtx, {
            type: 'bar',
            data: {
                labels: ['0h','2h','4h','6h','8h','10h','12h','14h','16h','18h','20h','22h'],
                datasets: [{ data: hourData, backgroundColor: 'rgba(200,170,110,0.5)', borderRadius: 4, barPercentage: 0.5 }]
            },
            options: chartDefaults
        });
    }

    function drawDrawdown(trades) {
        const ctx = document.getElementById('drawdownChart');
        const sorted = [...trades].filter(t => t.closed_at).sort((a, b) => new Date(a.closed_at) - new Date(b.closed_at));
        let cum = 0, peak = 0;
        const ddData = [], labels = [];
        sorted.forEach(t => {
            cum += parseFloat(t.profit) || 0;
            if (cum > peak) peak = cum;
            ddData.push(peak > 0 ? parseFloat(((cum - peak) / peak * 100).toFixed(2)) : 0);
            labels.push(new Date(t.closed_at).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }));
        });
        if (charts.dd) charts.dd.destroy();
        charts.dd = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels.length ? labels : ['N/D'],
                datasets: [{ data: ddData.length ? ddData : [0], borderColor: '#e05252', backgroundColor: 'rgba(224,82,82,0.08)', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0 }]
            },
            options: chartDefaults
        });
    }

    // ══════════════════════════════════════════════
    // CALCULATOR
    // ══════════════════════════════════════════════
    function calculatePosition() {
        const account = parseFloat(document.getElementById('calcAccount').value);
        const risk = parseFloat(document.getElementById('calcRisk').value);
        const entry = parseFloat(document.getElementById('calcEntry').value);
        const sl = parseFloat(document.getElementById('calcSL').value);
        if (!account || !risk || !entry || !sl || entry === sl) {
            toast('error', 'Error', 'Please fill in all fields correctly');
            return;
        }
        const riskAmt = account * (risk / 100);
        const pips = Math.abs(entry - sl) * 10000;
        const lots = (riskAmt / (pips * 10)).toFixed(2);

        document.getElementById('calcLots').textContent = lots + ' Lots';
        document.getElementById('calcRiskAmt').textContent = '€' + riskAmt.toFixed(2);
        document.getElementById('calcPips').textContent = pips.toFixed(1);
        document.getElementById('calcProfit').textContent = '€' + (riskAmt * 2).toFixed(2);
        document.getElementById('calcResult').classList.add('show');
        toast('success', 'Calculated', `Position size: ${lots} lots`);
    }

    // ══════════════════════════════════════════════
    // BROKER MODAL
    // ══════════════════════════════════════════════
    function openBrokerModal(name, platform) {
        selectedPlatform = platform || 'mt4';
        document.getElementById('modalTitle').textContent = 'Connect ' + name;
        document.getElementById('brokerModal').classList.add('active');
    }

    function closeBrokerModal() {
        document.getElementById('brokerModal').classList.remove('active');
        document.getElementById('modalAccount').value = '';
        document.getElementById('modalInvestorPwd').value = '';
        document.getElementById('modalBrokerName').value = '';
    }

    async function connectBroker() {
        const account = document.getElementById('modalAccount').value.trim();
        const investorPassword = document.getElementById('modalInvestorPwd').value;
        const brokerName = document.getElementById('modalBrokerName').value.trim();
        if (!account || !investorPassword || !brokerName) { toast('error', 'Error', 'Please fill in all fields'); return; }

        const btn = document.getElementById('connectBrokerBtn');
        btn.disabled = true; btn.textContent = 'Connecting...';

        const res = await apiCall('/api/broker/connect', {
            method: 'POST',
            body: JSON.stringify({ platform: selectedPlatform, accountNumber: account, investorPassword, brokerName })
        });
        
        if (res?.success) {
            toast('success', 'Connected!', res.message || 'Account connected successfully');
            closeBrokerModal();
            // Auto sync after connect
            syncBrokerData();
            updateBotStatus();
        } else {
            toast('error', 'Connection Failed', res?.error || 'Check your credentials and broker server name');
        }
        btn.disabled = false; btn.textContent = 'Connect Account';
    }

    async function syncBrokerData() {
        toast('info', 'Syncing', 'Fetching data from your broker...');
        const res = await apiCall('/api/broker/sync', { method: 'POST' });
        if (res?.success) {
            toast('success', 'Synced', `${res.synced} trades imported. Equity: €${(res.account?.equity || 0).toFixed(2)}`);
            // Reload dashboard data
            const stats = await apiCall('/api/stats');
            if (stats) { updateStats(stats); updatePerf(stats); updateRiskGuardian(stats); }
            const equity = await apiCall('/api/equity-history?days=30');
            if (equity?.history) drawEquityChart(equity.history);
        } else {
            toast('error', 'Sync Failed', res?.error || 'Could not sync data. Account may still be deploying, try again in 1 minute.');
        }
    }

    // Close modal on overlay click
    document.getElementById('brokerModal').addEventListener('click', function(e) {
        if (e.target === this) closeBrokerModal();
    });

    // ══════════════════════════════════════════════
    // COPY FUNCTIONS
    // ══════════════════════════════════════════════
    function copyReferral() {
        navigator.clipboard.writeText('TIER-XR4K9M').then(() => toast('success', 'Copied', 'Referral code copied!'));
    }

    // ══════════════════════════════════════════════
    // RISK GUARDIAN
    // ══════════════════════════════════════════════
    let riskSettings = JSON.parse(localStorage.getItem('riskSettings') || '{"capital":100000,"target":10,"dailyDD":5,"maxDD":10}');

    function saveRiskSettings() {
        riskSettings = {
            capital: parseFloat(document.getElementById('riskCapital').value) || 100000,
            target: parseFloat(document.getElementById('riskTarget').value) || 10,
            dailyDD: parseFloat(document.getElementById('riskDailyDD').value) || 5,
            maxDD: parseFloat(document.getElementById('riskMaxDD').value) || 10
        };
        localStorage.setItem('riskSettings', JSON.stringify(riskSettings));
        updateRiskGuardian();
        toast('success', 'Saved', 'Risk settings updated');
    }

    function updateRiskGuardian(stats) {
        const s = stats || {};
        const capital = riskSettings.capital;
        const targetAmt = capital * (riskSettings.target / 100);
        const totalProfit = s.totalProfit || 0;
        const equity = s.equity || 0;

        // Account Overview — show/hide based on broker connection
        apiCall('/api/broker/connections').then(data => {
            const active = data?.connections?.find(c => c.is_active);
            const noAccEl = document.getElementById('rgNoAccount');
            const accInfoEl = document.getElementById('rgAccountInfo');
            const accBadge = document.getElementById('rgAccountBadge');

            if (active) {
                noAccEl.style.display = 'none';
                accInfoEl.style.display = 'block';
                accBadge.textContent = 'CONNECTED';
                accBadge.className = 'dd-status-badge';

                // Use real equity from stats
                document.getElementById('rgBalance').textContent = fmt(capital);
                document.getElementById('rgEquity').textContent = equity > 0 ? fmt(equity) : fmt(capital + totalProfit);

                // Today P&L from today's trades
                const todayPL = s.todayProfit || 0;
                const todayEl = document.getElementById('rgTodayPL');
                todayEl.textContent = (todayPL >= 0 ? '+' : '') + fmt(todayPL);
                todayEl.className = 'perf-value ' + (todayPL >= 0 ? 'green' : 'red');

                document.getElementById('rgOpenTrades').textContent = s.openTrades || '0';
            } else {
                noAccEl.style.display = 'block';
                accInfoEl.style.display = 'none';
                accBadge.textContent = 'NO ACCOUNT';
                accBadge.className = 'dd-status-badge warning';
            }
        });

        // Challenge progress
        const progress = targetAmt > 0 ? Math.min((totalProfit / targetAmt) * 100, 100) : 0;
        document.getElementById('challengeTarget').textContent = fmt(Math.max(totalProfit, 0)) + ' / ' + fmt(targetAmt);
        document.getElementById('challengeProgress').style.width = Math.max(progress, 0) + '%';
        document.getElementById('challengePercent').textContent = Math.max(progress, 0).toFixed(1) + '% completed';
        document.getElementById('challengeProfit').textContent = fmt(totalProfit);
        document.getElementById('challengeWR').textContent = (s.winRate || 0) + '%';

        const statusEl = document.getElementById('challengeStatus');
        if (totalProfit >= targetAmt && targetAmt > 0) {
            statusEl.textContent = 'TARGET HIT!'; statusEl.className = 'perf-value gold';
        } else if (totalProfit >= 0) {
            statusEl.textContent = 'In Progress'; statusEl.className = 'perf-value green';
        } else {
            statusEl.textContent = 'Losing'; statusEl.className = 'perf-value red';
        }

        // Drawdown calculations using real trade data
        // Daily loss: sum of today's closed losing trades
        const todayLoss = Math.abs(Math.min(s.todayProfit || 0, 0));
        const dailyDDPercent = capital > 0 ? (todayLoss / capital * 100) : 0;

        // Max drawdown: peak to trough from total P&L
        const maxDDAmount = Math.abs(Math.min(totalProfit, 0));
        const maxDDPercent = capital > 0 ? (maxDDAmount / capital * 100) : 0;
        
        const dailyLimit = riskSettings.dailyDD;
        const maxLimit = riskSettings.maxDD;
        const dailyRatio = Math.min(dailyDDPercent / dailyLimit * 100, 100);
        const maxRatio = Math.min(maxDDPercent / maxLimit * 100, 100);

        document.getElementById('ddDailyValue').textContent = dailyDDPercent.toFixed(2) + '% / ' + dailyLimit + '%';
        document.getElementById('ddDailyBar').style.width = dailyRatio + '%';
        document.getElementById('ddDailyBar').className = 'dd-bar-fill ' + (dailyRatio > 80 ? 'dd-danger' : dailyRatio > 50 ? 'dd-warning' : 'dd-safe');

        document.getElementById('ddMaxValue').textContent = maxDDPercent.toFixed(2) + '% / ' + maxLimit + '%';
        document.getElementById('ddMaxBar').style.width = maxRatio + '%';
        document.getElementById('ddMaxBar').className = 'dd-bar-fill ' + (maxRatio > 80 ? 'dd-danger' : maxRatio > 50 ? 'dd-warning' : 'dd-safe');

        // Status badge
        const badge = document.getElementById('ddStatusBadge');
        if (dailyRatio > 80 || maxRatio > 80) {
            badge.textContent = 'DANGER'; badge.className = 'dd-status-badge danger';
        } else if (dailyRatio > 50 || maxRatio > 50) {
            badge.textContent = 'WARNING'; badge.className = 'dd-status-badge warning';
        } else {
            badge.textContent = 'SAFE'; badge.className = 'dd-status-badge';
        }

        // Fill in settings form
        document.getElementById('riskCapital').value = riskSettings.capital;
        document.getElementById('riskTarget').value = riskSettings.target;
        document.getElementById('riskDailyDD').value = riskSettings.dailyDD;
        document.getElementById('riskMaxDD').value = riskSettings.maxDD;
    }

    function toggleEquityProtector() {
        const on = document.getElementById('equityProtectorToggle').checked;
        document.getElementById('epSettings').style.display = on ? 'block' : 'none';
        if (on) toast('info', 'Equity Protector', 'Set your alert threshold');
    }

    function saveEquityProtector() {
        const limit = document.getElementById('epLimit').value;
        localStorage.setItem('equityProtectorLimit', limit);
        toast('success', 'Alert Set', 'You will be alerted if daily loss exceeds ' + limit + '%');
    }

    // ══════════════════════════════════════════════
    // BOT CONTROL
    // ══════════════════════════════════════════════
    function updateBotStatus() {
        apiCall('/api/broker/connections').then(data => {
            const active = data?.connections?.find(c => c.is_active);
            const pulse = document.getElementById('botPulse');
            const text = document.getElementById('botStatusText');
            
            // Update Experts section
            if (active) {
                pulse.className = 'bot-pulse online';
                text.textContent = 'Online';
                document.getElementById('botEAStatus').textContent = 'Active';
                document.getElementById('botEAStatus').className = 'perf-value green';
                document.getElementById('botConnection').textContent = active.platform.toUpperCase();
                document.getElementById('botConnection').className = 'perf-value green';
                document.getElementById('botLastBeat').textContent = 'Now';
            } else {
                pulse.className = 'bot-pulse offline';
                text.textContent = 'Not connected';
                document.getElementById('botEAStatus').textContent = 'Inactive';
                document.getElementById('botEAStatus').className = 'perf-value red';
                document.getElementById('botConnection').textContent = 'None';
                document.getElementById('botConnection').className = 'perf-value red';
                document.getElementById('botLastBeat').textContent = '—';
            }

            // Update Broker section
            const badge = document.getElementById('brokerConnBadge');
            const info = document.getElementById('connectedBrokerInfo');
            if (active) {
                badge.textContent = 'CONNECTED'; badge.className = 'dd-status-badge';
                info.style.display = 'block';
                document.getElementById('connAccNum').textContent = '#' + active.account_number;
                document.getElementById('connPlatform').textContent = active.platform.toUpperCase();
                document.getElementById('connBroker').textContent = active.broker_name || '—';
            } else {
                badge.textContent = 'NOT CONNECTED'; badge.className = 'dd-status-badge warning';
                info.style.display = 'none';
            }
        });
    }

    async function disconnectBroker() {
        if (!confirm('Disconnect your trading account?')) return;
        // Just deactivate in our DB
        await apiCall('/api/broker/disconnect', { method: 'POST' });
        toast('info', 'Disconnected', 'Broker account disconnected');
        updateBotStatus();
    }

    async function panicButton() {
        if (!confirm('⚠️ WARNING!\n\nThis will attempt to CLOSE ALL open trades.\n\nAre you sure?')) return;
        if (!confirm('Final confirmation: do you really want to close everything?')) return;
        
        toast('error', 'PANIC ACTIVATED', 'Sending close-all command to broker...');
        
        try {
            const res = await apiCall('/api/broker/close-all', { method: 'POST' });
            if (res?.success) {
                toast('success', 'Done', 'Close-all command sent. ' + (res.closed || 0) + ' trade(s) closing.');
            } else {
                toast('error', 'Error', res?.error || 'Failed to close trades. Check your broker connection.');
            }
        } catch (err) {
            toast('error', 'Error', 'Could not reach the server. Try closing trades directly in MetaTrader.');
        }
        
        // Update UI
        document.getElementById('botOpenTrades').textContent = '0';
        document.getElementById('rgOpenTrades').textContent = '0';
        updateBotStatus();
    }

    // ══════════════════════════════════════════════
    // PLAN GATING
    // ══════════════════════════════════════════════
    const planAccess = {
        free: ['overview', 'calculator', 'calendar', 'referral', 'refund', 'settings'],
        standard: ['overview', 'signals', 'riskguard', 'performance', 'analytics', 'brokers', 'calculator', 'indicators', 'calendar', 'referral', 'refund', 'settings'],
        pro: ['overview', 'signals', 'riskguard', 'experts', 'performance', 'analytics', 'brokers', 'calculator', 'indicators', 'calendar', 'referral', 'refund', 'settings']
    };

    let userPlan = 'free';

    function applyPlanGating(plan) {
        userPlan = plan || 'free';
        const allowed = planAccess[userPlan] || planAccess.free;
        
        document.querySelectorAll('.nav-link').forEach(link => {
            const section = link.dataset.section;
            if (!section) return;
            const locked = !allowed.includes(section);
            link.classList.toggle('nav-locked', locked);
            
            // Add lock icon
            let lockEl = link.querySelector('.lock-icon');
            if (locked && !lockEl) {
                lockEl = document.createElement('span');
                lockEl.className = 'lock-icon';
                lockEl.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>';
                link.appendChild(lockEl);
            } else if (!locked && lockEl) {
                lockEl.remove();
            }
        });

        // Update plan badge in settings
        const planEl = document.querySelector('#settingsPlan');
        if (planEl) planEl.textContent = userPlan.charAt(0).toUpperCase() + userPlan.slice(1);
    }

    function showUpgradeModal(requiredPlan) {
        const modal = document.getElementById('upgradeModal');
        if (modal) {
            document.getElementById('upgradePlanName').textContent = requiredPlan === 'pro' ? 'Pro' : 'Standard';
            document.getElementById('upgradePrice').textContent = requiredPlan === 'pro' ? '€89.99' : '€49.99';
            modal.classList.add('active');
        }
    }

    function closeUpgradeModal() {
        document.getElementById('upgradeModal')?.classList.remove('active');
    }

    async function upgradePlan(plan) {
        const priceIds = {
            standard: window.STRIPE_STANDARD_PRICE_ID || '',
            pro: window.STRIPE_PRO_PRICE_ID || ''
        };
        const priceId = priceIds[plan];
        if (!priceId) {
            // Fallback to Stripe payment links from the website
            const links = {
                standard: 'https://buy.stripe.com/4gM5kF3UVgRFapEci85kk0h',
                pro: 'https://buy.stripe.com/6oU8wR0IJcBpbtI81S5kk0i'
            };
            window.open(links[plan], '_blank');
            closeUpgradeModal();
            return;
        }
        
        const res = await apiCall('/api/stripe/checkout', {
            method: 'POST',
            body: JSON.stringify({ priceId })
        });
        if (res?.url) {
            window.location.href = res.url;
        } else {
            toast('error', 'Error', 'Failed to start checkout');
        }
    }

    async function manageSubscription() {
        const res = await apiCall('/api/stripe/portal', { method: 'POST' });
        if (res?.url) {
            window.location.href = res.url;
        } else {
            toast('info', 'Info', 'No active subscription found');
        }
    }

    // ══════════════════════════════════════════════
    // THEME TOGGLE
    // ══════════════════════════════════════════════
    function toggleTheme() {
        const isLight = document.body.classList.toggle('light');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        // Update icon
        document.getElementById('themeIcon').innerHTML = isLight
            ? '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>'
            : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
    }

    // Load saved theme
    if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light');
        document.getElementById('themeIcon').innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
    }

    // ══════════════════════════════════════════════
    // INDICATORS
    // ══════════════════════════════════════════════
    function applyIndicatorGating(plan) {
        const badge = document.getElementById('indicatorPlanBadge');
        if (plan === 'pro') {
            badge.textContent = 'PRO — 3 INDICATORS'; badge.className = 'dd-status-badge';
            badge.style.background = 'var(--gold-dim)'; badge.style.color = 'var(--gold)';
        } else if (plan === 'standard') {
            badge.textContent = 'STANDARD — 1 INDICATOR'; badge.className = 'dd-status-badge';
        } else {
            badge.textContent = 'UPGRADE REQUIRED'; badge.className = 'dd-status-badge warning';
        }

        document.querySelectorAll('.indicator-card').forEach(card => {
            const reqPlan = card.dataset.plan;
            const locked = (reqPlan === 'pro' && plan !== 'pro') || (reqPlan === 'standard' && plan === 'free');
            card.style.opacity = locked ? '0.4' : '1';
            card.style.pointerEvents = locked ? 'none' : 'auto';
            const btn = card.querySelector('.btn-download');
            if (btn && locked) btn.textContent = reqPlan === 'pro' ? 'Pro Only' : 'Upgrade';
        });
    }

    function toggleInvite(num) {
        const el = document.getElementById('invite' + num);
        const btn = document.getElementById('inviteBtn' + num);
        if (el.style.display === 'none') {
            el.style.display = 'block';
            btn.style.display = 'none';
        } else {
            el.style.display = 'none';
            btn.style.display = 'inline-block';
        }
    }

    function requestIndicatorAccess(num) {
        const username = document.getElementById('tvUser' + num).value.trim();
        if (!username) { toast('error', 'Error', 'Please enter your TradingView username'); return; }
        
        // Save to localStorage for now (in production could save to DB)
        const requests = JSON.parse(localStorage.getItem('indicatorRequests') || '{}');
        requests[num] = { username, date: new Date().toISOString(), status: 'pending' };
        localStorage.setItem('indicatorRequests', JSON.stringify(requests));
        
        toast('success', 'Request Sent', 'We will add ' + username + ' to the indicator within 24 hours.');
        document.getElementById('invite' + num).innerHTML = '<div style="padding:8px 0;color:var(--green);font-size:13px;font-weight:600;">✓ Access requested for @' + username + '</div>';
    }

    // ══════════════════════════════════════════════
    // REFUND
    // ══════════════════════════════════════════════
    async function submitRefund() {
        const reason = document.getElementById('refundReason').value;
        const details = document.getElementById('refundDetails').value;
        if (!reason) { toast('error', 'Error', 'Please select a reason'); return; }

        const btn = document.getElementById('refundBtn');
        btn.disabled = true; btn.textContent = 'Submitting...';

        const res = await apiCall('/api/refund/request', {
            method: 'POST',
            body: JSON.stringify({ reason, details })
        });

        if (res?.success) {
            toast('success', 'Submitted', 'Your refund request has been submitted');
            document.getElementById('refundReason').value = '';
            document.getElementById('refundDetails').value = '';
            loadRefundHistory();
        } else {
            toast('error', 'Error', res?.error || 'Failed to submit');
        }
        btn.disabled = false; btn.textContent = 'Submit Refund Request';
    }

    async function loadRefundHistory() {
        const res = await apiCall('/api/refund/status');
        const container = document.getElementById('refundHistory');
        if (!res?.requests?.length) {
            container.innerHTML = '<p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">No refund requests yet.</p>';
            return;
        }
        container.innerHTML = res.requests.map(r => {
            const statusColors = { pending: 'gold', approved: 'green', rejected: 'red' };
            const statusLabels = { pending: 'Pending Review', approved: 'Approved', rejected: 'Rejected' };
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);">
                <div>
                    <div style="font-size:14px;font-weight:500;">${r.reason.replace(/_/g, ' ')}</div>
                    <div style="font-size:12px;color:var(--text-3);">${new Date(r.created_at).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' })}</div>
                </div>
                <span class="dd-status-badge ${r.status === 'approved' ? '' : r.status === 'rejected' ? 'danger' : 'warning'}">${statusLabels[r.status] || r.status}</span>
            </div>`;
        }).join('');
    }

    // ══════════════════════════════════════════════
    // EA DOWNLOADS
    // ══════════════════════════════════════════════
    async function downloadEA(filename) {
        toast('info', 'Download', 'Preparing ' + filename + '...');
        try {
            const token = getToken();
            const res = await fetch('/ea-files/' + filename, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.status === 403) {
                toast('error', 'Access Denied', 'Active subscription required to download EA files.');
                return;
            }
            if (!res.ok) {
                toast('error', 'Error', 'Download failed. Please try again.');
                return;
            }
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
            toast('success', 'Download', filename + ' downloaded!');
        } catch (err) {
            toast('error', 'Error', 'Download failed.');
        }
    }

    // ══════════════════════════════════════════════
    // LICENSE KEY MANAGEMENT
    // ══════════════════════════════════════════════

    async function loadLicenseKeys() {
        const container = document.getElementById('licenseKeysContainer');
        if (!container) return;

        try {
            const res = await apiCall('/api/ea/license');
            if (!res || !res.licenses) {
                container.innerHTML = '<div style="text-align:center;padding:1.5rem 0;color:var(--text-3);">Click "Generate Keys" to get your license keys.</div>';
                return;
            }

            const licenses = res.licenses;
            if (licenses.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:1.5rem 0;color:var(--text-3);">No license keys yet. Click "Generate Keys" to activate your EAs.</div>';
                return;
            }

            let html = '';
            for (const lic of licenses) {
                const productName = lic.product === 'tier_algo_gold' ? 'Tier Algo Gold' 
                                  : lic.product === 'tier_algo_us100' ? 'Tier Algo US100' 
                                  : lic.product;
                const productIcon = lic.product === 'tier_algo_gold' ? '🥇' : '📈';
                const statusColor = lic.is_active ? 'var(--green)' : 'var(--red)';
                const statusText = lic.is_active ? 'Active' : 'Revoked';
                const lastVerified = lic.last_verified ? new Date(lic.last_verified).toLocaleString() : 'Never';
                const mtAccount = lic.mt_account || '—';

                html += `
                <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:0.75rem;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;flex-wrap:wrap;gap:0.5rem;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:20px;">${productIcon}</span>
                            <span style="font-weight:600;font-size:14px;">${productName}</span>
                        </div>
                        <span style="color:${statusColor};font-size:11px;text-transform:uppercase;letter-spacing:1px;font-weight:600;">${statusText}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:0.75rem;">
                        <code style="background:var(--surface-3);padding:10px 14px;border-radius:8px;font-family:'DM Mono',monospace;font-size:14px;letter-spacing:1.5px;color:var(--gold);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${lic.license_key}</code>
                        <button class="btn-small" onclick="copyLicenseKey('${lic.license_key}')" style="white-space:nowrap;">Copy</button>
                    </div>
                    <div style="display:flex;gap:1.5rem;flex-wrap:wrap;font-size:11px;color:var(--text-3);">
                        <span>MT Account: <strong style="color:var(--text-2);">${mtAccount}</strong></span>
                        <span>Verifications: <strong style="color:var(--text-2);">${lic.verification_count || 0}</strong></span>
                        <span>Last Check: <strong style="color:var(--text-2);">${lastVerified}</strong></span>
                    </div>
                </div>`;
            }

            container.innerHTML = html;

        } catch (err) {
            container.innerHTML = '<div style="text-align:center;padding:1.5rem 0;color:var(--red);">Error loading licenses</div>';
        }
    }

    async function generateLicenseKeys() {
        const btn = document.getElementById('btnGenLicense');
        btn.disabled = true;
        btn.textContent = 'Generating...';

        try {
            const res = await apiCall('/api/ea/license/generate', { method: 'POST' });
            if (res?.error) {
                toast('error', 'License Error', res.error);
            } else {
                toast('success', 'License Keys', res.message || 'Keys generated successfully!');
                await loadLicenseKeys();
            }
        } catch (err) {
            toast('error', 'Error', 'Failed to generate license keys');
        }

        btn.disabled = false;
        btn.textContent = 'Generate Keys';
    }

    function copyLicenseKey(key) {
        navigator.clipboard.writeText(key).then(() => {
            toast('success', 'Copied!', 'License key copied to clipboard');
        }).catch(() => {
            // Fallback
            const ta = document.createElement('textarea');
            ta.value = key;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            toast('success', 'Copied!', 'License key copied to clipboard');
        });
    }

    // ══════════════════════════════════════════════
    // INIT
    // ══════════════════════════════════════════════
    // ══════════════════════════════════════════════
    // SIGNALS
    // ══════════════════════════════════════════════
    let allSignals = [];
    let signalFilter = 'all';

    async function loadSignals() {
        const res = await apiCall('/api/signals');
        if (!res?.signals) return;
        allSignals = res.signals;
        updateSignalStats();
        renderSignals();
    }

    function updateSignalStats() {
        const total = allSignals.length;
        const active = allSignals.filter(s => s.status !== 'closed').length;
        const wins = allSignals.filter(s => s.result === 'TP' || s.result === 'WIN').length;
        const losses = allSignals.filter(s => s.result === 'SL' || s.result === 'LOSS').length;
        const closed = wins + losses;
        const wr = closed > 0 ? ((wins / closed) * 100).toFixed(0) : '0';

        document.getElementById('sigStatTotal').textContent = total;
        document.getElementById('sigStatActive').textContent = active;
        document.getElementById('sigStatWR').textContent = wr + '%';
        document.getElementById('sigStatRecord').textContent = wins + 'W — ' + losses + 'L';
    }

    function renderSignals() {
        const filtered = signalFilter === 'all' ? allSignals : allSignals.filter(s => signalFilter === 'active' ? s.status !== 'closed' : s.status === 'closed');
        const container = document.getElementById('signalsList');

        if (!filtered.length) {
            container.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-3);">No signals yet. Stay tuned!</div>';
            return;
        }

        container.innerHTML = filtered.map(s => {
            const dir = s.direction?.toLowerCase();
            const isClosed = s.status === 'closed';
            const ago = timeAgo(s.created_at);
            const src = s.source === 'ea' ? 'ea' : '';

            // Result badge with clear labels
            let resultBadge = '';
            if (s.result === 'TP' || s.result === 'WIN') {
                resultBadge = '<span class="signal-result win">TP HIT</span>';
            } else if (s.result === 'SL' || s.result === 'LOSS') {
                resultBadge = '<span class="signal-result loss">SL HIT</span>';
            } else if (s.result === 'BE') {
                resultBadge = '<span class="signal-result be">BREAK EVEN</span>';
            }
            
            let prices = '';
            if (s.entry_price) prices += `<div class="signal-price" onclick="copyPrice(this,'${s.entry_price}')"><span class="copy-hint">COPY</span><div class="signal-price-label">Entry</div><div class="signal-price-val entry">${s.entry_price}</div></div>`;
            if (s.stop_loss) prices += `<div class="signal-price" onclick="copyPrice(this,'${s.stop_loss}')"><span class="copy-hint">COPY</span><div class="signal-price-label">SL</div><div class="signal-price-val sl">${s.stop_loss}</div></div>`;
            if (s.tp1) prices += `<div class="signal-price" onclick="copyPrice(this,'${s.tp1}')"><span class="copy-hint">COPY</span><div class="signal-price-label">TP1</div><div class="signal-price-val tp">${s.tp1}</div></div>`;
            if (s.tp2) prices += `<div class="signal-price" onclick="copyPrice(this,'${s.tp2}')"><span class="copy-hint">COPY</span><div class="signal-price-label">TP2</div><div class="signal-price-val tp">${s.tp2}</div></div>`;
            if (s.tp3) prices += `<div class="signal-price" onclick="copyPrice(this,'${s.tp3}')"><span class="copy-hint">COPY</span><div class="signal-price-label">TP3</div><div class="signal-price-val tp">${s.tp3}</div></div>`;

            const closedInfo = s.closed_at ? `<div style="font-size:11px;color:var(--text-3);margin-top:6px;">Closed ${timeAgo(s.closed_at)}</div>` : '';

            return `<div class="signal-card ${dir} ${isClosed ? 'closed' : ''}">
                <div class="signal-header">
                    <span class="signal-dir ${dir}">${s.direction}</span>
                    <span class="signal-symbol">${s.symbol}</span>
                    <span class="signal-source ${src}">${s.source === 'ea' ? 'AI' : 'Team'}</span>
                    ${resultBadge}
                    <span class="signal-time">${ago}</span>
                </div>
                <div class="signal-prices">${prices}</div>
                ${s.notes ? `<div class="signal-notes">${s.notes}</div>` : ''}
                ${closedInfo}
            </div>`;
        }).join('');
    }

    function filterSignals(filter) {
        signalFilter = filter;
        document.querySelectorAll('[data-sigfilter]').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-sigfilter="${filter}"]`).classList.add('active');
        renderSignals();
    }

    function copyPrice(el, value) {
        navigator.clipboard.writeText(value).then(() => {
            el.classList.add('copied');
            toast('success', 'Copied', value + ' copied to clipboard');
            setTimeout(() => el.classList.remove('copied'), 800);
        }).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = value; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy');
            document.body.removeChild(ta);
            el.classList.add('copied');
            toast('success', 'Copied', value + ' copied');
            setTimeout(() => el.classList.remove('copied'), 800);
        });
    }

    function timeAgo(dateStr) {
        if (!dateStr) return '';
        const diff = Date.now() - new Date(dateStr).getTime();
        const mins = Math.floor(diff / 60000);
        if (mins < 1) return 'Just now';
        if (mins < 60) return mins + 'm ago';
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return hrs + 'h ago';
        const days = Math.floor(hrs / 24);
        if (days < 7) return days + 'd ago';
        return new Date(dateStr).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
    }

    // ══════════════════════════════════════════════
    // REFERRAL SYSTEM
    // ══════════════════════════════════════════════
    async function loadReferralData() {
        const res = await apiCall('/api/referral/info');
        if (!res) return;

        const baseUrl = window.location.origin;
        document.getElementById('refBalance').textContent = '€' + (res.balance || 0).toFixed(2);
        document.getElementById('refPayoutBalance').textContent = '€' + (res.balance || 0).toFixed(2);
        document.getElementById('refTotalEarned').textContent = '€' + (res.total_earned || 0).toFixed(2);
        document.getElementById('refTotalReferrals').textContent = res.total_referrals || 0;
        document.getElementById('refCodeDisplay').textContent = res.referral_code || '—';
        document.getElementById('refLinkInput').value = baseUrl + '/login.html?ref=' + (res.referral_code || '');
        if (res.usdt_wallet) document.getElementById('refWallet').value = res.usdt_wallet;

        document.getElementById('refBalanceNote').textContent = res.balance >= 50 ? 'Ready for payout!' : 'Min. €50 for payout';
        document.getElementById('refBalanceNote').className = 'stat-change' + (res.balance >= 50 ? ' positive' : '');

        // Commissions
        const commDiv = document.getElementById('refCommissions');
        if (!res.commissions?.length) {
            commDiv.innerHTML = '<p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">No commissions yet. Share your link to start earning!</p>';
        } else {
            commDiv.innerHTML = res.commissions.map(c => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
                    <div>
                        <div style="font-size:13px;font-weight:500;">${c.referred_email}</div>
                        <div style="font-size:11px;color:var(--text-3);">${c.plan_purchased?.toUpperCase()} · ${new Date(c.created_at).toLocaleDateString('en-US', {day:'numeric',month:'short'})}</div>
                    </div>
                    <div style="font-family:'DM Mono',monospace;font-size:14px;font-weight:600;color:var(--green);">+€${parseFloat(c.commission_amount).toFixed(2)}</div>
                </div>
            `).join('');
        }

        // Payouts
        const payDiv = document.getElementById('refPayouts');
        if (!res.payouts?.length) {
            payDiv.innerHTML = '<p style="color:var(--text-3);font-size:13px;text-align:center;padding:1rem;">No payouts yet.</p>';
        } else {
            payDiv.innerHTML = res.payouts.map(p => {
                const statusLabels = { pending: 'Pending', completed: 'Completed', rejected: 'Rejected' };
                return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);">
                    <div>
                        <div style="font-size:13px;font-weight:500;">€${parseFloat(p.amount).toFixed(2)} → USDT</div>
                        <div style="font-size:11px;color:var(--text-3);">${new Date(p.created_at).toLocaleDateString('en-US', {day:'numeric',month:'short',year:'numeric'})}</div>
                    </div>
                    <span class="dd-status-badge ${p.status === 'completed' ? '' : p.status === 'rejected' ? 'danger' : 'warning'}">${statusLabels[p.status] || p.status}</span>
                </div>`;
            }).join('');
        }
    }

    function copyRefLink() {
        const input = document.getElementById('refLinkInput');
        navigator.clipboard.writeText(input.value).then(() => toast('success', 'Copied!', 'Referral link copied to clipboard'));
    }

    function copyRefCode() {
        const code = document.getElementById('refCodeDisplay').textContent;
        navigator.clipboard.writeText(code).then(() => toast('success', 'Copied!', 'Referral code copied'));
    }

    async function saveRefWallet() {
        const wallet = document.getElementById('refWallet').value.trim();
        if (!wallet || wallet.length < 10) { toast('error', 'Error', 'Enter a valid USDT wallet address'); return; }
        const res = await apiCall('/api/referral/wallet', { method: 'POST', body: JSON.stringify({ wallet }) });
        if (res?.success) toast('success', 'Saved', 'USDT wallet saved');
        else toast('error', 'Error', res?.error || 'Failed to save');
    }

    async function requestRefPayout() {
        if (!confirm('Request payout of your full balance in USDT?')) return;
        const btn = document.getElementById('refPayoutBtn');
        btn.disabled = true; btn.textContent = 'Processing...';
        const res = await apiCall('/api/referral/payout', { method: 'POST' });
        if (res?.success) {
            toast('success', 'Payout Requested', res.message);
            loadReferralData();
        } else {
            toast('error', 'Error', res?.error || 'Failed to request payout');
        }
        btn.disabled = false; btn.textContent = 'Request Payout';
    }

    // ══════════════════════════════════════════════
    // ECONOMIC CALENDAR
    // ══════════════════════════════════════════════
    const countryFlags = {
        'USD': '🇺🇸', 'EUR': '🇪🇺', 'GBP': '🇬🇧', 'JPY': '🇯🇵', 'AUD': '🇦🇺',
        'CAD': '🇨🇦', 'CHF': '🇨🇭', 'NZD': '🇳🇿', 'CNY': '🇨🇳', 'INR': '🇮🇳',
        'BRL': '🇧🇷', 'KRW': '🇰🇷', 'MXN': '🇲🇽', 'SGD': '🇸🇬', 'HKD': '🇭🇰',
        'TRY': '🇹🇷', 'ZAR': '🇿🇦', 'SEK': '🇸🇪', 'NOK': '🇳🇴', 'DKK': '🇩🇰',
        'PLN': '🇵🇱', 'CZK': '🇨🇿', 'HUF': '🇭🇺', 'RUB': '🇷🇺', 'ALL': '🌐'
    };

    // Sample calendar data (in production, fetch from an API like forex factory)
    let calendarData = [];
    let calendarFilter = 'all';
    let calendarDayOffset = 0;

    function generateCalendarData(dayOffset) {
        const date = new Date();
        date.setDate(date.getDate() + dayOffset);
        const events = [
            { time: '08:30', currency: 'EUR', title: 'ECB Interest Rate Decision', impact: 'high', actual: '', forecast: '4.50%', previous: '4.50%' },
            { time: '09:00', currency: 'EUR', title: 'CPI (YoY)', impact: 'high', actual: '', forecast: '2.6%', previous: '2.8%' },
            { time: '10:00', currency: 'GBP', title: 'GDP (QoQ)', impact: 'high', actual: '', forecast: '0.3%', previous: '0.1%' },
            { time: '10:30', currency: 'CHF', title: 'SNB Monetary Policy Assessment', impact: 'high', actual: '', forecast: '', previous: '' },
            { time: '13:30', currency: 'USD', title: 'Core CPI (MoM)', impact: 'high', actual: '', forecast: '0.3%', previous: '0.4%' },
            { time: '13:30', currency: 'USD', title: 'Initial Jobless Claims', impact: 'medium', actual: '', forecast: '218K', previous: '211K' },
            { time: '13:30', currency: 'USD', title: 'CPI (YoY)', impact: 'high', actual: '', forecast: '2.9%', previous: '3.1%' },
            { time: '14:00', currency: 'CAD', title: 'BoC Rate Statement', impact: 'high', actual: '', forecast: '', previous: '' },
            { time: '15:00', currency: 'USD', title: 'Existing Home Sales', impact: 'medium', actual: '', forecast: '3.95M', previous: '4.15M' },
            { time: '15:30', currency: 'USD', title: 'Natural Gas Storage', impact: 'low', actual: '', forecast: '-85B', previous: '-116B' },
            { time: '16:00', currency: 'USD', title: 'Crude Oil Inventories', impact: 'medium', actual: '', forecast: '-1.8M', previous: '-0.2M' },
            { time: '19:00', currency: 'USD', title: '10-Year Bond Auction', impact: 'low', actual: '', forecast: '', previous: '4.68%' },
            { time: '21:00', currency: 'NZD', title: 'RBNZ Interest Rate Decision', impact: 'high', actual: '', forecast: '4.25%', previous: '4.75%' },
            { time: '23:50', currency: 'JPY', title: 'Tankan Manufacturing Index', impact: 'medium', actual: '', forecast: '14', previous: '13' },
        ];
        // Shuffle slightly based on day to vary data
        const shift = dayOffset * 3;
        return events.slice(shift % 4).concat(events.slice(0, shift % 4));
    }

    function renderCalendar() {
        const events = generateCalendarData(calendarDayOffset);
        const filtered = calendarFilter === 'all' ? events : events.filter(e => e.impact === calendarFilter);
        const container = document.getElementById('calendarContent');

        if (filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-3);">No events match this filter.</div>';
            return;
        }

        container.innerHTML = filtered.map(e => `
            <div class="cal-event" data-impact="${e.impact}">
                <div class="cal-event-top">
                    <div class="cal-time">${e.time}</div>
                    <div class="cal-flag">${countryFlags[e.currency] || '🌐'}</div>
                    <div class="cal-impact ${e.impact}"></div>
                    <div class="cal-title">${e.title}</div>
                    <div class="cal-currency">${e.currency}</div>
                </div>
                <div class="cal-values-row">
                    <div class="cal-val">
                        <div class="cal-val-label">Actual</div>
                        <div class="cal-val-num">${e.actual || '—'}</div>
                    </div>
                    <div class="cal-val">
                        <div class="cal-val-label">Forecast</div>
                        <div class="cal-val-num">${e.forecast || '—'}</div>
                    </div>
                    <div class="cal-val">
                        <div class="cal-val-label">Previous</div>
                        <div class="cal-val-num">${e.previous || '—'}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function filterCalendar(impact) {
        calendarFilter = impact;
        document.querySelectorAll('.cal-filter').forEach(b => b.classList.remove('active'));
        document.querySelector(`.cal-filter[data-impact="${impact}"]`).classList.add('active');
        renderCalendar();
    }

    function loadCalendarDay(offset) {
        calendarDayOffset = offset;
        document.querySelectorAll('.cal-day-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.cal-day-tab')[offset].classList.add('active');
        renderCalendar();
    }

    // Set day tab labels
    (function initCalendarTabs() {
        const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        for (let i = 2; i <= 4; i++) {
            const d = new Date();
            d.setDate(d.getDate() + i);
            const el = document.getElementById('calDay' + i);
            if (el) el.textContent = days[d.getDay()] + ' ' + d.getDate();
        }
        renderCalendar();
    })();

    // ══════════════════════════════════════════════
    // AUTO SYNC (every 60 seconds)
    // ══════════════════════════════════════════════
    async function autoSync() {
        const res = await apiCall('/api/broker/sync', { method: 'POST' });
        if (res?.success && res?.account) {
            // Update equity stat
            document.getElementById('statEquity').textContent = fmt(res.account.equity);
            document.getElementById('statProfit').textContent = fmt(res.account.profit);
            // Reload full stats
            const stats = await apiCall('/api/stats');
            if (stats) { updateStats(stats); updatePerf(stats); updateRiskGuardian(stats); }
            const equity = await apiCall('/api/equity-history?days=30');
            if (equity?.history) drawEquityChart(equity.history);
        }
    }

    window.addEventListener('load', () => {
        loadDashboard();
        // Start auto-sync every 60 seconds
        setInterval(autoSync, 60000);
        // Refresh signals every 60 seconds
        setInterval(loadSignals, 60000);
    });
</script>
    <!-- Upgrade Modal -->
    <div class="modal-overlay" id="upgradeModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Upgrade Required</div>
                <button class="modal-close" onclick="closeUpgradeModal()">&times;</button>
            </div>
            <div style="text-align:center;padding:1rem 0;">
                <div style="width:60px;height:60px;background:var(--gold-dim);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;margin-bottom:1rem;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                </div>
                <p style="font-size:15px;margin-bottom:0.5rem;">This feature requires a <strong id="upgradePlanName">Standard</strong> plan.</p>
                <p style="font-size:24px;font-weight:700;color:var(--gold);margin-bottom:1.5rem;" id="upgradePrice">€49.99<span style="font-size:14px;color:var(--text-3);font-weight:400;">/month</span></p>
                <button class="btn-primary" onclick="upgradePlan('standard')" id="upgradeStdBtn" style="width:100%;margin-bottom:0.5rem;">Upgrade to Standard — €49.99/mo</button>
                <button class="btn-primary" onclick="upgradePlan('pro')" style="width:100%;background:linear-gradient(135deg, #2a6b4a, #3a8a5c);">Upgrade to Pro — €89.99/mo</button>
                <p style="font-size:11px;color:var(--text-3);margin-top:1rem;">7-day money-back guarantee · Cancel anytime</p>
            </div>
